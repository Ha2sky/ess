<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>근태 신청</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-gray-100 p-6">

<div class="max-w-full mx-auto bg-white rounded shadow">
  <!-- 헤더 -->
    <div class="bg-blue-600 text-white p-4 rounded-t">
        <h1 class="text-2xl font-bold">근태 신청</h1>
        <p>현재 사용자:
            <span th:text="${currentEmp?.empName} ?: '정보없음'"></span> <!-- Safe Navigation 연산자 추가 -->
            (<span th:text="${currentEmp?.empCode} ?: 'N/A'"></span>)
        </p>
    </div>

  <!-- 탭 메뉴 -->
  <div class="border-b border-gray-200">
    <nav class="flex space-x-8">
      <button id="generalTab" class="tab-button active bg-blue-500 text-white px-4 py-2 rounded-t">
        일반근태 신청
      </button>
      <button id="etcTab" class="tab-button bg-gray-300 text-gray-700 px-4 py-2 rounded-t">
        기타근태 신청
      </button>
      <button id="historyTab" class="tab-button bg-gray-300 text-gray-700 px-4 py-2 rounded-t">
        신청 내역
      </button>
    </nav>
  </div>

  <!-- 일반근태 신청 탭 -->
  <div id="generalPanel" class="tab-panel p-6">
    <h2 class="text-xl font-semibold mb-4">일반근태 신청 (연장, 휴일근로, 조퇴/외출/반차)</h2>

    <!-- 검색 조건 -->
    <div class="bg-gray-50 p-4 rounded mb-6">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">근태신청종류</label>
          <select id="generalApplyType" class="mt-1 block w-full border border-gray-300 rounded p-2">
            <option value="연장">연장근로</option>
            <option value="휴일">휴일근로</option>
            <option value="조퇴외출반차">조퇴/외출/반차</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">근무일</label>
          <input type="date" id="generalWorkDate" class="mt-1 block w-full border border-gray-300 rounded p-2"
                 th:value="${today}">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">부서</label>
          <input type="text" id="generalDeptCode" class="mt-1 block w-full border border-gray-300 rounded p-2"
                 th:value="${currentEmp.deptCode}" readonly>
        </div>
        <div class="flex items-end">
          <button id="searchGeneralBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
            조회
          </button>
        </div>
      </div>
    </div>

    <!-- 사원 목록 테이블 -->
    <div class="overflow-x-auto mb-6">
      <table id="generalEmployeeTable" class="min-w-full border-collapse border border-gray-300">
        <thead class="bg-gray-100">
        <tr>
          <th class="border border-gray-300 px-4 py-2">선택</th>
          <th class="border border-gray-300 px-4 py-2">사번</th>
          <th class="border border-gray-300 px-4 py-2">이름</th>
          <th class="border border-gray-300 px-4 py-2">직위</th>
          <th class="border border-gray-300 px-4 py-2">부서</th>
          <th class="border border-gray-300 px-4 py-2">근무계획</th>
          <th class="border border-gray-300 px-4 py-2">신청근무</th>
          <th class="border border-gray-300 px-4 py-2">시작시간</th>
          <th class="border border-gray-300 px-4 py-2">종료시간</th>
          <th class="border border-gray-300 px-4 py-2">사유</th>
          <th class="border border-gray-300 px-4 py-2">상태</th>
        </tr>
        </thead>
        <tbody>
        <!-- 동적으로 생성 -->
        </tbody>
      </table>
    </div>

    <!-- 버튼 영역 -->
    <div class="flex space-x-2">
      <button id="saveGeneralBtn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
        저장
      </button>
      <button id="deleteGeneralBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
        삭제
      </button>
      <button id="submitGeneralBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
        상신
      </button>
    </div>
  </div>

  <!-- 기타근태 신청 탭 -->
  <div id="etcPanel" class="tab-panel p-6 hidden">
    <h2 class="text-xl font-semibold mb-4">기타근태 신청 (근태 변경)</h2>

    <!-- 검색 조건 -->
    <div class="bg-gray-50 p-4 rounded mb-6">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">근무일</label>
          <input type="date" id="etcWorkDate" class="mt-1 block w-full border border-gray-300 rounded p-2"
                 th:value="${today}">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">근무계획</label>
          <select id="etcWorkPlan" class="mt-1 block w-full border border-gray-300 rounded p-2">
            <option value="">전체</option>
            <option value="정상근무">정상근무</option>
            <option value="휴일">휴일</option>
            <option value="휴무">휴무</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">부서</label>
          <input type="text" id="etcDeptCode" class="mt-1 block w-full border border-gray-300 rounded p-2"
                 th:value="${currentEmp.deptCode}" readonly>
        </div>
        <div class="flex items-end">
          <button id="searchEtcBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
            조회
          </button>
        </div>
      </div>
    </div>

    <!-- 사원 목록 테이블 -->
    <div class="overflow-x-auto mb-6">
      <table id="etcEmployeeTable" class="min-w-full border-collapse border border-gray-300">
        <thead class="bg-gray-100">
        <tr>
          <th class="border border-gray-300 px-4 py-2">선택</th>
          <th class="border border-gray-300 px-4 py-2">사번</th>
          <th class="border border-gray-300 px-4 py-2">이름</th>
          <th class="border border-gray-300 px-4 py-2">직위</th>
          <th class="border border-gray-300 px-4 py-2">부서</th>
          <th class="border border-gray-300 px-4 py-2">기존근무계획</th>
          <th class="border border-gray-300 px-4 py-2">변경근무</th>
          <th class="border border-gray-300 px-4 py-2">시작일</th>
          <th class="border border-gray-300 px-4 py-2">종료일</th>
          <th class="border border-gray-300 px-4 py-2">신청시각</th>
          <th class="border border-gray-300 px-4 py-2">사유</th>
          <th class="border border-gray-300 px-4 py-2">상태</th>
        </tr>
        </thead>
        <tbody>
        <!-- 동적으로 생성 -->
        </tbody>
      </table>
    </div>

    <!-- 버튼 영역 -->
    <div class="flex space-x-2">
      <button id="saveEtcBtn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
        저장
      </button>
      <button id="deleteEtcBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
        삭제
      </button>
      <button id="submitEtcBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
        상신
      </button>
    </div>
  </div>

  <!-- 신청 내역 탭 -->
  <div id="historyPanel" class="tab-panel p-6 hidden">
    <h2 class="text-xl font-semibold mb-4">신청 내역</h2>

    <!-- 일반근태 신청 내역 -->
    <h3 class="text-lg font-medium mb-2">일반근태 신청 내역</h3>
    <div class="overflow-x-auto mb-6">
      <table class="min-w-full border-collapse border border-gray-300">
        <thead class="bg-gray-100">
        <tr>
          <th class="border border-gray-300 px-4 py-2">신청번호</th>
          <th class="border border-gray-300 px-4 py-2">대상자</th>
          <th class="border border-gray-300 px-4 py-2">신청일</th>
          <th class="border border-gray-300 px-4 py-2">대상일</th>
          <th class="border border-gray-300 px-4 py-2">신청유형</th>
          <th class="border border-gray-300 px-4 py-2">상태</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="apply : ${generalApplies}">
          <td class="border border-gray-300 px-4 py-2" th:text="${apply.applyGeneralNo}"></td>
          <td class="border border-gray-300 px-4 py-2" th:text="${apply.empName}"></td>
          <td class="border border-gray-300 px-4 py-2" th:text="${apply.applyDate}"></td>
          <td class="border border-gray-300 px-4 py-2" th:text="${apply.targetDate}"></td>
          <td class="border border-gray-300 px-4 py-2" th:text="${apply.applyType}"></td>
          <td class="border border-gray-300 px-4 py-2" th:text="${apply.status}"></td>
        </tr>
        </tbody>
      </table>
    </div>

    <!-- 기타근태 신청 내역 -->
    <h3 class="text-lg font-medium mb-2">기타근태 신청 내역</h3>
    <div class="overflow-x-auto">
      <table class="min-w-full border-collapse border border-gray-300">
        <thead class="bg-gray-100">
        <tr>
          <th class="border border-gray-300 px-4 py-2">신청번호</th>
          <th class="border border-gray-300 px-4 py-2">대상자</th>
          <th class="border border-gray-300 px-4 py-2">신청일</th>
          <th class="border border-gray-300 px-4 py-2">시작일</th>
          <th class="border border-gray-300 px-4 py-2">종료일</th>
          <th class="border border-gray-300 px-4 py-2">상태</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="apply : ${etcApplies}">
          <td class="border border-gray-300 px-4 py-2" th:text="${apply.applyEtcNo}"></td>
          <td class="border border-gray-300 px-4 py-2" th:text="${apply.empName}"></td>
          <td class="border border-gray-300 px-4 py-2" th:text="${apply.applyDate}"></td>
          <td class="border border-gray-300 px-4 py-2" th:text="${apply.targetStartDate}"></td>
          <td class="border border-gray-300 px-4 py-2" th:text="${apply.targetEndDate}"></td>
          <td class="border border-gray-300 px-4 py-2" th:text="${apply.status}"></td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  $(document).ready(function() {
      // 탭 전환 기능
      $('.tab-button').click(function() {
          $('.tab-button').removeClass('active bg-blue-500 text-white').addClass('bg-gray-300 text-gray-700');
          $(this).removeClass('bg-gray-300 text-gray-700').addClass('active bg-blue-500 text-white');

          $('.tab-panel').addClass('hidden');

          if ($(this).attr('id') === 'generalTab') {
              $('#generalPanel').removeClass('hidden');
          } else if ($(this).attr('id') === 'etcTab') {
              $('#etcPanel').removeClass('hidden');
          } else {
              $('#historyPanel').removeClass('hidden');
          }
      });

      // 일반근태 사원 조회
      $('#searchGeneralBtn').click(function() {
          const deptCode = $('#generalDeptCode').val();
          const workDate = $('#generalWorkDate').val().replace(/-/g, '');

          $.ajax({
              url: '/user/apply/employees',
              method: 'GET',
              data: { deptCode: deptCode, workDate: workDate },
              success: function(employees) {
                  const tbody = $('#generalEmployeeTable tbody');
                  tbody.empty();

                  employees.forEach(function(emp) {
                      const row = `
                          <tr>
                              <td class="border border-gray-300 px-4 py-2">
                                  <input type="radio" name="selectedEmp" value="${emp.empCode}">
                              </td>
                              <td class="border border-gray-300 px-4 py-2">${emp.empCode}</td>
                              <td class="border border-gray-300 px-4 py-2">${emp.empName}</td>
                              <td class="border border-gray-300 px-4 py-2">${emp.positionName || ''}</td>
                              <td class="border border-gray-300 px-4 py-2">${emp.deptCode}</td>
                              <td class="border border-gray-300 px-4 py-2">${emp.workPlan || ''}</td>
                              <td class="border border-gray-300 px-4 py-2">
                                  <select class="apply-type border rounded p-1">
                                      <option value="">선택</option>
                                      <option value="연장">연장</option>
                                      <option value="조출연장">조출연장</option>
                                      <option value="휴일근로">휴일근로</option>
                                      <option value="조퇴">조퇴</option>
                                      <option value="외출">외출</option>
                                      <option value="전반차">전반차</option>
                                      <option value="후반차">후반차</option>
                                  </select>
                              </td>
                              <td class="border border-gray-300 px-4 py-2">
                                  <input type="time" class="start-time border rounded p-1">
                              </td>
                              <td class="border border-gray-300 px-4 py-2">
                                  <input type="time" class="end-time border rounded p-1">
                              </td>
                              <td class="border border-gray-300 px-4 py-2">
                                  <input type="text" class="reason border rounded p-1" placeholder="사유">
                              </td>
                              <td class="border border-gray-300 px-4 py-2">대기</td>
                          </tr>
                      `;
                      tbody.append(row);
                  });
              },
              error: function() {
                  alert('사원 조회에 실패했습니다.');
              }
          });
      });

      // 일반근태 저장
      $('#saveGeneralBtn').click(function() {
          const selectedRow = $('input[name="selectedEmp"]:checked').closest('tr');
          if (selectedRow.length === 0) {
              alert('선택된 행이 없습니다.');
              return;
          }

          const applyData = {
              empCode: selectedRow.find('input[name="selectedEmp"]').val(),
              timeItemCode: '01', // 기본값
              targetDate: $('#generalWorkDate').val().replace(/-/g, ''),
              startTime: selectedRow.find('.start-time').val().replace(':', ''),
              endTime: selectedRow.find('.end-time').val().replace(':', ''),
              applyType: selectedRow.find('.apply-type').val(),
              deptCode: $('#generalDeptCode').val()
          };

          if (!applyData.applyType) {
              alert('신청근무를 선택해주세요.');
              return;
          }

          $.ajax({
              url: '/user/apply/general',
              method: 'POST',
              contentType: 'application/json',
              data: JSON.stringify(applyData),
              success: function(result) {
                  if (result === 'success') {
                      alert('저장되었습니다.');
                      location.reload();
                  } else {
                      alert(result);
                  }
              },
              error: function() {
                  alert('저장에 실패했습니다.');
              }
          });
      });

      // 상신 처리
      $('#submitGeneralBtn').click(function() {
        const selectedRow = $('input[name="selectedEmp"]:checked').closest('tr');
        if (!selectedRow.length) return alert('선택된 항목이 없습니다');

        const applyNo = selectedRow.data('apply-no');
        const applyType = 'general';

        if (confirm('정말 상신하시겠습니까?')) {
            $.ajax({
                url: '/user/apply/submit',
                method: 'POST',
                data: {
                    applyNo: applyNo,
                    applyType: applyType
                },
                success: function(res) {
                    if (res === 'success') {
                        location.reload();
                    } else {
                        alert('상신 실패: ' + res);
                    }
                }
            });
        }
      });

      // 기타근태 사원 조회
    $('#searchEtcBtn').click(function() {
        const deptCode = $('#etcDeptCode').val();
        const workDate = $('#etcWorkDate').val().replace(/-/g, '');

        $.ajax({
            url: '/user/apply/employees',
            method: 'GET',
            data: {
                deptCode: deptCode,
                workDate: workDate,
                workPlan: $('#etcWorkPlan').val()
            },
            success: function(employees) {
                const tbody = $('#etcEmployeeTable tbody');
                tbody.empty();

                employees.forEach(function(emp) {
                    const row = `
                        <tr data-apply-no="${emp.applyEtcNo || ''}">
                            <td class="border px-4 py-2">
                                <input type="radio" name="selectedEtcEmp" value="${emp.empCode}">
                            </td>
                            <!-- 나머지 테이블 컬럼 -->
                        </tr>
                    `;
                    tbody.append(row);
                });
            }
        });
    });

    // 기타근태 저장
    $('#saveEtcBtn').click(function() {
        const selectedRow = $('input[name="selectedEtcEmp"]:checked').closest('tr');
        const applyData = {
            empCode: selectedRow.find('input').val(),
            shiftCode: selectedRow.find('.etc-shift').val(),
            targetStartDate: selectedRow.find('.start-date').val().replace(/-/g, ''),
            targetEndDate: selectedRow.find('.end-date').val().replace(/-/g, ''),
            reason: selectedRow.find('.reason').val()
        };

        $.ajax({
            url: '/user/apply/etc',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(applyData),
            success: function(result) {
                if (result === 'success') location.reload();
            }
        });
    });

    // 기타근태 상신
    $('#submitEtcBtn').click(function() {
        const applyNo = $('input[name="selectedEtcEmp"]:checked').closest('tr').data('apply-no');
        if (!applyNo) return alert('선택된 신청건이 없습니다');

        if (confirm('기타근태를 상신하시겠습니까?')) {
            $.ajax({
                url: '/user/apply/submit',
                method: 'POST',
                data: {
                    applyNo: applyNo,
                    applyType: 'etc'
                },
                success: function(res) {
                    if (res === 'success') location.reload();
                }
            });
        }
    });
  });
</script>

</body>
</html>
