<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>근태 신청</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-gray-100 p-6">

<div class="max-w-full mx-auto bg-white rounded shadow">
  <!-- 헤더 -->
  <div class="bg-blue-600 text-white p-4 rounded-t">
    <h1 class="text-2xl font-bold">근태 신청</h1>
    <p>현재 사용자:
      <span th:text="${currentEmp?.empName} ?: '정보없음'"></span>
      (<span th:text="${currentEmp?.empCode} ?: 'N/A'"></span>)
      <!-- 부서장 여부 표시 -->
      <span th:if="${currentEmp?.isHeader == 'Y'}" class="bg-yellow-500 text-black px-2 py-1 rounded text-sm ml-2">부서장</span>
    </p>
  </div>

  <!-- 탭 메뉴 -->
  <div class="border-b border-gray-200">
    <nav class="flex space-x-8">
      <button id="generalTab" class="tab-button active bg-blue-500 text-white px-4 py-2 rounded-t">
        일반근태 신청
      </button>
      <button id="etcTab" class="tab-button bg-gray-300 text-gray-700 px-4 py-2 rounded-t">
        기타근태 신청
      </button>
    </nav>
  </div>

  <!-- 일반근태 신청 탭 -->
  <div id="generalPanel" class="tab-panel p-6">
    <h2 class="text-xl font-semibold mb-4">일반근태 신청 (연장, 휴일근로, 조퇴/외출/반차)</h2>

    <!-- 검색 조건 -->
    <div class="bg-gray-50 p-4 rounded mb-6">
      <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">근태신청종류</label>
          <select id="generalApplyType" class="mt-1 block w-full border border-gray-300 rounded p-2">
            <option value="연장근로">연장근로</option>
            <option value="휴일근로">휴일근로</option>
            <option value="조퇴외출반차">조퇴/외출/반차</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">근무일</label>
          <input type="date" id="generalWorkDate" class="mt-1 block w-full border border-gray-300 rounded p-2"
                 th:value="${today}">
        </div>
        <!-- 부서 드롭다운 -->
        <div>
          <label class="block text-sm font-medium text-gray-700">부서</label>
          <select id="generalDeptSelect" class="mt-1 block w-full border border-gray-300 rounded p-2">
            <option th:value="${currentEmp.deptCode}" th:text="${currentEmp.deptName}" selected></option>
            <!-- 부서장인 경우 하위부서 옵션 동적 로드 -->
            <option th:each="dept : ${availableDepartments}"
                    th:if="${dept.deptCode != currentEmp.deptCode}"
                    th:value="${dept.deptCode}"
                    th:text="${dept.deptName}"></option>
          </select>
        </div>
        <div class="flex items-end space-x-2 col-span-3">
          <button id="searchGeneralBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
            조회
          </button>
          <button id="saveGeneralBtn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
            저장
          </button>
          <button id="deleteGeneralBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
            삭제
          </button>
          <button id="submitGeneralBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
            상신
          </button>
          <button id="cancelGeneralBtn" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
            상신취소
          </button>
        </div>
      </div>
    </div>

    <!-- 사원 목록 테이블 -->
    <div class="overflow-x-auto mb-6">
      <table id="generalEmployeeTable" class="min-w-full border-collapse border border-gray-300">
        <thead class="bg-gray-100">
        <tr>
          <th class="border border-gray-300 px-4 py-2">선택</th>
          <th class="border border-gray-300 px-4 py-2">사번</th>
          <th class="border border-gray-300 px-4 py-2">성명</th>
          <th class="border border-gray-300 px-4 py-2">직위</th>
          <th class="border border-gray-300 px-4 py-2">부서</th>
          <th class="border border-gray-300 px-4 py-2">계획</th>
          <th class="border border-gray-300 px-4 py-2">실적</th>
          <th class="border border-gray-300 px-4 py-2">신청근무</th>
          <th class="border border-gray-300 px-4 py-2">시작시간</th>
          <th class="border border-gray-300 px-4 py-2">종료시간</th>
          <th class="border border-gray-300 px-4 py-2">예상근로시간</th>
          <th class="border border-gray-300 px-4 py-2">상태</th>
          <th class="border border-gray-300 px-4 py-2">상신자</th>
        </tr>
        </thead>
        <tbody id="generalEmployeeBody">
        <!-- 동적으로 로드될 사원 목록 -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- 기타근태 신청 탭 -->
  <div id="etcPanel" class="tab-panel p-6 hidden">
    <h2 class="text-xl font-semibold mb-4">기타근태 신청 (근태 변경)</h2>

    <!-- 검색 조건 -->
    <div class="bg-gray-50 p-4 rounded mb-6">
      <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">근무일</label>
          <input type="date" id="etcWorkDate" class="mt-1 block w-full border border-gray-300 rounded p-2"
                 th:value="${today}">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">근무계획</label>
          <select id="etcWorkPlan" class="mt-1 block w-full border border-gray-300 rounded p-2">
            <option value="">전체</option>
            <option value="주간">주간</option>
            <option value="휴일">휴일</option>
            <option value="휴무일">휴무일</option>
          </select>
        </div>
        <!-- 부서 드롭다운 -->
        <div>
          <label class="block text-sm font-medium text-gray-700">부서</label>
          <select id="etcDeptSelect" class="mt-1 block w-full border border-gray-300 rounded p-2">
            <option th:value="${currentEmp.deptCode}" th:text="${currentEmp.deptName}" selected></option>
            <!-- 부서장인 경우 하위부서 옵션 동적 로드 -->
            <option th:each="dept : ${availableDepartments}"
                    th:if="${dept.deptCode != currentEmp.deptCode}"
                    th:value="${dept.deptCode}"
                    th:text="${dept.deptName}"></option>
          </select>
        </div>
        <div class="flex items-end space-x-2 col-span-3">
          <button id="searchEtcBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
            조회
          </button>
          <button id="saveEtcBtn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
            저장
          </button>
          <button id="deleteEtcBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
            삭제
          </button>
          <button id="submitEtcBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
            상신
          </button>
          <button id="cancelEtcBtn" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
            상신취소
          </button>
        </div>
      </div>
    </div>

    <!-- 사원 목록 테이블 -->
    <div class="overflow-x-auto mb-6">
      <table id="etcEmployeeTable" class="min-w-full border-collapse border border-gray-300">
        <thead class="bg-gray-100">
        <tr>
          <th class="border border-gray-300 px-4 py-2">선택</th>
          <th class="border border-gray-300 px-4 py-2">사번</th>
          <th class="border border-gray-300 px-4 py-2">성명</th>
          <th class="border border-gray-300 px-4 py-2">직위</th>
          <th class="border border-gray-300 px-4 py-2">부서</th>
          <th class="border border-gray-300 px-4 py-2">계획</th>
          <th class="border border-gray-300 px-4 py-2">실적</th>
          <th class="border border-gray-300 px-4 py-2">변경근무</th>
          <th class="border border-gray-300 px-4 py-2">시작일</th>
          <th class="border border-gray-300 px-4 py-2">종료일</th>
          <th class="border border-gray-300 px-4 py-2">연차잔여</th>
          <th class="border border-gray-300 px-4 py-2">신청시각</th>
          <th class="border border-gray-300 px-4 py-2">상태</th>
          <th class="border border-gray-300 px-4 py-2">상신자</th>
        </tr>
        </thead>
        <tbody id="etcEmployeeBody">
        <!-- 동적으로 로드될 사원 목록 -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  $(document).ready(function() {
      // 전역 변수에 현재 사용자 정보 저장
      const currentUser = {
          empCode: '[[${currentEmp.empCode}]]',
          empName: '[[${currentEmp.empName}]]',
          isHeader: '[[${currentEmp.isHeader}]]',
          deptCode: '[[${currentEmp.deptCode}]]'
      };

      // 연차잔여 정보 저장
      const currentAnnual = {
          balanceDay: '[[${annualDetail?.balanceDay} ?: 0]]'
      };

      let shiftMasters = [];

      // 신청근무 옵션 정의
      const workTypeOptions = {
          '연장근로': [
              { value: '조출연장', text: '조출연장' },
              { value: '연장', text: '연장' }
          ],
          '휴일근로': [
              { value: '휴일근무', text: '휴일근무' }
          ],
          '조퇴외출반차': [
              { value: '조퇴', text: '조퇴' },
              { value: '외근', text: '외근' },
              { value: '외출', text: '외출' },
              { value: '전반차', text: '전반차' },
              { value: '후반차', text: '후반차' }
          ]
      };

      // 탭 전환 기능
      $('.tab-button').click(function() {
          $('.tab-button').removeClass('active bg-blue-500 text-white').addClass('bg-gray-300 text-gray-700');
          $(this).removeClass('bg-gray-300 text-gray-700').addClass('active bg-blue-500 text-white');

          $('.tab-panel').addClass('hidden');

          if (this.id === 'generalTab') {
              $('#generalPanel').removeClass('hidden');
          } else {
              $('#etcPanel').removeClass('hidden');
          }
      });

      // 근태 마스터 로드
      loadShiftMasters();

      // 초기 데이터 로드
      setTimeout(function() {
          if (currentUser.deptCode && $('#generalWorkDate').val()) {
              searchGeneralEmployees();
          } else {
              console.warn('부서코드 또는 날짜가 설정되지 않음');
              if (!$('#generalDeptSelect').val() && currentUser.deptCode) {
                  $('#generalDeptSelect').val(currentUser.deptCode);
              }
              if ($('#generalWorkDate').val()) {
                  searchGeneralEmployees();
              }
          }
      }, 100);

      // 이벤트 핸들러
      $('#searchGeneralBtn').click(searchGeneralEmployees);
      $('#searchEtcBtn').click(searchEtcEmployees);
      $('#saveGeneralBtn').click(saveGeneralApply);
      $('#saveEtcBtn').click(saveEtcApply);
      $('#deleteGeneralBtn').click(deleteGeneralApply);
      $('#deleteEtcBtn').click(deleteEtcApply);
      $('#submitGeneralBtn').click(submitGeneralApply);
      $('#submitEtcBtn').click(submitEtcApply);
      $('#cancelGeneralBtn').click(cancelGeneralApply);
      $('#cancelEtcBtn').click(cancelEtcApply);

      // 근태신청종류 변경 시 신청근무 옵션 업데이트
      $('#generalApplyType').change(function() {
          const selectedType = $(this).val();
          updateWorkTypeOptions(selectedType);

          const isLeaveType = selectedType === '조퇴외출반차';
          $('.expected-hours').closest('td').toggleClass('hidden', isLeaveType);
          $('.expected-hours').closest('th').toggleClass('hidden', isLeaveType);
      });

      // 근태 마스터 로드 함수
      function loadShiftMasters() {
          $.get('/user/apply/shift-masters')
              .done(function(data) {
                  shiftMasters = data;
              })
              .fail(function() {
                  console.error('근태 마스터 로드 실패');
              });
      }

      // 신청근무 옵션 업데이트 함수
      function updateWorkTypeOptions(applyType) {
          const options = workTypeOptions[applyType] || [];

          // 모든 신청근무 드롭다운 업데이트
          $('#generalEmployeeTable .work-select').each(function() {
              const currentValue = $(this).val();
              $(this).empty();

              options.forEach(function(option) {
                  $(this).append(`<option value="${option.value}">${option.text}</option>`);
              }.bind(this));

              // 이전 선택값이 새 옵션에 있으면 유지
              if (options.some(opt => opt.value === currentValue)) {
                  $(this).val(currentValue);
              }
          });
      }

      // 일반근태 사원 조회
      function searchGeneralEmployees() {
          const deptCode = $('#generalDeptSelect').val();
          const workDate = $('#generalWorkDate').val();

          if (!deptCode) {
              console.error('부서코드가 선택되지 않았습니다.');
              alert('부서를 선택해주세요.');
              return;
          }

          if (!workDate) {
              console.error('근무일이 설정되지 않았습니다.');
              alert('근무일을 선택해주세요.');
              return;
          }

          const formattedWorkDate = workDate.replace(/-/g, '');

          console.log('사원 조회 요청:', { deptCode, workDate: formattedWorkDate });

          $.get('/user/apply/employees', {
              deptCode: deptCode,
              workDate: formattedWorkDate
          })
          .done(function(employees) {
              console.log('사원 조회 성공:', employees);
              displayGeneralEmployees(employees);
          })
          .fail(function(xhr, status, error) {
              console.error('사원 조회 실패:', { xhr, status, error });
              console.error('응답 내용:', xhr.responseText);
              alert('사원 조회에 실패했습니다: ' + (xhr.responseText || error));
          });
      }

      // 기타근태 사원 조회
      function searchEtcEmployees() {
          const deptCode = $('#etcDeptSelect').val();
          const workDate = $('#etcWorkDate').val();
          const workPlan = $('#etcWorkPlan').val();

          if (!deptCode) {
              alert('부서를 선택해주세요.');
              return;
          }

          if (!workDate) {
              alert('근무일을 선택해주세요.');
              return;
          }

          const formattedWorkDate = workDate.replace(/-/g, '');

          $.get('/user/apply/employees', {
              deptCode: deptCode,
              workDate: formattedWorkDate,
              workPlan: workPlan
          })
          .done(function(employees) {
              displayEtcEmployees(employees);
          })
          .fail(function(xhr, status, error) {
              console.error('사원 조회 실패:', { xhr, status, error });
              alert('사원 조회에 실패했습니다: ' + (xhr.responseText || error));
          });
      }

      // 일반근태 사원 목록 표시
      function displayGeneralEmployees(employees) {
          const tbody = $('#generalEmployeeBody');
          tbody.empty();

          employees.forEach(function(emp) {
              // 근무정보 조회 추가 (수정: 실적 데이터 강화)
              loadWorkInfo(emp.empCode, $('#generalWorkDate').val().replace(/-/g, ''), function(workInfo) {
                  const applyType = $('#generalApplyType').val();
                  const isLeaveType = applyType === '조퇴외출반차';

                  // 신청근무 드롭다운 옵션 생성
                  const workOptions = workTypeOptions[applyType] || [];
                  let workSelectHtml = '';
                  workOptions.forEach(function(option) {
                      workSelectHtml += `<option value="${option.value}">${option.text}</option>`;
                  });

                  // 실제 신청번호와 상태 사용
                  const applyNo = emp.applyGeneralNo || '';
                  const status = emp.generalApplyStatus || '대기';

                  // 실적 표시
                  let recordDisplay = '';
                  if (workInfo.record && workInfo.record.checkInTime && workInfo.record.checkInTime !== '-') {
                      // apply.txt: 출근 시각이 존재하면 계획 그대로의 값 (근태명 표시)
                      recordDisplay = workInfo.record.shiftName || workInfo.plan || '-';
                  } else {
                      // apply.txt: 출근이 존재하지 않으면 결근
                      recordDisplay = '결근';
                  }

                  const row = `
                      <tr data-emp-code="${emp.empCode}" data-apply-no="${applyNo}">
                          <td class="border border-gray-300 px-4 py-2">
                              <input type="checkbox" class="emp-checkbox">
                          </td>
                          <td class="border border-gray-300 px-4 py-2">${emp.empCode}</td>
                          <td class="border border-gray-300 px-4 py-2">${emp.empName}</td>
                          <td class="border border-gray-300 px-4 py-2">${emp.positionName || ''}</td>
                          <td class="border border-gray-300 px-4 py-2">${emp.deptName || ''}</td>
                          <td class="border border-gray-300 px-4 py-2">${workInfo.plan || ''}</td>
                          <td class="border border-gray-300 px-4 py-2">${recordDisplay}</td>
                          <td class="border border-gray-300 px-4 py-2">
                              <select class="work-select w-full border rounded px-2 py-1">
                                  ${workSelectHtml}
                              </select>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <input type="time" class="start-time w-full border rounded px-2 py-1">
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <input type="time" class="end-time w-full border rounded px-2 py-1">
                          </td>
                          <td class="border border-gray-300 px-4 py-2 ${isLeaveType ? 'hidden' : ''}">
                              <span class="expected-hours">0.00</span>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <span class="status-field">${status}</span>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <span class="applicant-field">${currentUser.empName}</span>
                          </td>
                      </tr>
                  `;
                  tbody.append(row);

                  // 기존 신청 데이터가 있으면 복원
                  if (applyNo) {
                      loadSavedGeneralData(applyNo, tbody.find('tr:last'));
                  }

                  // 시간 변경 시 예상근로시간 자동 계산 이벤트 핸들러
                  const currentRow = tbody.find('tr:last');
                  currentRow.find('.start-time, .end-time').on('change', function() {
                      calculateExpectedHours(currentRow, emp.empCode);
                  });

                  // 초기 예상근로시간 계산
                  calculateExpectedHours(currentRow, emp.empCode);

                  // 상태별 버튼 활성화/비활성화
                  updateButtonStates();
              });
          });
      }

      // 기타근태 사원 목록 표시
      function displayEtcEmployees(employees) {
          const tbody = $('#etcEmployeeBody');
          tbody.empty();

          employees.forEach(function(emp) {
              // 근무정보 조회 추가
              loadWorkInfo(emp.empCode, $('#etcWorkDate').val().replace(/-/g, ''), function(workInfo) {
                  // 실제 신청번호와 상태 사용
                  const applyNo = emp.applyEtcNo || '';
                  const status = emp.etcApplyStatus || '대기';

                  // 실적 표시
                  let recordDisplay = '';
                  if (workInfo.record && workInfo.record.checkInTime && workInfo.record.checkInTime !== '-') {
                      // apply.txt: 출근 시각이 존재하면 계획 그대로의 값 (근태명 표시)
                      recordDisplay = workInfo.record.shiftName || workInfo.plan || '-';
                  } else {
                      // apply.txt: 출근이 존재하지 않으면 결근
                      recordDisplay = '결근';
                  }

                  const row = `
                      <tr data-emp-code="${emp.empCode}" data-apply-no="${applyNo}">
                          <td class="border border-gray-300 px-4 py-2">
                              <input type="checkbox" class="emp-checkbox">
                          </td>
                          <td class="border border-gray-300 px-4 py-2">${emp.empCode}</td>
                          <td class="border border-gray-300 px-4 py-2">${emp.empName}</td>
                          <td class="border border-gray-300 px-4 py-2">${emp.positionName || ''}</td>
                          <td class="border border-gray-300 px-4 py-2">${emp.deptName || ''}</td>
                          <td class="border border-gray-300 px-4 py-2">${workInfo.plan || ''}</td>
                          <td class="border border-gray-300 px-4 py-2">${recordDisplay}</td>
                          <td class="border border-gray-300 px-4 py-2">
                              <select class="shift-select w-full border rounded px-2 py-1">
                                  <option value="">선택</option>
                              </select>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <input type="date" class="start-date w-full border rounded px-2 py-1">
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <input type="date" class="end-date w-full border rounded px-2 py-1">
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <span class="annual-balance">${parseFloat(currentAnnual.balanceDay).toFixed(2)}</span>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <select class="apply-time w-full border rounded px-2 py-1">
                                  <option value="1일이전신청">1일이전신청</option>
                                  <option value="당일신청">당일신청</option>
                              </select>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <span class="status-field">${status}</span>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <span class="applicant-field">${currentUser.empName}</span>
                          </td>
                      </tr>
                  `;
                  tbody.append(row);

                  // 근태 마스터 옵션 추가
                  const shiftSelect = tbody.find('tr:last .shift-select');
                  shiftMasters.forEach(function(shift) {
                      shiftSelect.append(`<option value="${shift.shiftCode}">${shift.shiftName}</option>`);
                  });

                  // 연차잔여 업데이트
                  loadAnnualBalance(emp.empCode, function(annual) {
                      const balanceDay = parseFloat(annual.balanceDay || '0').toFixed(2);
                      tbody.find('tr:last .annual-balance').text(balanceDay);
                  });

                  // 기존 신청 데이터가 있으면 복원
                  if (applyNo) {
                      loadSavedEtcData(applyNo, tbody.find('tr:last'));
                  }

                  // 상태별 버튼 활성화/비활성화
                  updateButtonStates();
              });
          });
      }

      // 예상근로시간 계산
      function calculateExpectedHours(row, empCode) {
          const applyType = $('#generalApplyType').val();
          const startTime = row.find('.start-time').val();
          const endTime = row.find('.end-time').val();

          // 조퇴외출반차의 경우 예상근로시간 계산 불필요
          if (applyType === '조퇴외출반차') {
              row.find('.expected-hours').text('0.00');
              return;
          }

          if (!startTime || !endTime) {
              // 시간이 입력되지 않은 경우 기본 주간 예상근로시간 표시
              calculateWeeklyExpectedHours(empCode, 0, function(weeklyHours, isValid) {
                  const expectedHoursSpan = row.find('.expected-hours');
                  expectedHoursSpan.text(weeklyHours.toFixed(2));
                  expectedHoursSpan.removeClass('text-red-500 font-bold');
                  expectedHoursSpan.removeAttr('title');
              });
              return;
          }

          // 시간 계산
          const start = new Date(`2000-01-01T${startTime}:00`);
          const end = new Date(`2000-01-01T${endTime}:00`);

          if (end <= start) {
              row.find('.expected-hours').text('0.00');
              row.find('.expected-hours').addClass('text-red-500');
              return;
          }

          const diffMs = end - start;
          const diffHours = diffMs / (1000 * 60 * 60);
          const hours = Math.floor(diffHours);
          const minutes = Math.round((diffHours - hours) * 60);

          // 30분 단위로 조정
          const adjustedMinutes = Math.round(minutes / 30) * 30;
          const dailyHours = hours + (adjustedMinutes / 60);

          // 주간 총 근로시간 계산
          calculateWeeklyExpectedHours(empCode, dailyHours, function(weeklyHours, isValid) {
              const expectedHoursSpan = row.find('.expected-hours');
              expectedHoursSpan.text(weeklyHours.toFixed(2));

              if (!isValid) {
                  expectedHoursSpan.addClass('text-red-500 font-bold');
                  expectedHoursSpan.attr('title', `주 52시간 초과 (현재: ${weeklyHours.toFixed(2)}시간)`);
              } else {
                  expectedHoursSpan.removeClass('text-red-500 font-bold');
                  expectedHoursSpan.removeAttr('title');
              }
          });
      }

      // 주간 예상근로시간 계산
      function calculateWeeklyExpectedHours(empCode, requestHours, callback) {
          const workDate = $('#generalWorkDate').val().replace(/-/g, '');

          $.get(`/user/apply/workInfo/${empCode}/${workDate}`)
              .done(function(workInfo) {
                  const baseWeeklyHours = 40.0; // 기본 주 40시간
                  const currentExpectedHours = parseFloat(workInfo.expectedHours || '0');
                  const totalWeeklyHours = baseWeeklyHours + currentExpectedHours + requestHours;

                  const isValid = totalWeeklyHours <= 52.0;

                  callback(totalWeeklyHours, isValid);
              })
              .fail(function() {
                  // 데이터 조회 실패 시 기본값으로 계산
                  const defaultWeeklyHours = 40.0 + requestHours; // 기본 40시간 + 신청시간
                  const isValid = defaultWeeklyHours <= 52.0;
                  callback(defaultWeeklyHours, isValid);
              });
      }

      // 저장된 일반근태 데이터 복원 함수
      function loadSavedGeneralData(applyNo, row) {
          $.get(`/user/apply/general/${applyNo}`)
              .done(function(data) {
                  if (data) {
                      // 저장된 데이터로 폼 필드 복원
                      row.find('.work-select').val(data.applyType || '');
                      if (data.startTime) {
                          row.find('.start-time').val(formatTimeDisplay(data.startTime));
                      }
                      if (data.endTime) {
                          row.find('.end-time').val(formatTimeDisplay(data.endTime));
                      }
                      row.find('.status-field').text(data.status || '대기');

                      // 복원 후 예상근로시간 재계산
                      if (data.startTime && data.endTime) {
                          calculateExpectedHours(row, row.data('emp-code'));
                      }
                  }
              })
              .fail(function() {
                  console.log('저장된 일반근태 데이터 없음: ' + applyNo);
              });
      }

      // 저장된 기타근태 데이터 복원 함수
      function loadSavedEtcData(applyNo, row) {
          $.get(`/user/apply/etc/${applyNo}`)
              .done(function(data) {
                  if (data) {
                      // 저장된 데이터로 폼 필드 복원
                      row.find('.shift-select').val(data.shiftCode || '');
                      if (data.targetStartDate) {
                          row.find('.start-date').val(formatDateDisplay(data.targetStartDate));
                      }
                      if (data.targetEndDate) {
                          row.find('.end-date').val(formatDateDisplay(data.targetEndDate));
                      }
                      row.find('.apply-time').val(data.applyDateTime || '1일이전신청');
                      row.find('.status-field').text(data.status || '대기');
                  }
              })
              .fail(function() {
                  console.log('저장된 기타근태 데이터 없음: ' + applyNo);
              });
      }

      // 시간 포맷 변환 함수 (HHMM -> HH:MM)
      function formatTimeDisplay(timeStr) {
          if (!timeStr || timeStr.length !== 4) return '';
          return timeStr.substring(0, 2) + ':' + timeStr.substring(2, 4);
      }

      // 날짜 포맷 변환 함수 (YYYYMMDD -> YYYY-MM-DD)
      function formatDateDisplay(dateStr) {
          if (!dateStr || dateStr.length !== 8) return '';
          return dateStr.substring(0, 4) + '-' + dateStr.substring(4, 6) + '-' + dateStr.substring(6, 8);
      }

      // 상태별 버튼 활성화/비활성화 함수
      function updateButtonStates() {
          // 선택된 행들의 상태 확인
          const selectedRows = $('.emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              // 선택된 행이 없으면 조회, 저장만 활성화
              $('#saveGeneralBtn, #saveEtcBtn').prop('disabled', false);
              $('#deleteGeneralBtn, #deleteEtcBtn, #submitGeneralBtn, #submitEtcBtn, #cancelGeneralBtn, #cancelEtcBtn').prop('disabled', true);
              return;
          }

          let hasWaiting = false, hasSaved = false, hasSubmitted = false;

          selectedRows.each(function() {
              const status = $(this).find('.status-field').text();
              if (status === '대기') hasWaiting = true;
              else if (status === '저장') hasSaved = true;
              else if (status === '상신') hasSubmitted = true;
          });

          // 대기 상태: 저장만 가능
          // 저장 상태: 삭제, 상신 가능
          // 상신 상태: 상신취소만 가능
          $('#saveGeneralBtn, #saveEtcBtn').prop('disabled', !hasWaiting);
          $('#deleteGeneralBtn, #deleteEtcBtn').prop('disabled', !hasSaved);
          $('#submitGeneralBtn, #submitEtcBtn').prop('disabled', !hasSaved);
          $('#cancelGeneralBtn, #cancelEtcBtn').prop('disabled', !hasSubmitted);
      }

      // 체크박스 변경 시 버튼 상태 업데이트
      $(document).on('change', '.emp-checkbox', updateButtonStates);

      // 근무정보 조회 함수 (수정: 실적 데이터 강화)
      function loadWorkInfo(empCode, workDate, callback) {
          $.get(`/user/apply/workInfo/${empCode}/${workDate}`)
              .done(function(workInfo) {
                  callback(workInfo);
              })
              .fail(function() {
                  callback({plan: '', record: {checkInTime: '-', checkOutTime: '-', shiftCode: '', shiftName: ''}, expectedHours: '0.00'});
              });
      }

      // 연차잔여 조회 함수
      function loadAnnualBalance(empCode, callback) {
          $.get(`/user/apply/annual/${empCode}`)
              .done(function(annual) {
                  callback(annual);
              })
              .fail(function() {
                  callback({balanceDay: '0'});
              });
      }

      // 일반근태 저장
      function saveGeneralApply() {
          const selectedRows = $('#generalEmployeeTable .emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              alert('저장할 사원을 선택해주세요.');
              return;
          }

          selectedRows.each(function() {
              const row = $(this);
              const empCode = row.data('emp-code');
              const workSelect = row.find('.work-select').val();
              const startTime = row.find('.start-time').val().replace(':', '');
              const endTime = row.find('.end-time').val().replace(':', '');

              const applyType = $('#generalApplyType').val();
              if (applyType !== '조퇴외출반차') {
                  const expectedHoursSpan = row.find('.expected-hours');
                  if (expectedHoursSpan.hasClass('text-red-500')) {
                      alert(`${row.find('td:eq(2)').text()} 사원: 주 52시간을 초과합니다.`);
                      return;
                  }
              }

              const data = {
                  empCode: empCode,
                  timeItemCode: 'T001',
                  targetDate: $('#generalWorkDate').val().replace(/-/g, ''),
                  startTime: startTime,
                  endTime: endTime,
                  applyType: workSelect
              };

              $.ajax({
                  url: '/user/apply/general',
                  method: 'POST',
                  contentType: 'application/json',
                  data: JSON.stringify(data),
                  success: function(response) {
                      if (response.result === 'success') {
                          row.find('.status-field').text('저장');
                          row.attr('data-apply-no', response.data.applyGeneralNo);
                          alert('저장되었습니다.');
                          updateButtonStates();
                      } else {
                          alert('저장 실패: ' + response.message);
                      }
                  },
                  error: function() {
                      alert('저장에 실패했습니다.');
                  }
              });
          });
      }

      // 기타근태 저장
      function saveEtcApply() {
          const selectedRows = $('#etcEmployeeTable .emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              alert('저장할 사원을 선택해주세요.');
              return;
          }

          selectedRows.each(function() {
              const row = $(this);
              const empCode = row.data('emp-code');
              const shiftCode = row.find('.shift-select').val();
              const startDate = row.find('.start-date').val().replace(/-/g, '');
              const endDate = row.find('.end-date').val().replace(/-/g, '');
              const applyDateTime = row.find('.apply-time').val();

              if (!shiftCode || !startDate || !endDate) {
                  alert('필수 항목을 모두 입력해주세요.');
                  return;
              }

              // 연차 사용 시 잔여 연차 확인
              const selectedShift = shiftMasters.find(shift => shift.shiftCode === shiftCode);
              if (selectedShift && (selectedShift.shiftName.includes('연차') || selectedShift.shiftName.includes('휴가'))) {
                  const currentBalance = parseFloat(row.find('.annual-balance').text());
                  const requestDays = calculateRequestDays(startDate, endDate);

                  if (currentBalance < requestDays) {
                      alert(`연차 잔여일수가 부족합니다. (필요: ${requestDays}일, 잔여: ${currentBalance}일)`);
                      return;
                  }
              }

              const data = {
                  empCode: empCode,
                  shiftCode: shiftCode,
                  targetStartDate: startDate,
                  targetEndDate: endDate,
                  applyDateTime: applyDateTime,
                  reason: '근태변경'
              };

              $.ajax({
                  url: '/user/apply/etc',
                  method: 'POST',
                  contentType: 'application/json',
                  data: JSON.stringify(data),
                  success: function(response) {
                      if (response.result === 'success') {
                          // 수정: 상태 업데이트 및 신청번호 설정
                          row.find('.status-field').text('저장');
                          row.attr('data-apply-no', response.data.applyEtcNo);
                          alert('저장되었습니다.');
                          // 수정: 버튼 상태 업데이트
                          updateButtonStates();
                      } else {
                          alert('저장 실패: ' + response.message);
                      }
                  },
                  error: function() {
                      alert('저장에 실패했습니다.');
                  }
              });
          });
      }

      // 신청 일수 계산 함수
      function calculateRequestDays(startDate, endDate) {
          const start = new Date(startDate.substring(0,4), startDate.substring(4,6)-1, startDate.substring(6,8));
          const end = new Date(endDate.substring(0,4), endDate.substring(4,6)-1, endDate.substring(6,8));
          const diffTime = Math.abs(end - start);
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
          return diffDays;
      }

      // 일반근태 삭제
      function deleteGeneralApply() {
          const selectedRows = $('#generalEmployeeTable .emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              alert('삭제할 사원을 선택해주세요.');
              return;
          }

          if (!confirm('선택된 신청을 삭제하시겠습니까?')) {
              return;
          }

          selectedRows.each(function() {
              const row = $(this);
              const applyNo = row.data('apply-no');

              if (!applyNo) {
                  alert('삭제할 신청이 없습니다.');
                  return;
              }

              $.ajax({
                  url: '/user/apply/delete/general',
                  method: 'POST',
                  data: { applyGeneralNo: applyNo },
                  success: function(response) {
                      if (response === 'success') {
                          alert('삭제되었습니다.');
                          searchGeneralEmployees();
                      } else {
                          alert('삭제 실패: ' + response);
                      }
                  },
                  error: function() {
                      alert('삭제에 실패했습니다.');
                  }
              });
          });
      }

      // 기타근태 삭제
      function deleteEtcApply() {
          const selectedRows = $('#etcEmployeeTable .emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              alert('삭제할 사원을 선택해주세요.');
              return;
          }

          if (!confirm('선택된 신청을 삭제하시겠습니까?')) {
              return;
          }

          selectedRows.each(function() {
              const row = $(this);
              const applyNo = row.data('apply-no');

              if (!applyNo) {
                  alert('삭제할 신청이 없습니다.');
                  return;
              }

              $.ajax({
                  url: '/user/apply/delete/etc',
                  method: 'POST',
                  data: { applyEtcNo: applyNo },
                  success: function(response) {
                      if (response === 'success') {
                          alert('삭제되었습니다.');
                          searchEtcEmployees();
                      } else {
                          alert('삭제 실패: ' + response);
                      }
                  },
                  error: function() {
                      alert('삭제에 실패했습니다.');
                  }
              });
          });
      }

      // 일반근태 상신
      function submitGeneralApply() {
          const selectedRows = $('#generalEmployeeTable .emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              alert('상신할 사원을 선택해주세요.');
              return;
          }

          selectedRows.each(function() {
              const row = $(this);
              const applyNo = row.data('apply-no');

              if (!applyNo) {
                  alert('상신할 신청이 없습니다.');
                  return;
              }

              $.ajax({
                  url: '/user/apply/submit/general',
                  method: 'POST',
                  data: {
                      applyGeneralNo: applyNo,
                      isHeader: currentUser.isHeader
                  },
                  success: function(response) {
                      if (response === 'success') {
                          // 신규 추가: apply.txt 로직 - "부서장이 신청할 경우 자동으로 승인완료 처리"
                          const finalStatus = currentUser.isHeader === 'Y' ? '승인완료' : '상신';
                          row.find('.status-field').text(finalStatus);
                          alert(currentUser.isHeader === 'Y' ? '자동 승인완료되었습니다.' : '상신되었습니다.');
                          updateButtonStates(); // 버튼 상태 업데이트
                      } else {
                          alert('상신 실패: ' + response);
                      }
                  },
                  error: function() {
                      alert('상신에 실패했습니다.');
                  }
              });
          });
      }

      // 기타근태 상신
      function submitEtcApply() {
          const selectedRows = $('#etcEmployeeTable .emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              alert('상신할 사원을 선택해주세요.');
              return;
          }

          selectedRows.each(function() {
              const row = $(this);
              const applyNo = row.data('apply-no');

              if (!applyNo) {
                  alert('상신할 신청이 없습니다.');
                  return;
              }

              $.ajax({
                  url: '/user/apply/submit/etc',
                  method: 'POST',
                  data: {
                      applyEtcNo: applyNo,
                      isHeader: currentUser.isHeader
                  },
                  success: function(response) {
                      if (response === 'success') {
                          const finalStatus = currentUser.isHeader === 'Y' ? '승인완료' : '상신';
                          row.find('.status-field').text(finalStatus);

                          if (finalStatus === '승인완료') {
                              const shiftCode = row.find('.shift-select').val();
                              const selectedShift = shiftMasters.find(shift => shift.shiftCode === shiftCode);
                              if (selectedShift && (selectedShift.shiftName.includes('연차') || selectedShift.shiftName.includes('휴가'))) {
                                  const startDate = row.find('.start-date').val().replace(/-/g, '');
                                  const endDate = row.find('.end-date').val().replace(/-/g, '');
                                  const requestDays = calculateRequestDays(startDate, endDate);
                                  const currentBalance = parseFloat(row.find('.annual-balance').text());
                                  const newBalance = currentBalance - requestDays;
                                  row.find('.annual-balance').text(newBalance.toFixed(2));
                              }
                          }

                          alert(currentUser.isHeader === 'Y' ? '자동 승인완료되었습니다.' : '상신되었습니다.');
                          updateButtonStates(); // 버튼 상태 업데이트
                      } else {
                          alert('상신 실패: ' + response);
                      }
                  },
                  error: function() {
                      alert('상신에 실패했습니다.');
                  }
              });
          });
      }

      // 일반근태 상신취소
      function cancelGeneralApply() {
          const selectedRows = $('#generalEmployeeTable .emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              alert('상신취소할 사원을 선택해주세요.');
              return;
          }

          selectedRows.each(function() {
              const row = $(this);
              const applyNo = row.data('apply-no');

              if (!applyNo) {
                  alert('상신취소할 신청이 없습니다.');
                  return;
              }

              $.ajax({
                  url: '/user/apply/cancel/general',
                  method: 'POST',
                  data: { applyGeneralNo: applyNo },
                  success: function(response) {
                      if (response === 'success') {
                          row.find('.status-field').text('저장');
                          alert('상신취소되었습니다.');
                          updateButtonStates(); // 버튼 상태 업데이트
                      } else {
                          alert('상신취소 실패: ' + response);
                      }
                  },
                  error: function() {
                      alert('상신취소에 실패했습니다.');
                  }
              });
          });
      }

      // 기타근태 상신취소
      function cancelEtcApply() {
          const selectedRows = $('#etcEmployeeTable .emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              alert('상신취소할 사원을 선택해주세요.');
              return;
          }

          selectedRows.each(function() {
              const row = $(this);
              const applyNo = row.data('apply-no');

              if (!applyNo) {
                  alert('상신취소할 신청이 없습니다.');
                  return;
              }

              $.ajax({
                  url: '/user/apply/cancel/etc',
                  method: 'POST',
                  data: { applyEtcNo: applyNo },
                  success: function(response) {
                      if (response === 'success') {
                          row.find('.status-field').text('저장');
                          alert('상신취소되었습니다.');
                          updateButtonStates(); // 버튼 상태 업데이트
                      } else {
                          alert('상신취소 실패: ' + response);
                      }
                  },
                  error: function() {
                      alert('상신취소에 실패했습니다.');
                  }
              });
          });
      }
  });
</script>

</body>
</html>
