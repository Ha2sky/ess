<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>근태 신청</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-gray-100 p-6">

<div class="max-w-full mx-auto bg-white rounded shadow">
  <!-- 헤더 -->
  <div class="bg-blue-600 text-white p-4 rounded-t">
    <h1 class="text-2xl font-bold">근태 신청</h1>
    <p>현재 사용자:
      <span th:text="${currentEmp?.empName} ?: '정보없음'"></span>
      (<span th:text="${currentEmp?.empCode} ?: 'N/A'"></span>)
      <!-- 부서장 여부 표시 -->
      <span th:if="${currentEmp?.isHeader == 'Y'}" class="bg-yellow-500 text-black px-2 py-1 rounded text-sm ml-2">부서장</span>
    </p>
  </div>

  <!-- 탭 메뉴 -->
  <div class="border-b border-gray-200">
    <nav class="flex space-x-8">
      <button id="generalTab" class="tab-button active bg-blue-500 text-white px-4 py-2 rounded-t">
        일반근태 신청
      </button>
      <button id="etcTab" class="tab-button bg-gray-300 text-gray-700 px-4 py-2 rounded-t">
        기타근태 신청
      </button>
    </nav>
  </div>

  <!-- 일반근태 신청 탭 -->
  <div id="generalPanel" class="tab-panel p-6">
    <h2 class="text-xl font-semibold mb-4">일반근태 신청 (연장, 휴일근로, 조퇴/외출/반차)</h2>

    <!-- 검색 조건 -->
    <div class="bg-gray-50 p-4 rounded mb-6">
      <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">근태신청종류</label>
          <select id="generalApplyType" class="mt-1 block w-full border border-gray-300 rounded p-2">
            <option value="연장근로">연장근로</option>
            <option value="휴일근로">휴일근로</option>
            <option value="조퇴외출반차">조퇴/외출/반차</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">근무일</label>
          <input type="date" id="generalWorkDate" class="mt-1 block w-full border border-gray-300 rounded p-2"
                 th:value="${today}">
        </div>
        <!-- 부서 드롭다운 -->
        <div>
          <label class="block text-sm font-medium text-gray-700">부서</label>
          <select id="generalDeptSelect" class="mt-1 block w-full border border-gray-300 rounded p-2">
            <option th:value="${currentEmp.deptCode}" th:text="${currentEmp.deptName}" selected></option>
            <!-- 부서장인 경우 하위부서 옵션 동적 로드 -->
            <option th:each="dept : ${availableDepartments}"
                    th:if="${dept.deptCode != currentEmp.deptCode}"
                    th:value="${dept.deptCode}"
                    th:text="${dept.deptName}"></option>
          </select>
        </div>
        <div class="flex items-end space-x-2 col-span-3">
          <button id="searchGeneralBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
            조회
          </button>
          <button id="saveGeneralBtn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
            저장
          </button>
          <button id="deleteGeneralBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
            삭제
          </button>
          <button id="submitGeneralBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
            상신
          </button>
          <button id="cancelGeneralBtn" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
            상신취소
          </button>
        </div>
      </div>
    </div>

    <!-- 사원 목록 테이블 -->
    <div class="overflow-x-auto mb-6">
      <table id="generalEmployeeTable" class="min-w-full border-collapse border border-gray-300">
        <thead class="bg-gray-100">
        <tr>
          <th class="border border-gray-300 px-4 py-2">선택</th>
          <th class="border border-gray-300 px-4 py-2">사번</th>
          <th class="border border-gray-300 px-4 py-2">성명</th>
          <th class="border border-gray-300 px-4 py-2">직위</th>
          <th class="border border-gray-300 px-4 py-2">부서</th>
          <th class="border border-gray-300 px-4 py-2">계획</th>
          <th class="border border-gray-300 px-4 py-2">실적</th>
          <th class="border border-gray-300 px-4 py-2">신청근무</th>
          <th class="border border-gray-300 px-4 py-2">시작시간</th>
          <th class="border border-gray-300 px-4 py-2">종료시간</th>
          <th class="border border-gray-300 px-4 py-2">예상근로시간</th>
          <th class="border border-gray-300 px-4 py-2">상태</th>
          <th class="border border-gray-300 px-4 py-2">상신자</th>
        </tr>
        </thead>
        <tbody id="generalEmployeeBody">
        <!-- 동적으로 로드될 사원 목록 -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- 기타근태 신청 탭 -->
  <div id="etcPanel" class="tab-panel p-6 hidden">
    <h2 class="text-xl font-semibold mb-4">기타근태 신청 (근태 변경)</h2>

    <!-- 검색 조건 -->
    <div class="bg-gray-50 p-4 rounded mb-6">
      <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">근무일</label>
          <input type="date" id="etcWorkDate" class="mt-1 block w-full border border-gray-300 rounded p-2"
                 th:value="${today}">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">근무계획</label>
          <select id="etcWorkPlan" class="mt-1 block w-full border border-gray-300 rounded p-2">
            <option value="">전체</option>
            <option value="주간">주간</option>
            <option value="휴일">휴일</option>
            <option value="휴무일">휴무일</option>
          </select>
        </div>
        <!-- 부서 드롭다운 -->
        <div>
          <label class="block text-sm font-medium text-gray-700">부서</label>
          <select id="etcDeptSelect" class="mt-1 block w-full border border-gray-300 rounded p-2">
            <option th:value="${currentEmp.deptCode}" th:text="${currentEmp.deptName}" selected></option>
            <!-- 부서장인 경우 하위부서 옵션 동적 로드 -->
            <option th:each="dept : ${availableDepartments}"
                    th:if="${dept.deptCode != currentEmp.deptCode}"
                    th:value="${dept.deptCode}"
                    th:text="${dept.deptName}"></option>
          </select>
        </div>
        <div class="flex items-end space-x-2 col-span-3">
          <button id="searchEtcBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
            조회
          </button>
          <button id="saveEtcBtn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
            저장
          </button>
          <button id="deleteEtcBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
            삭제
          </button>
          <button id="submitEtcBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
            상신
          </button>
          <button id="cancelEtcBtn" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
            상신취소
          </button>
        </div>
      </div>
    </div>

    <!-- 사원 목록 테이블 -->
    <div class="overflow-x-auto mb-6">
      <table id="etcEmployeeTable" class="min-w-full border-collapse border border-gray-300">
        <thead class="bg-gray-100">
        <tr>
          <th class="border border-gray-300 px-4 py-2">선택</th>
          <th class="border border-gray-300 px-4 py-2">사번</th>
          <th class="border border-gray-300 px-4 py-2">성명</th>
          <th class="border border-gray-300 px-4 py-2">직위</th>
          <th class="border border-gray-300 px-4 py-2">부서</th>
          <th class="border border-gray-300 px-4 py-2">계획</th>
          <th class="border border-gray-300 px-4 py-2">실적</th>
          <th class="border border-gray-300 px-4 py-2">변경근무</th>
          <th class="border border-gray-300 px-4 py-2">시작일</th>
          <th class="border border-gray-300 px-4 py-2">종료일</th>
          <th class="border border-gray-300 px-4 py-2">연차잔여</th>
          <th class="border border-gray-300 px-4 py-2">신청시각</th>
          <th class="border border-gray-300 px-4 py-2">상태</th>
          <th class="border border-gray-300 px-4 py-2">상신자</th>
        </tr>
        </thead>
        <tbody id="etcEmployeeBody">
        <!-- 동적으로 로드될 사원 목록 -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  $(document).ready(function() {
      // 전역 변수에 현재 사용자 정보 저장
      const currentUser = {
          empCode: '[[${currentEmp.empCode}]]',
          empName: '[[${currentEmp.empName}]]',
          isHeader: '[[${currentEmp.isHeader}]]',
          deptCode: '[[${currentEmp.deptCode}]]'  // 수정: 부서코드 추가
      };

      // 연차잔여 정보 저장
      const currentAnnual = {
          balanceDay: '[[${annualDetail?.balanceDay} ?: 0]]'
      };

      let shiftMasters = [];

      // 신청근무 옵션 정의
      const workTypeOptions = {
          '연장근로': [
              { value: '조출연장', text: '조출연장' },
              { value: '연장', text: '연장' }
          ],
          '휴일근로': [
              { value: '휴일근무', text: '휴일근무' }
          ],
          '조퇴외출반차': [
              { value: '조퇴', text: '조퇴' },
              { value: '외근', text: '외근' },
              { value: '외출', text: '외출' },
              { value: '전반차', text: '전반차' },
              { value: '후반차', text: '후반차' }
          ]
      };

      // 탭 전환 기능
      $('.tab-button').click(function() {
          $('.tab-button').removeClass('active bg-blue-500 text-white').addClass('bg-gray-300 text-gray-700');
          $(this).removeClass('bg-gray-300 text-gray-700').addClass('active bg-blue-500 text-white');

          $('.tab-panel').addClass('hidden');

          if (this.id === 'generalTab') {
              $('#generalPanel').removeClass('hidden');
          } else {
              $('#etcPanel').removeClass('hidden');
          }
      });

      // 근태 마스터 로드
      loadShiftMasters();

      // 초기 데이터 로드
      setTimeout(function() {
          // 부서코드와 날짜 유효성 검사 후 실행
          if (currentUser.deptCode && $('#generalWorkDate').val()) {
              searchGeneralEmployees();
          } else {
              console.warn('부서코드 또는 날짜가 설정되지 않음');
              // 수동으로 값 설정 후 재시도
              if (!$('#generalDeptSelect').val() && currentUser.deptCode) {
                  $('#generalDeptSelect').val(currentUser.deptCode);
              }
              if ($('#generalWorkDate').val()) {
                  searchGeneralEmployees();
              }
          }
      }, 100);

      // 이벤트 핸들러
      $('#searchGeneralBtn').click(searchGeneralEmployees);
      $('#searchEtcBtn').click(searchEtcEmployees);
      $('#saveGeneralBtn').click(saveGeneralApply);
      $('#saveEtcBtn').click(saveEtcApply);
      $('#deleteGeneralBtn').click(deleteGeneralApply);
      $('#deleteEtcBtn').click(deleteEtcApply);
      $('#submitGeneralBtn').click(submitGeneralApply);
      $('#submitEtcBtn').click(submitEtcApply);
      $('#cancelGeneralBtn').click(cancelGeneralApply);
      $('#cancelEtcBtn').click(cancelEtcApply);

      // 근태신청종류 변경 시 신청근무 옵션 업데이트
      $('#generalApplyType').change(function() {
          const selectedType = $(this).val();
          updateWorkTypeOptions(selectedType);

          const isLeaveType = selectedType === '조퇴외출반차';
          $('.expected-hours').closest('td').toggleClass('hidden', isLeaveType);
          $('.expected-hours').closest('th').toggleClass('hidden', isLeaveType);
      });

      // 근태 마스터 로드 함수
      function loadShiftMasters() {
          $.get('/user/apply/shift-masters')
              .done(function(data) {
                  shiftMasters = data;
              })
              .fail(function() {
                  console.error('근태 마스터 로드 실패');
              });
      }

      // 신청근무 옵션 업데이트 함수
      function updateWorkTypeOptions(applyType) {
          const options = workTypeOptions[applyType] || [];

          // 모든 신청근무 드롭다운 업데이트
          $('#generalEmployeeTable .work-select').each(function() {
              const currentValue = $(this).val();
              $(this).empty();

              options.forEach(function(option) {
                  $(this).append(`<option value="${option.value}">${option.text}</option>`);
              }.bind(this));

              // 이전 선택값이 새 옵션에 있으면 유지
              if (options.some(opt => opt.value === currentValue)) {
                  $(this).val(currentValue);
              }
          });
      }

      // 일반근태 사원 조회
      function searchGeneralEmployees() {
          const deptCode = $('#generalDeptSelect').val();
          const workDate = $('#generalWorkDate').val();

          // 입력값 유효성 검사
          if (!deptCode) {
              console.error('부서코드가 선택되지 않았습니다.');
              alert('부서를 선택해주세요.');
              return;
          }

          if (!workDate) {
              console.error('근무일이 설정되지 않았습니다.');
              alert('근무일을 선택해주세요.');
              return;
          }

          const formattedWorkDate = workDate.replace(/-/g, '');

          console.log('사원 조회 요청:', { deptCode, workDate: formattedWorkDate });

          $.get('/user/apply/employees', {
              deptCode: deptCode,
              workDate: formattedWorkDate
          })
          .done(function(employees) {
              console.log('사원 조회 성공:', employees);
              displayGeneralEmployees(employees);
          })
          .fail(function(xhr, status, error) {
              console.error('사원 조회 실패:', { xhr, status, error });
              console.error('응답 내용:', xhr.responseText);
              alert('사원 조회에 실패했습니다: ' + (xhr.responseText || error));
          });
      }

      // 기타근태 사원 조회
      function searchEtcEmployees() {
          const deptCode = $('#etcDeptSelect').val();
          const workDate = $('#etcWorkDate').val();
          const workPlan = $('#etcWorkPlan').val();

          // 입력값 유효성 검사
          if (!deptCode) {
              alert('부서를 선택해주세요.');
              return;
          }

          if (!workDate) {
              alert('근무일을 선택해주세요.');
              return;
          }

          const formattedWorkDate = workDate.replace(/-/g, '');

          $.get('/user/apply/employees', {
              deptCode: deptCode,
              workDate: formattedWorkDate,
              workPlan: workPlan
          })
          .done(function(employees) {
              displayEtcEmployees(employees);
          })
          .fail(function(xhr, status, error) {
              console.error('사원 조회 실패:', { xhr, status, error });
              alert('사원 조회에 실패했습니다: ' + (xhr.responseText || error));
          });
      }

      // 일반근태 사원 목록 표시
      function displayGeneralEmployees(employees) {
          const tbody = $('#generalEmployeeBody');
          tbody.empty();

          employees.forEach(function(emp) {
              // 근무정보 조회 추가
              loadWorkInfo(emp.empCode, $('#generalWorkDate').val().replace(/-/g, ''), function(workInfo) {
                  const applyType = $('#generalApplyType').val();
                  const isLeaveType = applyType === '조퇴외출반차';

                  // 신청근무 드롭다운 옵션 생성
                  const workOptions = workTypeOptions[applyType] || [];
                  let workSelectHtml = '';
                  workOptions.forEach(function(option) {
                      workSelectHtml += `<option value="${option.value}">${option.text}</option>`;
                  });

                  // 실제 신청번호와 상태 사용
                  const applyNo = emp.applyGeneralNo || '';
                  const status = emp.generalApplyStatus || '대기';

                  const row = `
                      <tr data-emp-code="${emp.empCode}" data-apply-no="${applyNo}">
                          <td class="border border-gray-300 px-4 py-2">
                              <input type="checkbox" class="emp-checkbox">
                          </td>
                          <td class="border border-gray-300 px-4 py-2">${emp.empCode}</td>
                          <td class="border border-gray-300 px-4 py-2">${emp.empName}</td>
                          <td class="border border-gray-300 px-4 py-2">${emp.positionName || ''}</td>
                          <td class="border border-gray-300 px-4 py-2">${emp.deptName || ''}</td>
                          <td class="border border-gray-300 px-4 py-2">${workInfo.plan || ''}</td>
                          <td class="border border-gray-300 px-4 py-2">${workInfo.record ? workInfo.record.checkInTime + '-' + workInfo.record.checkOutTime : ''}</td>
                          <td class="border border-gray-300 px-4 py-2">
                              <select class="work-select w-full border rounded px-2 py-1">
                                  ${workSelectHtml}
                              </select>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <input type="time" class="start-time w-full border rounded px-2 py-1">
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <input type="time" class="end-time w-full border rounded px-2 py-1">
                          </td>
                          <td class="border border-gray-300 px-4 py-2 ${isLeaveType ? 'hidden' : ''}">
                              <span class="expected-hours">${workInfo.expectedHours || '0'}</span>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <span class="status-field">${status}</span>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <span class="applicant-field">${currentUser.empName}</span>
                          </td>
                      </tr>
                  `;
                  tbody.append(row);
              });
          });
      }

      // 기타근태 사원 목록 표시
      function displayEtcEmployees(employees) {
          const tbody = $('#etcEmployeeBody');
          tbody.empty();

          employees.forEach(function(emp) {
              // 근무정보 조회 추가
              loadWorkInfo(emp.empCode, $('#etcWorkDate').val().replace(/-/g, ''), function(workInfo) {
                  // 실제 신청번호와 상태 사용
                  const applyNo = emp.applyEtcNo || '';
                  const status = emp.etcApplyStatus || '대기';

                  const row = `
                      <tr data-emp-code="${emp.empCode}" data-apply-no="${applyNo}">
                          <td class="border border-gray-300 px-4 py-2">
                              <input type="checkbox" class="emp-checkbox">
                          </td>
                          <td class="border border-gray-300 px-4 py-2">${emp.empCode}</td>
                          <td class="border border-gray-300 px-4 py-2">${emp.empName}</td>
                          <td class="border border-gray-300 px-4 py-2">${emp.positionName || ''}</td>
                          <td class="border border-gray-300 px-4 py-2">${emp.deptName || ''}</td>
                          <td class="border border-gray-300 px-4 py-2">${workInfo.plan || ''}</td>
                          <td class="border border-gray-300 px-4 py-2">${workInfo.record ? workInfo.record.checkInTime + '-' + workInfo.record.checkOutTime : ''}</td>
                          <td class="border border-gray-300 px-4 py-2">
                              <select class="shift-select w-full border rounded px-2 py-1">
                                  <option value="">선택</option>
                              </select>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <input type="date" class="start-date w-full border rounded px-2 py-1">
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <input type="date" class="end-date w-full border rounded px-2 py-1">
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <span class="annual-balance">${parseFloat(currentAnnual.balanceDay).toFixed(2)}</span>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <select class="apply-time w-full border rounded px-2 py-1">
                                  <option value="1일이전신청">1일이전신청</option>
                                  <option value="당일신청">당일신청</option>
                              </select>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <span class="status-field">${status}</span>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <span class="applicant-field">${currentUser.empName}</span>
                          </td>
                      </tr>
                  `;
                  tbody.append(row);

                  // 근태 마스터 옵션 추가
                  const shiftSelect = tbody.find('tr:last .shift-select');
                  shiftMasters.forEach(function(shift) {
                      shiftSelect.append(`<option value="${shift.shiftCode}">${shift.shiftName}</option>`);
                  });

                  // 수정: 연차잔여 업데이트 (요청사항 2) - 소수점 2자리까지 표시
                  loadAnnualBalance(emp.empCode, function(annual) {
                      const balanceDay = parseFloat(annual.balanceDay || '0').toFixed(2);
                      tbody.find('tr:last .annual-balance').text(balanceDay);
                  });
              });
          });
      }

      // 근무정보 조회 함수 추가
      function loadWorkInfo(empCode, workDate, callback) {
          $.get(`/user/apply/workInfo/${empCode}/${workDate}`)
              .done(function(workInfo) {
                  callback(workInfo);
              })
              .fail(function() {
                  callback({plan: '', record: null, expectedHours: '0'});
              });
      }

      // 연차잔여 조회 함수 추가
      function loadAnnualBalance(empCode, callback) {
          $.get(`/user/apply/annual/${empCode}`)
              .done(function(annual) {
                  callback(annual);
              })
              .fail(function() {
                  callback({balanceDay: '0'});
              });
      }

      // 일반근태 저장
      function saveGeneralApply() {
          const selectedRows = $('#generalEmployeeTable .emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              alert('저장할 사원을 선택해주세요.');
              return;
          }

          selectedRows.each(function() {
              const row = $(this);
              const empCode = row.data('emp-code');
              const workSelect = row.find('.work-select').val();
              const startTime = row.find('.start-time').val().replace(':', '');
              const endTime = row.find('.end-time').val().replace(':', '');

              const data = {
                  empCode: empCode,
                  timeItemCode: 'T001', // 기본값
                  targetDate: $('#generalWorkDate').val().replace(/-/g, ''),
                  startTime: startTime,
                  endTime: endTime,
                  applyType: $('#generalApplyType').val()
              };

              $.ajax({
                  url: '/user/apply/general',
                  method: 'POST',
                  contentType: 'application/json',
                  data: JSON.stringify(data),
                  success: function(response) {
                      if (response === 'success') {
                          // 수정: 상태 필드 업데이트 (요청사항 5)
                          row.find('.status-field').text('저장');
                          alert('저장되었습니다.');
                          // 새로고침으로 신청번호 갱신
                          searchGeneralEmployees();
                      } else {
                          alert('저장 실패: ' + response);
                      }
                  },
                  error: function() {
                      alert('저장에 실패했습니다.');
                  }
              });
          });
      }

      // 기타근태 저장
      function saveEtcApply() {
          const selectedRows = $('#etcEmployeeTable .emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              alert('저장할 사원을 선택해주세요.');
              return;
          }

          selectedRows.each(function() {
              const row = $(this);
              const empCode = row.data('emp-code');
              const shiftCode = row.find('.shift-select').val();
              const startDate = row.find('.start-date').val().replace(/-/g, '');
              const endDate = row.find('.end-date').val().replace(/-/g, '');
              const applyDateTime = row.find('.apply-time').val();

              if (!shiftCode || !startDate || !endDate) {
                  alert('필수 항목을 모두 입력해주세요.');
                  return;
              }

              const data = {
                  empCode: empCode,
                  shiftCode: shiftCode,
                  targetStartDate: startDate,
                  targetEndDate: endDate,
                  applyDateTime: applyDateTime,
                  reason: '근태변경'
              };

              $.ajax({
                  url: '/user/apply/etc',
                  method: 'POST',
                  contentType: 'application/json',
                  data: JSON.stringify(data),
                  success: function(response) {
                      if (response === 'success') {
                          // 수정: 상태 필드 업데이트 (요청사항 5)
                          row.find('.status-field').text('저장');
                          alert('저장되었습니다.');
                          // 새로고침으로 신청번호 갱신
                          searchEtcEmployees();
                      } else {
                          alert('저장 실패: ' + response);
                      }
                  },
                  error: function() {
                      alert('저장에 실패했습니다.');
                  }
              });
          });
      }

      // 일반근태 삭제
      function deleteGeneralApply() {
          const selectedRows = $('#generalEmployeeTable .emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              alert('삭제할 사원을 선택해주세요.');
              return;
          }

          if (!confirm('선택된 신청을 삭제하시겠습니까?')) {
              return;
          }

          selectedRows.each(function() {
              const row = $(this);
              const applyNo = row.data('apply-no'); // 수정: 실제 신청번호 사용

              if (!applyNo) {
                  alert('삭제할 신청이 없습니다.');
                  return;
              }

              $.ajax({
                  url: '/user/apply/delete/general',
                  method: 'POST',
                  data: { applyGeneralNo: applyNo }, // 수정: 실제 신청번호 전송
                  success: function(response) {
                      if (response === 'success') {
                          alert('삭제되었습니다.');
                          searchGeneralEmployees(); // 새로고침
                      } else {
                          alert('삭제 실패: ' + response);
                      }
                  },
                  error: function() {
                      alert('삭제에 실패했습니다.');
                  }
              });
          });
      }

      // 기타근태 삭제
      function deleteEtcApply() {
          const selectedRows = $('#etcEmployeeTable .emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              alert('삭제할 사원을 선택해주세요.');
              return;
          }

          if (!confirm('선택된 신청을 삭제하시겠습니까?')) {
              return;
          }

          selectedRows.each(function() {
              const row = $(this);
              const applyNo = row.data('apply-no');

              if (!applyNo) {
                  alert('삭제할 신청이 없습니다.');
                  return;
              }

              $.ajax({
                  url: '/user/apply/delete/etc',
                  method: 'POST',
                  data: { applyEtcNo: applyNo },
                  success: function(response) {
                      if (response === 'success') {
                          alert('삭제되었습니다.');
                          searchEtcEmployees();
                      } else {
                          alert('삭제 실패: ' + response);
                      }
                  },
                  error: function() {
                      alert('삭제에 실패했습니다.');
                  }
              });
          });
      }

      // 일반근태 상신
      function submitGeneralApply() {
          const selectedRows = $('#generalEmployeeTable .emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              alert('상신할 사원을 선택해주세요.');
              return;
          }

          selectedRows.each(function() {
              const row = $(this);
              const applyNo = row.data('apply-no');

              if (!applyNo) {
                  alert('상신할 신청이 없습니다.');
                  return;
              }

              $.ajax({
                  url: '/user/apply/submit/general',
                  method: 'POST',
                  data: { applyGeneralNo: applyNo },
                  success: function(response) {
                      if (response === 'success') {
                          row.find('.status-field').text('상신');
                          alert('상신되었습니다.');
                      } else {
                          alert('상신 실패: ' + response);
                      }
                  },
                  error: function() {
                      alert('상신에 실패했습니다.');
                  }
              });
          });
      }

      // 기타근태 상신
      function submitEtcApply() {
          const selectedRows = $('#etcEmployeeTable .emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              alert('상신할 사원을 선택해주세요.');
              return;
          }

          selectedRows.each(function() {
              const row = $(this);
              const applyNo = row.data('apply-no');

              if (!applyNo) {
                  alert('상신할 신청이 없습니다.');
                  return;
              }

              $.ajax({
                  url: '/user/apply/submit/etc',
                  method: 'POST',
                  data: { applyEtcNo: applyNo },
                  success: function(response) {
                      if (response === 'success') {
                          row.find('.status-field').text('상신');
                          alert('상신되었습니다.');
                      } else {
                          alert('상신 실패: ' + response);
                      }
                  },
                  error: function() {
                      alert('상신에 실패했습니다.');
                  }
              });
          });
      }

      // 일반근태 상신취소
      function cancelGeneralApply() {
          const selectedRows = $('#generalEmployeeTable .emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              alert('상신취소할 사원을 선택해주세요.');
              return;
          }

          selectedRows.each(function() {
              const row = $(this);
              const applyNo = row.data('apply-no');

              if (!applyNo) {
                  alert('상신취소할 신청이 없습니다.');
                  return;
              }

              $.ajax({
                  url: '/user/apply/cancel/general',
                  method: 'POST',
                  data: { applyGeneralNo: applyNo },
                  success: function(response) {
                      if (response === 'success') {
                          row.find('.status-field').text('저장');
                          alert('상신취소되었습니다.');
                      } else {
                          alert('상신취소 실패: ' + response);
                      }
                  },
                  error: function() {
                      alert('상신취소에 실패했습니다.');
                  }
              });
          });
      }

      // 기타근태 상신취소
      function cancelEtcApply() {
          const selectedRows = $('#etcEmployeeTable .emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              alert('상신취소할 사원을 선택해주세요.');
              return;
          }

          selectedRows.each(function() {
              const row = $(this);
              const applyNo = row.data('apply-no');

              if (!applyNo) {
                  alert('상신취소할 신청이 없습니다.');
                  return;
              }

              $.ajax({
                  url: '/user/apply/cancel/etc',
                  method: 'POST',
                  data: { applyEtcNo: applyNo },
                  success: function(response) {
                      if (response === 'success') {
                          row.find('.status-field').text('저장');
                          alert('상신취소되었습니다.');
                      } else {
                          alert('상신취소 실패: ' + response);
                      }
                  },
                  error: function() {
                      alert('상신취소에 실패했습니다.');
                  }
              });
          });
      }
  });
</script>

</body>
</html>
