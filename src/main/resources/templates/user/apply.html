<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>근태 신청</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-gray-100 p-6">

<div class="max-w-full mx-auto bg-white rounded shadow">
  <!-- 헤더 -->
  <div class="bg-blue-600 text-white p-4 rounded-t">
    <h1 class="text-2xl font-bold">근태 신청</h1>
    <p>현재 사용자:
      <span th:text="${currentEmp?.empName} ?: '정보없음'"></span>
      (<span th:text="${currentEmp?.empCode} ?: 'N/A'"></span>)
      <!-- 부서장 여부 표시 -->
      <span th:if="${currentEmp?.isHeader == 'Y'}" class="bg-yellow-500 text-black px-2 py-1 rounded text-sm ml-2">부서장</span>
    </p>
  </div>

  <!-- 탭 메뉴 -->
  <div class="border-b border-gray-200">
    <nav class="flex space-x-8">
      <button id="generalTab" class="tab-button active bg-blue-500 text-white px-4 py-2 rounded-t">
        일반근태 신청
      </button>
      <button id="etcTab" class="tab-button bg-gray-300 text-gray-700 px-4 py-2 rounded-t">
        기타근태 신청
      </button>
    </nav>
  </div>

  <!-- 일반근태 신청 탭 -->
  <div id="generalPanel" class="tab-panel p-6">
    <h2 class="text-xl font-semibold mb-4">일반근태 신청 (연장, 휴일근로, 조퇴/외출/반차)</h2>

    <!-- 검색 조건 -->
    <div class="bg-gray-50 p-4 rounded mb-6">
      <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">근태신청종류</label>
          <select id="generalApplyType" class="mt-1 block w-full border border-gray-300 rounded p-2">
            <option value="연장근로">연장근로</option>
            <option value="휴일근로">휴일근로</option>
            <option value="조퇴외출반차">조퇴/외출/반차</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">신청근무</label>
          <select id="generalWorkTypeFilter" class="mt-1 block w-full border border-gray-300 rounded p-2">
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">근무일</label>
          <input type="date" id="generalWorkDate" class="mt-1 block w-full border border-gray-300 rounded p-2"
                 th:value="${today}">
        </div>
        <!-- 부서 드롭다운 -->
        <div>
          <label class="block text-sm font-medium text-gray-700">부서</label>
          <select id="generalDeptSelect" class="mt-1 block w-full border border-gray-300 rounded p-2">
            <option th:value="${currentEmp.deptCode}" th:text="${currentEmp.deptName}" selected></option>
            <!-- 부서장인 경우 하위부서 옵션 동적 로드 -->
            <option th:each="dept : ${availableDepartments}"
                    th:if="${dept.deptCode != currentEmp.deptCode}"
                    th:value="${dept.deptCode}"
                    th:text="${dept.deptName}"
            ></option>
          </select>
        </div>
        <div class="flex items-end space-x-2 col-span-2">
          <button id="searchGeneralBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
            조회
          </button>
          <button id="saveGeneralBtn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
            저장
          </button>
          <button id="deleteGeneralBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
            삭제
          </button>
          <button id="submitGeneralBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
            상신
          </button>
          <button id="cancelGeneralBtn" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
            상신취소
          </button>
        </div>
      </div>
    </div>

    <!-- 사원 목록 테이블 -->
    <div class="overflow-x-auto mb-6">
      <table id="generalEmployeeTable" class="min-w-full border-collapse border border-gray-300">
        <thead class="bg-gray-100">
        <tr>
          <th class="border border-gray-300 px-4 py-2">선택</th>
          <th class="border border-gray-300 px-4 py-2">사번</th>
          <th class="border border-gray-300 px-4 py-2">성명</th>
          <th class="border border-gray-300 px-4 py-2">직위</th>
          <th class="border border-gray-300 px-4 py-2">부서</th>
          <th class="border border-gray-300 px-4 py-2">계획</th>
          <th class="border border-gray-300 px-4 py-2">실적</th>
          <th class="border border-gray-300 px-4 py-2">신청근무</th>
          <th class="border border-gray-300 px-4 py-2">시작시간</th>
          <th class="border border-gray-300 px-4 py-2">종료시간</th>
          <th class="border border-gray-300 px-4 py-2">예상근로시간</th>
          <th class="border border-gray-300 px-4 py-2">사유</th>
          <th class="border border-gray-300 px-4 py-2">상태</th>
          <th class="border border-gray-300 px-4 py-2">상신자</th>
        </tr>
        </thead>
        <tbody id="generalEmployeeBody">
        <!-- 동적으로 로드될 사원 목록 -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- 기타근태 신청 탭 -->
  <div id="etcPanel" class="tab-panel p-6 hidden">
    <h2 class="text-xl font-semibold mb-4">기타근태 신청 (근태 변경)</h2>

    <!-- 검색 조건 -->
    <div class="bg-gray-50 p-4 rounded mb-6">
      <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">근무일</label>
          <input type="date" id="etcWorkDate" class="mt-1 block w-full border border-gray-300 rounded p-2"
                 th:value="${today}">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">근무계획</label>
          <select id="etcWorkPlan" class="mt-1 block w-full border border-gray-300 rounded p-2">
            <option value="">전체</option>
            <option value="주간">주간</option>
            <option value="휴일">휴일</option>
            <option value="휴무일">휴무일</option>
          </select>
        </div>
        <!-- 부서 드롭다운 -->
        <div>
          <label class="block text-sm font-medium text-gray-700">부서</label>
          <select id="etcDeptSelect" class="mt-1 block w-full border border-gray-300 rounded p-2">
            <option th:value="${currentEmp.deptCode}" th:text="${currentEmp.deptName}" selected></option>
            <!-- 부서장인 경우 하위부서 옵션 동적 로드 -->
            <option th:each="dept : ${availableDepartments}"
                    th:if="${dept.deptCode != currentEmp.deptCode}"
                    th:value="${dept.deptCode}"
                    th:text="${dept.deptName}"></option>
          </select>
        </div>
        <div class="flex items-end space-x-2 col-span-3">
          <button id="searchEtcBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
            조회
          </button>
          <button id="saveEtcBtn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
            저장
          </button>
          <button id="deleteEtcBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
            삭제
          </button>
          <button id="submitEtcBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
            상신
          </button>
          <button id="cancelEtcBtn" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
            상신취소
          </button>
        </div>
      </div>
    </div>

    <!-- 사원 목록 테이블 -->
    <div class="overflow-x-auto mb-6">
      <table id="etcEmployeeTable" class="min-w-full border-collapse border border-gray-300">
        <thead class="bg-gray-100">
        <tr>
          <th class="border border-gray-300 px-4 py-2">선택</th>
          <th class="border border-gray-300 px-4 py-2">사번</th>
          <th class="border border-gray-300 px-4 py-2">성명</th>
          <th class="border border-gray-300 px-4 py-2">직위</th>
          <th class="border border-gray-300 px-4 py-2">부서</th>
          <th class="border border-gray-300 px-4 py-2">계획</th>
          <th class="border border-gray-300 px-4 py-2">실적</th>
          <th class="border border-gray-300 px-4 py-2">변경근무</th>
          <th class="border border-gray-300 px-4 py-2">시작일</th>
          <th class="border border-gray-300 px-4 py-2">종료일</th>
          <th class="border border-gray-300 px-4 py-2">연차잔여</th>
          <th class="border border-gray-300 px-4 py-2">신청시각</th>
          <th class="border border-gray-300 px-4 py-2">사유</th>
          <th class="border border-gray-300 px-4 py-2">상태</th>
          <th class="border border-gray-300 px-4 py-2">상신자</th>
        </tr>
        </thead>
        <tbody id="etcEmployeeBody">
        <!-- 동적으로 로드될 사원 목록 -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  $(document).ready(function() {
      // 전역 변수에 현재 사용자 정보 저장
      const currentUser = {
          empCode: '[[${currentEmp.empCode}]]',
          empName: '[[${currentEmp.empName}]]',
          isHeader: '[[${currentEmp.isHeader}]]',
          deptCode: '[[${currentEmp.deptCode}]]'
      };

      // 연차잔여 정보 저장
      const currentAnnual = {
          balanceDay: '[[${annualDetail?.balanceDay} ?: 0]]'
      };

      let shiftMasters = [];
      let isEtcSearching = false;
      let isGeneralSearching = false;

      // 신청근무 옵션 정의
      const workTypeOptions = {
          '연장근로': [
              { value: '연장', text: '연장' },
              { value: '조출연장', text: '조출연장' }
          ],
          '휴일근로': [
              { value: '휴일근무', text: '휴일근무' }
          ],
          '조퇴외출반차': [
              { value: '조퇴', text: '조퇴' },
              { value: '외근', text: '외근' },
              { value: '외출', text: '외출' },
              { value: '전반차', text: '전반차' },
              { value: '후반차', text: '후반차' }
          ]
      };

      // 탭 전환 기능
      $('.tab-button').click(function() {
        $('.tab-button').removeClass('active bg-blue-500 text-white').addClass('bg-gray-300 text-gray-700');
        $(this).removeClass('bg-gray-300 text-gray-700').addClass('active bg-blue-500 text-white');

        $('.tab-panel').addClass('hidden');

        if (this.id === 'generalTab') {
          $('#generalPanel').removeClass('hidden');
        } else {
          $('#etcPanel').removeClass('hidden');
        }
      });

      // URL 쿼리 파라미터에서 'tab' 값 읽기
      function getQueryParam(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
      }

      // 페이지 로드 시 탭 활성화 처리
      const activeTab = getQueryParam('tab');
      if (activeTab === 'etc') {
        // 기타근태신청 탭 활성화
        $('#etcTab').click();
      } else {
        // 기본값은 일반근태 신청 탭 활성화
        $('#generalTab').click();
      }

      // 근태 마스터 로드
      loadShiftMasters();

      updateWorkTypeFilter('연장근로');

      // 초기 데이터 로드
      setTimeout(function() {
          if (currentUser.deptCode && $('#generalWorkDate').val()) {
              searchGeneralEmployees();
          } else {
              console.warn('부서코드 또는 날짜가 설정되지 않음');
              if (!$('#generalDeptSelect').val() && currentUser.deptCode) {
                  $('#generalDeptSelect').val(currentUser.deptCode);
              }
              if ($('#generalWorkDate').val()) {
                  searchGeneralEmployees();
              }
          }
      }, 100);

      // 이벤트 핸들러
      $('#searchGeneralBtn').click(searchGeneralEmployees);
      $('#searchEtcBtn').click(searchEtcEmployees);
      $('#saveGeneralBtn').click(saveGeneralApply);
      $('#saveEtcBtn').click(saveEtcApply);
      $('#deleteGeneralBtn').click(deleteGeneralApply);
      $('#deleteEtcBtn').click(deleteEtcApply);
      $('#submitGeneralBtn').click(submitGeneralApply);
      $('#submitEtcBtn').click(submitEtcApply);
      $('#cancelGeneralBtn').click(cancelGeneralApply);
      $('#cancelEtcBtn').click(cancelEtcApply);

      $('#generalApplyType').change(function() {
          const selectedType = $(this).val();

          $('#generalEmployeeBody').empty();

          updateWorkTypeOptions(selectedType);
          updateWorkTypeFilter(selectedType);

          const isLeaveType = selectedType === '조퇴외출반차';

          // 테이블 데이터 셀 숨기기/보이기
          $('#generalEmployeeTable .expected-hours').closest('td').toggleClass('hidden', isLeaveType);
          // 테이블 헤더 숨기기/보이기
          $('#generalEmployeeTable thead th:eq(10)').toggleClass('hidden', isLeaveType);

          setTimeout(function() {
              searchGeneralEmployees();
          }, 100);
      });

      // 신청근무별 관리
      $('#generalWorkTypeFilter').change(function() {
          const selectedWorkType = $(this).val();
          if (selectedWorkType) {
              // 신청근무별 기존 신청 조회 및 초기화
              handleWorkTypeChange(selectedWorkType);
          }
          updateEmployeeWorkTypes(selectedWorkType);
      });

      // 근태 마스터 로드 함수
      function loadShiftMasters() {
          $.get('/user/apply/shift-masters')
              .done(function(data) {
                  shiftMasters = data;
              })
              .fail(function() {
                  console.error('근태 마스터 로드 실패');
              });
      }

      // 신청근무 옵션 업데이트 함수
      function updateWorkTypeOptions(applyType) {
          const options = workTypeOptions[applyType] || [];

          // 모든 신청근무 드롭다운 업데이트
          $('#generalEmployeeTable .work-select').each(function() {
              const currentValue = $(this).val();
              $(this).empty();

              options.forEach(function(option) {
                  $(this).append(`<option value="${option.value}">${option.text}</option>`);
              }.bind(this));

              // 이전 선택값이 새 옵션에 있으면 유지
              if (options.some(opt => opt.value === currentValue)) {
                  $(this).val(currentValue);
              }
          });
      }

      function updateWorkTypeFilter(applyType) {
          const options = workTypeOptions[applyType] || [];
          const filterSelect = $('#generalWorkTypeFilter');
          const currentValue = filterSelect.val();

          filterSelect.empty();

          if (currentUser.isHeader !== 'Y') {
              filterSelect.append('<option value="">전체</option>');
          }

          options.forEach(function(option) {
              filterSelect.append(`<option value="${option.value}">${option.text}</option>`);
          });

          if (options.length > 0 && (!currentValue || !options.some(opt => opt.value === currentValue))) {
              filterSelect.val(options[0].value);
          } else if (options.some(opt => opt.value === currentValue)) {
              filterSelect.val(currentValue);
          }
      }

      function updateEmployeeWorkTypes(selectedWorkType) {
          if (!selectedWorkType) return;

          $('#generalEmployeeTable tbody tr').each(function() {
              const workSelect = $(this).find('.work-select');
              if (workSelect.length > 0) {
                  workSelect.val(selectedWorkType);
                  validateWorkTimeRestrictions($(this));
              }
          });
      }

      // 신청근무별 관리 함수
      function handleWorkTypeChange(selectedWorkType) {
          $('#generalEmployeeTable tbody tr').each(function() {
              const row = $(this);
              const empCode = row.data('emp-code');
              const workDate = $('#generalWorkDate').val().replace(/-/g, '');

              // 기존 신청 조회 및 초기화
              loadApplyByType(empCode, workDate, selectedWorkType, row);
          });
      }

      // 신청근무별 기존 신청 조회
      function loadApplyByType(empCode, workDate, applyType, row) {
          $.get(`/user/apply/getApplyByType/${empCode}/${workDate}/${applyType}`)
              .done(function(response) {
                  if (response.hasExisting && response.status !== '삭제') {
                      // 기존 신청이 있으면 해당 데이터로 채우기
                      if (response.applyType === 'general') {
                          row.find('.work-select').val(applyType);
                          if (response.startTime) {
                              row.find('.start-time').val(formatTimeDisplay(response.startTime));
                          }
                          if (response.endTime) {
                              row.find('.end-time').val(formatTimeDisplay(response.endTime));
                          }
                          row.find('.reason-field').val(response.reason || '');
                          row.find('.status-field').text(response.status || '대기');
                          row.attr('data-apply-no', response.applyNo);
                      }
                  } else {
                      // 기존 신청이 없으면 초기화
                      row.find('.work-select').val(applyType);
                      row.find('.start-time').val('');
                      row.find('.end-time').val('');
                      row.find('.reason-field').val('');
                      row.find('.status-field').text('대기');
                      row.removeAttr('data-apply-no');
                  }

                  // 시간 제한 적용
                  validateWorkTimeRestrictions(row);
                  updateButtonStates();
              })
              .fail(function() {
                  console.error('신청근무별 조회 실패');
              });
      }

      // 시간 제한 검증 로직 강화
      function validateWorkTimeRestrictions(row) {
          const workType = row.find('.work-select').val() || row.find('.work-type-display').text();
          const startTimeInput = row.find('.start-time');
          const endTimeInput = row.find('.end-time');

          // 전반차/후반차 시간 입력 비활성화
          if (workType === '전반차' || workType === '후반차') {
              startTimeInput.prop('disabled', true).val('');
              endTimeInput.prop('disabled', true).val('');
              startTimeInput.attr('placeholder', '반차는 시간 입력 불가');
              endTimeInput.attr('placeholder', '반차는 시간 입력 불가');
          }
          // 조퇴는 시작시간만 입력
          else if (workType === '조퇴') {
              startTimeInput.prop('disabled', false);
              endTimeInput.prop('disabled', true).val('');
              startTimeInput.attr('placeholder', '조퇴 시작시간');
              endTimeInput.attr('placeholder', '자동 계산됨');
          }
          // 조출연장 시간 제한
          else if (workType === '조출연장') {
              startTimeInput.prop('disabled', false);
              endTimeInput.prop('disabled', false);
              startTimeInput.attr('max', '07:30');
              endTimeInput.attr('max', '07:30');
              startTimeInput.attr('placeholder', '07:30 이전만');
              endTimeInput.attr('placeholder', '07:30 이전만');

              // 실시간 검증
              startTimeInput.off('input.earlyOvertime').on('input.earlyOvertime', function() {
                  validateEarlyOvertimeTime($(this).val(), row);
              });
              endTimeInput.off('input.earlyOvertime').on('input.earlyOvertime', function() {
                  validateEarlyOvertimeTime($(this).val(), row);
              });
          }
          // 일반 연장 시간 제한
          else if (workType === '연장') {
              startTimeInput.prop('disabled', false);
              endTimeInput.prop('disabled', false);
              startTimeInput.attr('min', '16:20');
              startTimeInput.attr('placeholder', '16:20 이후만');
              endTimeInput.attr('placeholder', '종료시간');

              // 실시간 검증
              startTimeInput.off('input.regularOvertime').on('input.regularOvertime', function() {
                  validateRegularOvertimeTime($(this).val(), row);
              });
          }
          else {
              // 기타 근무의 경우 모든 제한 해제
              startTimeInput.prop('disabled', false);
              endTimeInput.prop('disabled', false);
              startTimeInput.removeAttr('min max placeholder');
              endTimeInput.removeAttr('min max placeholder');
          }
      }

      // 조출연장 시간 제한 검증 API 호출
      function validateEarlyOvertimeTime(time, row) {
          if (!time) return;

          $.post('/user/apply/validateEarlyOvertimeTime', { startTime: time })
              .done(function(response) {
                  if (!response.isValid) {
                      alert(response.message);
                      row.find('.start-time, .end-time').val('');
                  }
              })
              .fail(function() {
                  console.error('조출연장 시간 검증 실패');
              });
      }

      // 일반연장 시간 제한 검증 API 호출
      function validateRegularOvertimeTime(time, row) {
          if (!time) return;

          $.post('/user/apply/validateRegularOvertimeTime', { startTime: time })
              .done(function(response) {
                  if (!response.isValid) {
                      alert(response.message);
                      row.find('.start-time').val('');
                  }
              })
              .fail(function() {
                  console.error('일반연장 시간 검증 실패');
              });
      }

      function searchGeneralEmployees() {
          if (isGeneralSearching) {
              console.log('이미 조회 중입니다.');
              return;
          }

          isGeneralSearching = true;

          const deptCode = $('#generalDeptSelect').val();
          const workDate = $('#generalWorkDate').val();
          const applyTypeCategory = $('#generalApplyType').val();

          if (!deptCode) {
              console.error('부서코드가 선택되지 않았습니다.');
              alert('부서를 선택해주세요.');
              isGeneralSearching = false;
              return;
          }

          if (!workDate) {
              console.error('근무일이 설정되지 않았습니다.');
              alert('근무일을 선택해주세요.');
              isGeneralSearching = false;
              return;
          }

          const formattedWorkDate = workDate.replace(/-/g, '');

          console.log('사원 조회 요청:', { deptCode, workDate: formattedWorkDate, applyTypeCategory });

          $.get('/user/apply/employees', {
              deptCode: deptCode,
              workDate: formattedWorkDate,
              sortBy: 'gradeOrder,empCode',
              applyTypeCategory: applyTypeCategory
          })
          .done(function(employees) {
              console.log('사원 조회 성공:', employees);
              displayGeneralEmployees(employees);
          })
          .fail(function(xhr, status, error) {
              console.error('사원 조회 실패:', { xhr, status, error });
              console.error('응답 내용:', xhr.responseText);
              alert('사원 조회에 실패했습니다: ' + (xhr.responseText || error));
          })
          .always(function() {
              isGeneralSearching = false;
          });
      }

      // 기타근태 사원 조회
      function searchEtcEmployees() {
          if (isEtcSearching) {
              console.log('이미 조회 중입니다.');
              return;
          }

          isEtcSearching = true;

          const deptCode = $('#etcDeptSelect').val();
          const workDate = $('#etcWorkDate').val();
          const workPlan = $('#etcWorkPlan').val();

          if (!deptCode) {
              alert('부서를 선택해주세요.');
              isEtcSearching = false;
              return;
          }

          if (!workDate) {
              alert('근무일을 선택해주세요.');
              isEtcSearching = false;
              return;
          }

          const formattedWorkDate = workDate.replace(/-/g, '');

          $.get('/user/apply/employees', {
              deptCode: deptCode,
              workDate: formattedWorkDate,
              workPlan: workPlan,
              sortBy: 'gradeOrder,empCode'
          })
          .done(function(employees) {
              displayEtcEmployees(employees);
          })
          .fail(function(xhr, status, error) {
              console.error('사원 조회 실패:', { xhr, status, error });
              alert('사원 조회에 실패했습니다: ' + (xhr.responseText || error));
          })
          .always(function() {
              isEtcSearching = false;
          });
      }

      function forceSortTableByGrade(tbody) {
          const rows = Array.from(tbody.find('tr'));

          console.log('정렬 전 행 수:', rows.length);

          rows.sort(function(a, b) {
              const aEmpCode = $(a).find('td:eq(1)').text().trim();
              const aPositionName = $(a).find('td:eq(3)').text().trim();
              const bEmpCode = $(b).find('td:eq(1)').text().trim();
              const bPositionName = $(b).find('td:eq(3)').text().trim();

              console.log('비교:', aEmpCode, aPositionName, 'vs', bEmpCode, bPositionName);

              const gradeOrder = {
                  '사장': 1,
                  '부사장': 2,
                  '전무': 3,
                  '전무보': 4,
                  '상무': 5,
                  '상무보': 6,
                  '이사': 7,
                  '부장': 8,
                  '차장': 9,
                  '과장': 10,
                  '대리': 11,
                  '사원': 12
              };

              const aGrade = gradeOrder[aPositionName] || 999;
              const bGrade = gradeOrder[bPositionName] || 999;

              if (aGrade !== bGrade) {
                  return aGrade - bGrade;
              }

              const aEmpNum = parseInt(aEmpCode.replace(/\D/g, '')) || 0;
              const bEmpNum = parseInt(bEmpCode.replace(/\D/g, '')) || 0;

              console.log('사번 비교:', aEmpNum, 'vs', bEmpNum);

              return aEmpNum - bEmpNum;
          });

          tbody.empty();

          rows.forEach(function(row) {
              tbody.append(row);
          });

          console.log('정렬 완료 - 최종 순서:');
          tbody.find('tr').each(function(index) {
              const empCode = $(this).find('td:eq(1)').text().trim();
              const positionName = $(this).find('td:eq(3)').text().trim();
              console.log(`${index + 1}. ${empCode} ${positionName}`);
          });
      }

      function displayGeneralEmployees(employees) {
          const tbody = $('#generalEmployeeBody');
          tbody.empty();

          const selectedWorkType = $('#generalWorkTypeFilter').val();

          let processedCount = 0;
          const totalCount = employees.length;

          employees.forEach(function(emp) {
              // 근무정보 조회
              loadWorkInfo(emp.empCode, $('#generalWorkDate').val().replace(/-/g, ''), function(workInfo) {
                  const applyType = $('#generalApplyType').val();
                  const isLeaveType = applyType === '조퇴외출반차';

                  const workOptions = workTypeOptions[applyType] || [];
                  let workSelectHtml = '';
                  workOptions.forEach(function(option) {
                      const selected = (selectedWorkType && option.value === selectedWorkType) ? 'selected' : '';
                      workSelectHtml += `<option value="${option.value}" ${selected}>${option.text}</option>`;
                  });

                  const applyNo = emp.applyGeneralNo || '';
                  const status = emp.generalApplyStatus || '대기';

                  let recordDisplay = workInfo.record.shiftName || '-';
                  if (workInfo.appliedRecord && workInfo.appliedRecord.shiftName) {
                      recordDisplay = workInfo.appliedRecord.shiftName;
                  }

                  const workDate = $('#generalWorkDate').val().replace(/-/g, '');
                  const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                  const isFutureDate = workDate > today;

                  let isAbsent = false;
                  if (!isFutureDate) {
                      // 과거/현재 날짜만 결근 체크
                      isAbsent = workInfo.record.shiftCode === '00' || workInfo.record.shiftName === '결근';
                  }

                  const recordColor = isAbsent ? 'text-gray-700' : '';

                  const row = `
                      <tr data-emp-code="${emp.empCode}" data-apply-no="${applyNo}" data-is-absent="${isAbsent}" data-plan="${workInfo.empCalendarPlan || workInfo.plan || ''}" data-record="${recordDisplay}">
                          <td class="border border-gray-300 px-4 py-2">
                              <input type="checkbox" class="emp-checkbox">
                          </td>
                          <td class="border border-gray-300 px-4 py-2">${emp.empCode}</td>
                          <td class="border border-gray-300 px-4 py-2">${emp.empName}</td>
                          <td class="border border-gray-300 px-4 py-2">${emp.positionName || ''}</td>
                          <td class="border border-gray-300 px-4 py-2">${emp.deptName || ''}</td>
                          <td class="border border-gray-300 px-4 py-2">${workInfo.empCalendarPlan || workInfo.plan || ''}</td>
                          <td class="border border-gray-300 px-4 py-2 ${recordColor}">${recordDisplay}</td>
                          <td class="border border-gray-300 px-4 py-2">
                              <span class="work-type-display">${selectedWorkType || (workOptions[0] ? workOptions[0].text : '')}</span>
                              <select class="work-select hidden w-full border rounded px-2 py-1" ${isAbsent ? 'disabled' : ''}>
                                  ${workSelectHtml}
                              </select>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <input type="time" class="start-time w-full border rounded px-2 py-1" ${isAbsent ? 'disabled' : ''}>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <input type="time" class="end-time w-full border rounded px-2 py-1" ${isAbsent ? 'disabled' : ''}>
                          </td>
                          <td class="border border-gray-300 px-4 py-2 ${isLeaveType ? 'hidden' : ''}">
                              <span class="expected-hours">${workInfo.expectedHours || '40.00'}</span>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <input type="text" class="reason-field w-full border rounded px-2 py-1" placeholder="사유 입력" ${isAbsent ? 'disabled' : ''}>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <span class="status-field">${status}</span>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <span class="applicant-field">${currentUser.empName}</span>
                          </td>
                      </tr>
                  `;
                  tbody.append(row);

                  processedCount++;

                  if (processedCount === totalCount) {
                      setTimeout(function() {
                          console.log('모든 사원 처리 완료 - 강제 정렬 시작');
                          forceSortTableByGrade(tbody);
                      }, 100);
                  }

                  if (applyNo) {
                      loadSavedGeneralData(applyNo, tbody.find('tr:last'), applyType);
                  }

                  // 시간 변경 시 실시간 주 52시간 검증
                  const currentRow = tbody.find('tr:last');
                  currentRow.find('.start-time, .end-time').on('change', function() {
                      calculateRealTimeWeeklyHours(currentRow, emp.empCode);
                  });

                  currentRow.find('.work-select').on('change', function() {
                      validateWorkTimeRestrictions(currentRow);
                  });

                  calculateRealTimeWeeklyHours(currentRow, emp.empCode);

                  // 상태별 버튼 활성화/비활성화
                  updateButtonStates();
              });
          });
      }

      function displayEtcEmployees(employees) {
          const tbody = $('#etcEmployeeBody');
          tbody.empty();

          let processedCount = 0;
          const totalCount = employees.length;

          employees.forEach(function(emp) {
              // 근무정보 조회
              loadWorkInfo(emp.empCode, $('#etcWorkDate').val().replace(/-/g, ''), function(workInfo) {
                  const applyNo = emp.applyEtcNo || '';
                  const status = emp.etcApplyStatus || '대기';

                  let recordDisplay = workInfo.record.shiftName || '-';
                  if (workInfo.appliedRecord && workInfo.appliedRecord.shiftName) {
                      recordDisplay = workInfo.appliedRecord.shiftName;
                  }

                  const workDate = $('#etcWorkDate').val().replace(/-/g, '');
                  const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                  const isFutureDate = workDate > today;

                  let isAbsent = false;
                  if (!isFutureDate) {
                      // 과거/현재 날짜만 결근 체크
                      isAbsent = workInfo.record.shiftCode === '00' || workInfo.record.shiftName === '결근';
                  }

                  const recordColor = isAbsent ? 'text-gray-700' : '';

                  const row = `
                      <tr data-emp-code="${emp.empCode}" data-apply-no="${applyNo}" data-is-absent="${isAbsent}" data-plan="${workInfo.empCalendarPlan || workInfo.plan || ''}" data-record="${recordDisplay}">
                          <td class="border border-gray-300 px-4 py-2">
                              <input type="checkbox" class="emp-checkbox">
                          </td>
                          <td class="border border-gray-300 px-4 py-2">${emp.empCode}</td>
                          <td class="border border-gray-300 px-4 py-2">${emp.empName}</td>
                          <td class="border border-gray-300 px-4 py-2">${emp.positionName || ''}</td>
                          <td class="border border-gray-300 px-4 py-2">${emp.deptName || ''}</td>
                          <td class="border border-gray-300 px-4 py-2">${workInfo.empCalendarPlan || workInfo.plan || ''}</td>
                          <td class="border border-gray-300 px-4 py-2 ${recordColor}">${recordDisplay}</td>
                          <td class="border border-gray-300 px-4 py-2">
                              <select class="shift-select w-full border rounded px-2 py-1" ${isAbsent ? 'disabled' : ''}>
                                  <option value="">선택</option>
                              </select>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <input type="date" class="start-date w-full border rounded px-2 py-1" ${isAbsent ? 'disabled' : ''}>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <input type="date" class="end-date w-full border rounded px-2 py-1" ${isAbsent ? 'disabled' : ''}>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <span class="annual-balance">0.00</span>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <select class="apply-time w-full border rounded px-2 py-1" ${isAbsent ? 'disabled' : ''}>
                                  <option value="1일이전신청">1일이전신청</option>
                                  <option value="당일신청">당일신청</option>
                              </select>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <input type="text" class="reason-field w-full border rounded px-2 py-1" placeholder="사유 입력" ${isAbsent ? 'disabled' : ''}>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <span class="status-field">${status}</span>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <span class="applicant-field">${currentUser.empName}</span>
                          </td>
                      </tr>
                  `;
                  tbody.append(row);

                  processedCount++;

                  if (processedCount === totalCount) {
                      setTimeout(function() {
                          console.log('모든 사원 처리 완료 - 강제 정렬 시작 (기타근태)');
                          forceSortTableByGrade(tbody);
                      }, 100);
                  }

                  const shiftSelect = tbody.find('tr:last .shift-select');
                  shiftMasters.forEach(function(shift) {
                      // 휴일, 휴무일 제외
                      if (shift.shiftCode !== '12' && shift.shiftCode !== '13') {
                          shiftSelect.append(`<option value="${shift.shiftCode}">${shift.shiftName}</option>`);
                      }
                  });

                  const currentRow = tbody.find('tr:last');
                  currentRow.find('.start-date, .end-date').on('change', function() {
                      validateEtcDateRange(currentRow);
                  });

                  loadAnnualBalanceStable(emp.empCode, currentRow);

                  // 기존 신청 데이터가 있으면 복원
                  if (applyNo) {
                      loadSavedEtcData(applyNo, tbody.find('tr:last'));
                  }

                  // 상태별 버튼 활성화/비활성화
                  updateButtonStates();
              });
          });
      }

      function validateEtcDateRange(row) {
          const startDate = row.find('.start-date').val();
          const endDate = row.find('.end-date').val();

          if (!startDate || !endDate) return;

          // 휴일/휴무일 체크를 위한 API 호출
          $.get('/user/apply/validateDateRange', {
              startDate: startDate.replace(/-/g, ''),
              endDate: endDate.replace(/-/g, '')
          })
          .done(function(result) {
              if (!result.valid) {
                  alert('신청 기간에 휴일/휴무일이 포함되어 있습니다. 날짜를 다시 선택해주세요.');
                  row.find('.start-date, .end-date').val('');
              }
          })
          .fail(function() {
              console.warn('날짜 범위 검증 API 호출 실패');
          });
      }

      // 실시간 주 52시간 검증
      function calculateRealTimeWeeklyHours(row, empCode) {
          const applyType = $('#generalApplyType').val();
          const workType = row.find('.work-select').val() || row.find('.work-type-display').text();
          const startTime = row.find('.start-time').val();
          const endTime = row.find('.end-time').val();
          const workDate = $('#generalWorkDate').val().replace(/-/g, '');

          // 조퇴외출반차의 경우 별도 처리
          if (applyType === '조퇴외출반차') {
              if (workType === '전반차' || workType === '후반차') {
                  row.find('.expected-hours').text('-4.00');
              } else if (workType === '조퇴') {
                  // 조퇴 시간 계산
                  if (startTime) {
                      calculateEarlyLeaveHours(empCode, workDate, startTime, function(deductHours) {
                          row.find('.expected-hours').text(`-${deductHours.toFixed(2)}`);
                      });
                  } else {
                      row.find('.expected-hours').text('0.00');
                  }
              } else {
                  row.find('.expected-hours').text('0.00');
              }
              return;
          }

          const isAbsent = row.data('is-absent') === true;
          if (isAbsent) {
              row.find('.expected-hours').text('40.00'); // 주간 예상근로시간 표시
              return;
          }

          // 시간이 입력되지 않은 경우 예상근로시간 업데이트 API 호출
          if (!startTime || !endTime) {
              updateExpectedHours(empCode, workDate, function(expectedHours) {
                  row.find('.expected-hours').text(expectedHours);
                  row.find('.expected-hours').removeClass('text-red-500 font-bold');
                  row.find('.expected-hours').removeAttr('title');
              });
              return;
          }

          // 실시간 주 52시간 검증 API 호출
          $.post('/user/apply/calculateWorkHours', {
              empCode: empCode,
              workDate: workDate,
              startTime: startTime,
              endTime: endTime,
              applyType: workType
          })
          .done(function(response) {
              const expectedHoursSpan = row.find('.expected-hours');
              expectedHoursSpan.text(response.totalWeeklyHours.toFixed(2));

              if (!response.isValid) {
                  expectedHoursSpan.addClass('text-red-500 font-bold');
                  expectedHoursSpan.attr('title', response.message);
              } else {
                  expectedHoursSpan.removeClass('text-red-500 font-bold');
                  expectedHoursSpan.removeAttr('title');
              }
          })
          .fail(function() {
              console.error('실시간 주 52시간 계산 실패');
              row.find('.expected-hours').text('40.00');
          });
      }

      // 조퇴 시간 계산
      function calculateEarlyLeaveHours(empCode, workDate, startTime, callback) {
          // 서버에서 조퇴 시간 계산
          // 임시로 클라이언트에서 계산 (16:20 - 시작시간)
          try {
              const startHour = parseInt(startTime.split(':')[0]);
              const startMin = parseInt(startTime.split(':')[1]);
              const startTotalMin = startHour * 60 + startMin;

              const endTotalMin = 16 * 60 + 20; // 16:20

              if (endTotalMin > startTotalMin) {
                  const diffMin = endTotalMin - startTotalMin;
                  const diffHours = diffMin / 60.0;
                  callback(diffHours);
              } else {
                  callback(0);
              }
          } catch (e) {
              callback(2.0); // 기본 2시간
          }
      }

      // 예상근로시간 실시간 업데이트 API 호출
      function updateExpectedHours(empCode, workDate, callback) {
          $.get(`/user/apply/updateExpectedHours/${empCode}/${workDate}`)
              .done(function(response) {
                  if (response.success) {
                      callback(response.expectedHours);
                  } else {
                      callback('40.00'); // 주간 예상근로시간 기본값
                  }
              })
              .fail(function() {
                  callback('40.00'); // 주간 예상근로시간 기본값
              });
      }

      function loadSavedGeneralData(applyNo, row, currentApplyType) {
          $.get(`/user/apply/general/${applyNo}`)
              .done(function(data) {
                  if (data) {
                      const savedApplyType = data.applyType;
                      const savedApplyCategory = getApplyCategoryFromType(savedApplyType);

                      if (savedApplyCategory === currentApplyType) {
                          // 저장된 데이터로 폼 필드 복원
                          row.find('.work-select').val(data.applyType || '');
                          row.find('.work-type-display').text(data.applyType || '');
                          if (data.startTime) {
                              row.find('.start-time').val(formatTimeDisplay(data.startTime));
                          }
                          if (data.endTime) {
                              row.find('.end-time').val(formatTimeDisplay(data.endTime));
                          }
                          row.find('.reason-field').val(data.reason || '');
                          row.find('.status-field').text(data.status || '대기');

                          // 복원 후 실시간 검증
                          if (data.startTime && data.endTime) {
                              calculateRealTimeWeeklyHours(row, row.data('emp-code'));
                          }
                      } else {
                          row.find('.status-field').text('대기');
                      }
                  }
              })
              .fail(function() {
                  console.log('저장된 일반근태 데이터 없음: ' + applyNo);
              });
      }

      function getApplyCategoryFromType(applyType) {
          if (['조출연장', '연장'].includes(applyType)) {
              return '연장근로';
          } else if (['휴일근무'].includes(applyType)) {
              return '휴일근로';
          } else if (['조퇴', '외근', '외출', '전반차', '후반차'].includes(applyType)) {
              return '조퇴외출반차';
          }
          return '';
      }

      // 저장된 기타근태 데이터 복원 함수
      function loadSavedEtcData(applyNo, row) {
          $.get(`/user/apply/etc/${applyNo}`)
              .done(function(data) {
                  if (data) {
                      // 저장된 데이터로 폼 필드 복원
                      row.find('.shift-select').val(data.shiftCode || '');
                      if (data.targetStartDate) {
                          row.find('.start-date').val(formatDateDisplay(data.targetStartDate));
                      }
                      if (data.targetEndDate) {
                          row.find('.end-date').val(formatDateDisplay(data.targetEndDate));
                      }
                      row.find('.apply-time').val(data.applyDateTime || '1일이전신청');
                      row.find('.reason-field').val(data.reason || '');
                      row.find('.status-field').text(data.status || '대기');
                  }
              })
              .fail(function() {
                  console.log('저장된 기타근태 데이터 없음: ' + applyNo);
              });
      }

      // 시간 포맷 변환 함수 (HHMM -> HH:MM)
      function formatTimeDisplay(timeStr) {
          if (!timeStr || timeStr.length !== 4) return '';
          return timeStr.substring(0, 2) + ':' + timeStr.substring(2, 4);
      }

      // 날짜 포맷 변환 함수 (YYYYMMDD -> YYYY-MM-DD)
      function formatDateDisplay(dateStr) {
          if (!dateStr || dateStr.length !== 8) return '';
          return dateStr.substring(0, 4) + '-' + dateStr.substring(4, 6) + '-' + dateStr.substring(6, 8);
      }

      // 상태별 버튼 활성화/비활성화 함수
      function updateButtonStates() {
          // 선택된 행들의 상태 확인
          const selectedRows = $('.emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              // 선택된 행이 없으면 조회, 저장만 활성화
              $('#saveGeneralBtn, #saveEtcBtn').prop('disabled', false);
              $('#deleteGeneralBtn, #deleteEtcBtn, #submitGeneralBtn, #submitEtcBtn, #cancelGeneralBtn, #cancelEtcBtn').prop('disabled', true);
              return;
          }

          let hasWaiting = false, hasSaved = false, hasSubmitted = false;
          let hasAbsent = false;

          selectedRows.each(function() {
              const status = $(this).find('.status-field').text();
              const isAbsent = $(this).data('is-absent') === true;

              if (status === '대기') hasWaiting = true;
              else if (status === '저장') hasSaved = true;
              else if (status === '상신') hasSubmitted = true;

              if (isAbsent) hasAbsent = true;
          });

          if (hasAbsent) {
              $('#saveGeneralBtn, #saveEtcBtn, #submitGeneralBtn, #submitEtcBtn').prop('disabled', true);
          } else {
              // 대기 상태: 저장만 가능
              // 저장 상태: 삭제, 상신 가능
              // 상신 상태: 상신취소만 가능
              $('#saveGeneralBtn, #saveEtcBtn').prop('disabled', !hasWaiting);
              $('#submitGeneralBtn, #submitEtcBtn').prop('disabled', !hasSaved);
          }

          $('#deleteGeneralBtn, #deleteEtcBtn').prop('disabled', !hasSaved);
          $('#cancelGeneralBtn, #cancelEtcBtn').prop('disabled', !hasSubmitted);
      }

      // 체크박스 변경 시 버튼 상태 업데이트
      $(document).on('change', '.emp-checkbox', updateButtonStates);

      // 근무정보 조회 함수
      function loadWorkInfo(empCode, workDate, callback) {
          $.get(`/user/apply/workInfo/${empCode}/${workDate}`)
              .done(function(workInfo) {
                  callback(workInfo);
              })
              .fail(function() {
                  callback({
                      plan: '',
                      empCalendarPlan: '',
                      record: {checkInTime: '-', checkOutTime: '-', shiftCode: '', shiftName: '-'},
                      appliedRecord: null,
                      expectedHours: '40.00'  // 주간 예상근로시간 기본값
                  });
              });
      }

      function loadAnnualBalanceStable(empCode, row) {
          $.get(`/user/apply/annual/${empCode}`)
              .done(function(annual) {
                  const balanceDay = parseFloat(annual.balanceDay || '0').toFixed(2);
                  row.find('.annual-balance').text(balanceDay);
              })
              .fail(function() {
                  row.find('.annual-balance').text('0.00');
              });
      }

      function loadAnnualBalance(empCode, callback) {
          $.get(`/user/apply/annual/${empCode}`)
              .done(function(annual) {
                  callback(annual);
              })
              .fail(function() {
                  callback({balanceDay: '0'});
              });
      }

      // 일반근태 저장
      function saveGeneralApply() {
          const selectedRows = $('#generalEmployeeTable .emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              alert('저장할 사원을 선택해주세요.');
              return;
          }

          const absentRows = selectedRows.filter(function() {
              return $(this).data('is-absent') === true;
          });

          if (absentRows.length > 0) {
              alert('실적이 결근일 경우 신청할 수 없습니다.');
              return;
          }

          let hasError = false;

          selectedRows.each(function() {
              if (hasError) return false;

              const row = $(this);
              const empCode = row.data('emp-code');
              const workSelect = row.find('.work-select').val() || row.find('.work-type-display').text();
              const startTime = row.find('.start-time').val().replace(':', '');
              const endTime = row.find('.end-time').val().replace(':', '');
              const reason = row.find('.reason-field').val();
              const planShift = row.data('plan');
              const recordShift = row.data('record');

              const applyType = $('#generalApplyType').val();

              // 연장근로 검증
              if (workSelect === '연장' || workSelect === '조출연장') {
                  // 실적이 결근일 경우 신청 불가
                  if (recordShift === '결근') {
                      alert(`${row.find('td:eq(2)').text()} 사원: 실적이 결근일 경우 연장근무를 신청할 수 없습니다.`);
                      hasError = true;
                      return false;
                  }

                  // 시간 검증
                  if (startTime && endTime) {
                      const startTimeInt = parseInt(startTime);
                      const endTimeInt = parseInt(endTime);

                      if (startTimeInt >= endTimeInt) {
                          alert(`${row.find('td:eq(2)').text()} 사원: 시작시간이 종료시간보다 늦을 수 없습니다.`);
                          hasError = true;
                          return false;
                      }

                      if (workSelect === '연장') {
                          if (startTimeInt < 1620) {
                              alert(`${row.find('td:eq(2)').text()} 사원: 정상근무시간(16:20) 이후에만 연장근무를 신청할 수 있습니다.`);
                              hasError = true;
                              return false;
                          }
                      } else if (workSelect === '조출연장') {
                          if (startTimeInt >= 730) {
                              alert(`${row.find('td:eq(2)').text()} 사원: 정상근무시간(07:30) 이전에만 조출연장을 신청할 수 있습니다.`);
                              hasError = true;
                              return false;
                          }
                      }
                  }
              }

              // 휴일근로 검증
              if (workSelect === '휴일근무') {
                  // 휴일 또는 휴무일에만 신청 가능
                  if (planShift !== '휴일' && planShift !== '휴무일') {
                      alert(`${row.find('td:eq(2)').text()} 사원: 휴일근로는 휴일 또는 휴무일에만 신청할 수 있습니다.`);
                      hasError = true;
                      return false;
                  }

                  // 연차, 휴가, 결근 등의 날은 신청 불가
                  if (['연차', '휴가', '결근'].includes(recordShift)) {
                      alert(`${row.find('td:eq(2)').text()} 사원: 연차, 휴가, 결근 등의 날에는 휴일근로를 신청할 수 없습니다.`);
                      hasError = true;
                      return false;
                  }
              }

              // 조퇴/외출/반차 검증 (일반근태)
              if (['조퇴', '외근', '외출', '전반차', '후반차'].includes(workSelect)) {
                  // 정상 근무가 아닌 경우 신청 불가
                  if (['결근', '연차', '휴가', '휴일', '휴직'].includes(recordShift)) {
                      alert(`${row.find('td:eq(2)').text()} 사원: 정상 근무가 아닌 경우에는 ${workSelect}을(를) 신청할 수 없습니다.`);
                      hasError = true;
                      return false;
                  }
              }

              // 조퇴/외출/반차가 아닌 경우 주 52시간 검증
              if (applyType !== '조퇴외출반차') {
                  const expectedHoursSpan = row.find('.expected-hours');
                  if (expectedHoursSpan.hasClass('text-red-500')) {
                      alert(`${row.find('td:eq(2)').text()} 사원: 주 52시간을 초과할 수 없습니다.`);
                      hasError = true;
                      return false;
                  }
              }

              if (!hasError) {
                  const data = {
                      empCode: empCode,
                      timeItemCode: 'T001',
                      targetDate: $('#generalWorkDate').val().replace(/-/g, ''),
                      startTime: startTime,
                      endTime: endTime,
                      applyType: workSelect,
                      reason: reason
                  };

                  $.ajax({
                      url: '/user/apply/general',
                      method: 'POST',
                      contentType: 'application/json',
                      data: JSON.stringify(data),
                      success: function(response) {
                          if (response.result === 'success') {
                              row.find('.status-field').text('저장');
                              row.attr('data-apply-no', response.data.applyGeneralNo);
                              alert('저장되었습니다.');
                              updateButtonStates();

                              if (workSelect === '휴일근무') {
                                  setTimeout(function() {
                                      loadWorkInfo(empCode, $('#generalWorkDate').val().replace(/-/g, ''), function(updatedWorkInfo) {
                                          if (updatedWorkInfo.appliedRecord && updatedWorkInfo.appliedRecord.shiftName) {
                                              row.find('td:eq(6)').text(updatedWorkInfo.appliedRecord.shiftName);
                                          }
                                      });
                                  }, 500);
                              }
                          } else {
                              alert('저장 실패: ' + response.message);
                          }
                      },
                      error: function() {
                          alert('저장에 실패했습니다.');
                      }
                  });
              }
          });
      }

      // 기타근태 저장
      function saveEtcApply() {
          const selectedRows = $('#etcEmployeeTable .emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              alert('저장할 사원을 선택해주세요.');
              return;
          }

          const absentRows = selectedRows.filter(function() {
              return $(this).data('is-absent') === true;
          });

          if (absentRows.length > 0) {
              alert('결근 사원은 근태 신청을 할 수 없습니다.');
              return;
          }

          selectedRows.each(function() {
              const row = $(this);
              const empCode = row.data('emp-code');
              const shiftCode = row.find('.shift-select').val();
              const startDate = row.find('.start-date').val().replace(/-/g, '');
              const endDate = row.find('.end-date').val().replace(/-/g, '');
              const applyDateTime = row.find('.apply-time').val();
              const reason = row.find('.reason-field').val();

              if (!shiftCode || !startDate || !endDate) {
                  alert('필수 항목을 모두 입력해주세요.');
                  return;
              }

              // 연차 사용 시 잔여 연차 확인
              const selectedShift = shiftMasters.find(shift => shift.shiftCode === shiftCode);
              if (selectedShift && (selectedShift.shiftName.includes('연차') || selectedShift.shiftName.includes('휴가'))) {
                  const currentBalance = parseFloat(row.find('.annual-balance').text());
                  const requestDays = calculateRequestDays(startDate, endDate);

                  if (currentBalance < requestDays) {
                      alert(`연차 잔여일수가 부족합니다. (필요: ${requestDays}일, 잔여: ${currentBalance}일)`);
                      return;
                  }
              }

              const data = {
                  empCode: empCode,
                  shiftCode: shiftCode,
                  targetStartDate: startDate,
                  targetEndDate: endDate,
                  applyDateTime: applyDateTime,
                  reason: reason
              };

              $.ajax({
                  url: '/user/apply/etc',
                  method: 'POST',
                  contentType: 'application/json',
                  data: JSON.stringify(data),
                  success: function(response) {
                      if (response.result === 'success') {
                          row.find('.status-field').text('저장');
                          row.attr('data-apply-no', response.data.applyEtcNo);
                          alert('저장되었습니다.');
                          updateButtonStates();

                          setTimeout(function() {
                              loadWorkInfo(empCode, $('#etcWorkDate').val().replace(/-/g, ''), function(updatedWorkInfo) {
                                  if (updatedWorkInfo.appliedRecord && updatedWorkInfo.appliedRecord.shiftName) {
                                      row.find('td:eq(6)').text(updatedWorkInfo.appliedRecord.shiftName);
                                  }
                              });
                          }, 500);
                      } else {
                          alert('저장 실패: ' + response.message);
                      }
                  },
                  error: function() {
                      alert('저장에 실패했습니다.');
                  }
              });
          });
      }

      // 신청 일수 계산 함수
      function calculateRequestDays(startDate, endDate) {
          const start = new Date(startDate.substring(0,4), startDate.substring(4,6)-1, startDate.substring(6,8));
          const end = new Date(endDate.substring(0,4), endDate.substring(4,6)-1, endDate.substring(6,8));
          const diffTime = Math.abs(end - start);
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
          return diffDays;
      }

      // 나머지 CRUD 함수들은 기존 코드와 동일하게 유지...
      // (deleteGeneralApply, deleteEtcApply, submitGeneralApply, submitEtcApply, cancelGeneralApply, cancelEtcApply)

      // 일반근태 삭제
      function deleteGeneralApply() {
          const selectedRows = $('#generalEmployeeTable .emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              alert('삭제할 사원을 선택해주세요.');
              return;
          }

          if (!confirm('선택된 신청을 삭제하시겠습니까?')) {
              return;
          }

          selectedRows.each(function() {
              const row = $(this);
              const applyNo = row.data('apply-no');

              if (!applyNo) {
                  alert('삭제할 신청이 없습니다.');
                  return;
              }

              $.ajax({
                  url: '/user/apply/delete/general',
                  method: 'POST',
                  data: { applyGeneralNo: applyNo },
                  success: function(response) {
                      if (response === 'success') {
                          alert('삭제되었습니다.');
                          searchGeneralEmployees();
                      } else {
                          alert('삭제 실패: ' + response);
                      }
                  },
                  error: function() {
                      alert('삭제에 실패했습니다.');
                  }
              });
          });
      }

      // 기타근태 삭제
      function deleteEtcApply() {
          const selectedRows = $('#etcEmployeeTable .emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              alert('삭제할 사원을 선택해주세요.');
              return;
          }

          if (!confirm('선택된 신청을 삭제하시겠습니까?')) {
              return;
          }

          selectedRows.each(function() {
              const row = $(this);
              const applyNo = row.data('apply-no');

              if (!applyNo) {
                  alert('삭제할 신청이 없습니다.');
                  return;
              }

              $.ajax({
                  url: '/user/apply/delete/etc',
                  method: 'POST',
                  data: { applyEtcNo: applyNo },
                  success: function(response) {
                      if (response === 'success') {
                          alert('삭제되었습니다.');
                          searchEtcEmployees();
                      } else {
                          alert('삭제 실패: ' + response);
                      }
                  },
                  error: function() {
                      alert('삭제에 실패했습니다.');
                  }
              });
          });
      }

      // 일반근태 상신
      function submitGeneralApply() {
          const selectedRows = $('#generalEmployeeTable .emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              alert('상신할 사원을 선택해주세요.');
              return;
          }

          const absentRows = selectedRows.filter(function() {
              return $(this).data('is-absent') === true;
          });

          if (absentRows.length > 0) {
              alert('실적이 결근일 경우 신청할 수 없습니다.');
              return;
          }

          const invalidRows = selectedRows.filter(function() {
              const expectedHoursSpan = $(this).find('.expected-hours');
              return expectedHoursSpan.hasClass('text-red-500');
          });

          if (invalidRows.length > 0) {
              alert('주 52시간을 초과하는 사원이 있습니다. 상신할 수 없습니다.');
              return;
          }

          selectedRows.each(function() {
              const row = $(this);
              const applyNo = row.data('apply-no');

              if (!applyNo) {
                  alert('상신할 신청이 없습니다.');
                  return;
              }

              $.ajax({
                  url: '/user/apply/submit/general',
                  method: 'POST',
                  data: {
                      applyGeneralNo: applyNo,
                      isHeader: currentUser.isHeader
                  },
                  success: function(response) {
                      if (response === 'success') {
                          const finalStatus = currentUser.isHeader === 'Y' ? '승인완료' : '상신';
                          row.find('.status-field').text(finalStatus);
                          alert(currentUser.isHeader === 'Y' ? '자동 승인완료되었습니다.' : '상신되었습니다.');
                          updateButtonStates();
                      } else {
                          alert('상신 실패: ' + response);
                      }
                  },
                  error: function() {
                      alert('상신에 실패했습니다.');
                  }
              });
          });
      }

      // 기타근태 상신
      function submitEtcApply() {
          const selectedRows = $('#etcEmployeeTable .emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              alert('상신할 사원을 선택해주세요.');
              return;
          }

          const absentRows = selectedRows.filter(function() {
              return $(this).data('is-absent') === true;
          });

          if (absentRows.length > 0) {
              alert('결근 사원은 근태 신청을 할 수 없습니다.');
              return;
          }

          selectedRows.each(function() {
              const row = $(this);
              const applyNo = row.data('apply-no');

              if (!applyNo) {
                  alert('상신할 신청이 없습니다.');
                  return;
              }

              $.ajax({
                  url: '/user/apply/submit/etc',
                  method: 'POST',
                  data: {
                      applyEtcNo: applyNo,
                      isHeader: currentUser.isHeader
                  },
                  success: function(response) {
                      if (response === 'success') {
                          const finalStatus = currentUser.isHeader === 'Y' ? '승인완료' : '상신';
                          row.find('.status-field').text(finalStatus);

                          if (finalStatus === '승인완료') {
                              const shiftCode = row.find('.shift-select').val();
                              const selectedShift = shiftMasters.find(shift => shift.shiftCode === shiftCode);
                              if (selectedShift && (selectedShift.shiftName.includes('연차') || selectedShift.shiftName.includes('반차'))) {
                                  const startDate = row.find('.start-date').val().replace(/-/g, '');
                                  const endDate = row.find('.end-date').val().replace(/-/g, '');
                                  let requestDays = calculateRequestDays(startDate, endDate);

                                  if (selectedShift.shiftName.includes('반차')) {
                                      requestDays = 0.5;
                                  }

                                  const currentBalance = parseFloat(row.find('.annual-balance').text());
                                  const newBalance = Math.max(0, currentBalance - requestDays);
                                  row.find('.annual-balance').text(newBalance.toFixed(2));
                              }
                          }

                          alert(currentUser.isHeader === 'Y' ? '자동 승인완료되었습니다.' : '상신되었습니다.');
                          updateButtonStates();
                      } else {
                          alert('상신 실패: ' + response);
                      }
                  },
                  error: function() {
                      alert('상신에 실패했습니다.');
                  }
              });
          });
      }

      // 일반근태 상신취소
      function cancelGeneralApply() {
          const selectedRows = $('#generalEmployeeTable .emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              alert('상신취소할 사원을 선택해주세요.');
              return;
          }

          selectedRows.each(function() {
              const row = $(this);
              const applyNo = row.data('apply-no');

              if (!applyNo) {
                  alert('상신취소할 신청이 없습니다.');
                  return;
              }

              $.ajax({
                  url: '/user/apply/cancel/general',
                  method: 'POST',
                  data: { applyGeneralNo: applyNo },
                  success: function(response) {
                      if (response === 'success') {
                          row.find('.status-field').text('저장');
                          alert('상신취소되었습니다.');
                          updateButtonStates();
                      } else {
                          alert('상신취소 실패: ' + response);
                      }
                  },
                  error: function() {
                      alert('상신취소에 실패했습니다.');
                  }
              });
          });
      }

      // 기타근태 상신취소
      function cancelEtcApply() {
          const selectedRows = $('#etcEmployeeTable .emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              alert('상신취소할 사원을 선택해주세요.');
              return;
          }

          selectedRows.each(function() {
              const row = $(this);
              const applyNo = row.data('apply-no');

              if (!applyNo) {
                  alert('상신취소할 신청이 없습니다.');
                  return;
              }

              $.ajax({
                  url: '/user/apply/cancel/etc',
                  method: 'POST',
                  data: { applyEtcNo: applyNo },
                  success: function(response) {
                      if (response === 'success') {
                          row.find('.status-field').text('저장');
                          const shiftCode = row.find('.shift-select').val();
                          const selectedShift = shiftMasters.find(shift => shift.shiftCode === shiftCode);
                          if (selectedShift && (selectedShift.shiftName.includes('연차') || selectedShift.shiftName.includes('반차'))) {
                              const startDate = row.find('.start-date').val().replace(/-/g, '');
                              const endDate = row.find('.end-date').val().replace(/-/g, '');
                              let requestDays = calculateRequestDays(startDate, endDate);

                              if (selectedShift.shiftName.includes('반차')) {
                                  requestDays = 0.5;
                              }

                              const currentBalance = parseFloat(row.find('.annual-balance').text());
                              const newBalance = currentBalance + requestDays;
                              row.find('.annual-balance').text(newBalance.toFixed(2));
                          }

                          alert('상신취소되었습니다.');
                          updateButtonStates();
                      } else {
                          alert('상신취소 실패: ' + response);
                      }
                  },
                  error: function() {
                      alert('상신취소에 실패했습니다.');
                  }
              });
          });
      }
  });
</script>

<script>
  // URL에서 특정 쿼리 파라미터 값을 읽는 함수 (한 줄 버전)
  const getQueryParam = param => new URLSearchParams(window.location.search).get(param);

  function selectOptionByValue(selectId, value) {
    const select = document.getElementById(selectId);
    if (!select) return;
    const option = Array.from(select.options).find(opt => opt.value === value);
    if (option) option.selected = true;
  }

  document.addEventListener("DOMContentLoaded", () => {
    const deptCode = getQueryParam("deptCode");
    if (!deptCode) return;

    ["generalDeptSelect", "etcDeptSelect"].forEach(id => selectOptionByValue(id, deptCode));
  });
</script>

</body>
</html>
