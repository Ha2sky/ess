<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ê·¼íƒœ ì‹ ì²­</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-gray-100 p-6">

<div class="max-w-full mx-auto bg-white rounded shadow">
  <!-- í—¤ë” -->
  <div class="bg-blue-600 text-white p-4 rounded-t">
    <h1 class="text-2xl font-bold">ê·¼íƒœ ì‹ ì²­</h1>
    <p>í˜„ì¬ ì‚¬ìš©ì:
      <span th:text="${currentEmp?.empName} ?: 'ì •ë³´ì—†ìŒ'"></span>
      (<span th:text="${currentEmp?.empCode} ?: 'N/A'"></span>)
      <!-- ë¶€ì„œì¥ ì—¬ë¶€ í‘œì‹œ -->
      <span th:if="${currentEmp?.isHeader == 'Y'}" class="bg-yellow-500 text-black px-2 py-1 rounded text-sm ml-2">ë¶€ì„œì¥</span>
    </p>
  </div>

  <!-- íƒ­ ë©”ë‰´ -->
  <div class="border-b border-gray-200">
    <nav class="flex space-x-8">
      <button id="generalTab" class="tab-button active bg-blue-500 text-white px-4 py-2 rounded-t">
        ì¼ë°˜ê·¼íƒœ ì‹ ì²­
      </button>
      <button id="etcTab" class="tab-button bg-gray-300 text-gray-700 px-4 py-2 rounded-t">
        ê¸°íƒ€ê·¼íƒœ ì‹ ì²­
      </button>
    </nav>
  </div>

  <!-- ì¼ë°˜ê·¼íƒœ ì‹ ì²­ íƒ­ -->
  <div id="generalPanel" class="tab-panel p-6">
    <h2 class="text-xl font-semibold mb-4">ì¼ë°˜ê·¼íƒœ ì‹ ì²­ (ì—°ì¥, íœ´ì¼ê·¼ë¡œ, ì¡°í‡´/ì™¸ì¶œ/ë°˜ì°¨)</h2>

    <!-- ê²€ìƒ‰ ì¡°ê±´ -->
    <div class="bg-gray-50 p-4 rounded mb-6">
      <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">ê·¼íƒœì‹ ì²­ì¢…ë¥˜</label>
          <select id="generalApplyType" class="mt-1 block w-full border border-gray-300 rounded p-2">
            <option value="ì—°ì¥ê·¼ë¡œ">ì—°ì¥ê·¼ë¡œ</option>
            <option value="íœ´ì¼ê·¼ë¡œ">íœ´ì¼ê·¼ë¡œ</option>
            <option value="ì¡°í‡´ì™¸ì¶œë°˜ì°¨">ì¡°í‡´/ì™¸ì¶œ/ë°˜ì°¨</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">ì‹ ì²­ê·¼ë¬´</label>
          <select id="generalWorkTypeFilter" class="mt-1 block w-full border border-gray-300 rounded p-2">
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">ê·¼ë¬´ì¼</label>
          <input type="date" id="generalWorkDate" class="mt-1 block w-full border border-gray-300 rounded p-2"
                 th:value="${today}">
        </div>
        <!-- ë¶€ì„œ ë“œë¡­ë‹¤ìš´ -->
        <div>
          <label class="block text-sm font-medium text-gray-700">ë¶€ì„œ</label>
          <select id="generalDeptSelect" class="mt-1 block w-full border border-gray-300 rounded p-2">
            <option th:value="${currentEmp.deptCode}" th:text="${currentEmp.deptName}" selected></option>
            <!-- ë¶€ì„œì¥ì¸ ê²½ìš° í•˜ìœ„ë¶€ì„œ ì˜µì…˜ ë™ì  ë¡œë“œ -->
            <option th:each="dept : ${availableDepartments}"
                    th:if="${dept.deptCode != currentEmp.deptCode}"
                    th:value="${dept.deptCode}"
                    th:text="${dept.deptName}"
            ></option>
          </select>
        </div>
        <div class="flex items-end space-x-2 col-span-2">
          <button id="searchGeneralBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
            ì¡°íšŒ
          </button>
          <button id="saveGeneralBtn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
            ì €ì¥
          </button>
          <button id="deleteGeneralBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
            ì‚­ì œ
          </button>
          <button id="submitGeneralBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
            ìƒì‹ 
          </button>
          <button id="cancelGeneralBtn" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
            ìƒì‹ ì·¨ì†Œ
          </button>
        </div>
      </div>
    </div>

    <!-- ì‚¬ì› ëª©ë¡ í…Œì´ë¸” -->
    <div class="overflow-x-auto mb-6">
      <table id="generalEmployeeTable" class="min-w-full border-collapse border border-gray-300">
        <thead class="bg-gray-100">
        <tr>
          <th class="border border-gray-300 px-4 py-2">
            <input type="checkbox" id="selectAllGeneral"> ì„ íƒ
          </th>
          <th class="border border-gray-300 px-4 py-2">ì‚¬ë²ˆ</th>
          <th class="border border-gray-300 px-4 py-2">ì„±ëª…</th>
          <th class="border border-gray-300 px-4 py-2">ì§ìœ„</th>
          <th class="border border-gray-300 px-4 py-2">ë¶€ì„œ</th>
          <th class="border border-gray-300 px-4 py-2">ê³„íš</th>
          <th class="border border-gray-300 px-4 py-2">ì‹¤ì </th>
          <th class="border border-gray-300 px-4 py-2">ì‹ ì²­ê·¼ë¬´</th>
          <th class="border border-gray-300 px-4 py-2">ì‹œì‘ì‹œê°„</th>
          <th class="border border-gray-300 px-4 py-2">ì¢…ë£Œì‹œê°„</th>
          <th class="border border-gray-300 px-4 py-2">ì˜ˆìƒê·¼ë¡œì‹œê°„</th>
          <th class="border border-gray-300 px-4 py-2">ì‚¬ìœ </th>
          <th class="border border-gray-300 px-4 py-2">ìƒíƒœ</th>
          <th class="border border-gray-300 px-4 py-2">ìƒì‹ ì</th>
        </tr>
        </thead>
        <tbody id="generalEmployeeBody">
        <!-- ë™ì ìœ¼ë¡œ ë¡œë“œë  ì‚¬ì› ëª©ë¡ -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- ê¸°íƒ€ê·¼íƒœ ì‹ ì²­ íƒ­ -->
  <div id="etcPanel" class="tab-panel p-6 hidden">
    <h2 class="text-xl font-semibold mb-4">ê¸°íƒ€ê·¼íƒœ ì‹ ì²­ (ê·¼íƒœ ë³€ê²½)</h2>

    <!-- ê²€ìƒ‰ ì¡°ê±´ -->
    <div class="bg-gray-50 p-4 rounded mb-6">
      <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">ê·¼ë¬´ì¼</label>
          <input type="date" id="etcWorkDate" class="mt-1 block w-full border border-gray-300 rounded p-2"
                 th:value="${today}">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">ê·¼ë¬´ê³„íš</label>
          <select id="etcWorkPlan" class="mt-1 block w-full border border-gray-300 rounded p-2">
            <option value="">ì „ì²´</option>
            <option value="ì£¼ê°„">ì£¼ê°„</option>
            <option value="íœ´ì¼">íœ´ì¼</option>
            <option value="íœ´ë¬´ì¼">íœ´ë¬´ì¼</option>
          </select>
        </div>
        <!-- ë¶€ì„œ ë“œë¡­ë‹¤ìš´ -->
        <div>
          <label class="block text-sm font-medium text-gray-700">ë¶€ì„œ</label>
          <select id="etcDeptSelect" class="mt-1 block w-full border border-gray-300 rounded p-2">
            <option th:value="${currentEmp.deptCode}" th:text="${currentEmp.deptName}" selected></option>
            <!-- ë¶€ì„œì¥ì¸ ê²½ìš° í•˜ìœ„ë¶€ì„œ ì˜µì…˜ ë™ì  ë¡œë“œ -->
            <option th:each="dept : ${availableDepartments}"
                    th:if="${dept.deptCode != currentEmp.deptCode}"
                    th:value="${dept.deptCode}"
                    th:text="${dept.deptName}"></option>
          </select>
        </div>
        <div class="flex items-end space-x-2 col-span-3">
          <button id="searchEtcBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
            ì¡°íšŒ
          </button>
          <button id="saveEtcBtn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
            ì €ì¥
          </button>
          <button id="deleteEtcBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
            ì‚­ì œ
          </button>
          <button id="submitEtcBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
            ìƒì‹ 
          </button>
          <button id="cancelEtcBtn" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
            ìƒì‹ ì·¨ì†Œ
          </button>
        </div>
      </div>
    </div>

    <!-- ì‚¬ì› ëª©ë¡ í…Œì´ë¸” -->
    <div class="overflow-x-auto mb-6">
      <table id="etcEmployeeTable" class="min-w-full border-collapse border border-gray-300">
        <thead class="bg-gray-100">
        <tr>
          <th class="border border-gray-300 px-4 py-2">
            <input type="checkbox" id="selectAllEtc"> ì„ íƒ
          </th>
          <th class="border border-gray-300 px-4 py-2">ì‚¬ë²ˆ</th>
          <th class="border border-gray-300 px-4 py-2">ì„±ëª…</th>
          <th class="border border-gray-300 px-4 py-2">ì§ìœ„</th>
          <th class="border border-gray-300 px-4 py-2">ë¶€ì„œ</th>
          <th class="border border-gray-300 px-4 py-2">ê³„íš</th>
          <th class="border border-gray-300 px-4 py-2">ì‹¤ì </th>
          <th class="border border-gray-300 px-4 py-2">ë³€ê²½ê·¼ë¬´</th>
          <th class="border border-gray-300 px-4 py-2">ì‹œì‘ì¼</th>
          <th class="border border-gray-300 px-4 py-2">ì¢…ë£Œì¼</th>
          <th class="border border-gray-300 px-4 py-2">ì—°ì°¨ì”ì—¬</th>
          <th class="border border-gray-300 px-4 py-2">ì‹ ì²­ì‹œê°</th>
          <th class="border border-gray-300 px-4 py-2">ì‚¬ìœ </th>
          <th class="border border-gray-300 px-4 py-2">ìƒíƒœ</th>
          <th class="border border-gray-300 px-4 py-2">ìƒì‹ ì</th>
        </tr>
        </thead>
        <tbody id="etcEmployeeBody">
        <!-- ë™ì ìœ¼ë¡œ ë¡œë“œë  ì‚¬ì› ëª©ë¡ -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  $.ajaxSetup({cache: false});

  $(document).ready(function() {
      // ì „ì—­ ë³€ìˆ˜ì— í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ì €ì¥
      const currentUser = {
          empCode: '[[${currentEmp.empCode}]]',
          empName: '[[${currentEmp.empName}]]',
          isHeader: '[[${currentEmp.isHeader}]]',
          deptCode: '[[${currentEmp.deptCode}]]'
      };

      // ì—°ì°¨ì”ì—¬ ì •ë³´ ì €ì¥
      const currentAnnual = {
          balanceDay: '[[${annualDetail?.balanceDay} ?: 0]]'
      };

      let shiftMasters = [];
      let isEtcSearching = false;
      let isGeneralSearching = false;

      window.activeCalculations = {};

      // ì‹ ì²­ê·¼ë¬´ ì˜µì…˜ ì •ì˜
      const workTypeOptions = {
          'ì—°ì¥ê·¼ë¡œ': [
              { value: 'ì—°ì¥', text: 'ì—°ì¥' },
              { value: 'ì¡°ì¶œì—°ì¥', text: 'ì¡°ì¶œì—°ì¥' }
          ],
          'íœ´ì¼ê·¼ë¡œ': [
              { value: 'íœ´ì¼ê·¼ë¬´', text: 'íœ´ì¼ê·¼ë¬´' }
          ],
          'ì¡°í‡´ì™¸ì¶œë°˜ì°¨': [
              { value: 'ì¡°í‡´', text: 'ì¡°í‡´' },
              { value: 'ì™¸ê·¼', text: 'ì™¸ê·¼' },
              { value: 'ì™¸ì¶œ', text: 'ì™¸ì¶œ' },
              { value: 'ì „ë°˜ì°¨', text: 'ì „ë°˜ì°¨' },
              { value: 'í›„ë°˜ì°¨', text: 'í›„ë°˜ì°¨' }
          ]
      };

      // íƒ­ ì „í™˜ ê¸°ëŠ¥
      $('.tab-button').click(function() {
          $('.tab-button').removeClass('active bg-blue-500 text-white').addClass('bg-gray-300 text-gray-700');
          $(this).removeClass('bg-gray-300 text-gray-700').addClass('active bg-blue-500 text-white');

          $('.tab-panel').addClass('hidden');

          if (this.id === 'generalTab') {
              $('#generalPanel').removeClass('hidden');
              // ì¼ë°˜ê·¼íƒœíƒ­ ì´ë™ ì‹œ ì˜ˆìƒê·¼ë¡œì‹œê°„ ìƒˆë¡œê³ ì¹¨
              setTimeout(function() {
                  if (currentUser.deptCode && $('#generalWorkDate').val()) {
                      searchGeneralEmployees();
                  }
              }, 100);
          } else {
              $('#etcPanel').removeClass('hidden');
              // ê¸°íƒ€ê·¼íƒœíƒ­ ì´ë™ ì‹œ ìë™ ì¡°íšŒ
              setTimeout(function() {
                  if (currentUser.deptCode && $('#etcWorkDate').val()) {
                      searchEtcEmployees();
                  }
              }, 100);
          }
      });


      // URL ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ì—ì„œ 'tab' ê°’ ì½ê¸°
      function getQueryParam(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ íƒ­ í™œì„±í™” ì²˜ë¦¬
      const activeTab = getQueryParam('tab');
      if (activeTab === 'etc') {
        // ê¸°íƒ€ê·¼íƒœì‹ ì²­ íƒ­ í™œì„±í™”
        $('#etcTab').click();
      } else {
        // ê¸°ë³¸ê°’ì€ ì¼ë°˜ê·¼íƒœ ì‹ ì²­ íƒ­ í™œì„±í™”
        $('#generalTab').click();
      }

      // ê·¼íƒœ ë§ˆìŠ¤í„° ë¡œë“œ
      loadShiftMasters();

      updateWorkTypeFilter('ì—°ì¥ê·¼ë¡œ');

      // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
      setTimeout(function() {
          if (currentUser.deptCode && $('#generalWorkDate').val()) {
              searchGeneralEmployees();
          } else {
              console.warn('ë¶€ì„œì½”ë“œ ë˜ëŠ” ë‚ ì§œê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ');
              if (!$('#generalDeptSelect').val() && currentUser.deptCode) {
                  $('#generalDeptSelect').val(currentUser.deptCode);
              }
              if ($('#generalWorkDate').val()) {
                  searchGeneralEmployees();
              }
          }
      }, 100);

      // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
      $('#searchGeneralBtn').click(searchGeneralEmployees);
      $('#searchEtcBtn').click(searchEtcEmployees);
      $('#saveGeneralBtn').click(saveGeneralApply);
      $('#saveEtcBtn').click(saveEtcApply);
      $('#deleteGeneralBtn').click(deleteGeneralApply);
      $('#deleteEtcBtn').click(deleteEtcApply);
      $('#submitGeneralBtn').click(submitGeneralApply);
      $('#submitEtcBtn').click(submitEtcApply);
      $('#cancelGeneralBtn').click(cancelGeneralApply);
      $('#cancelEtcBtn').click(cancelEtcApply);

      $('#generalApplyType').change(function() {
          const selectedType = $(this).val();

          $('#generalEmployeeBody').empty();

          updateWorkTypeOptions(selectedType);
          updateWorkTypeFilter(selectedType);

          const isLeaveType = selectedType === 'ì¡°í‡´ì™¸ì¶œë°˜ì°¨';

          // í…Œì´ë¸” ë°ì´í„° ì…€ ìˆ¨ê¸°ê¸°/ë³´ì´ê¸°
          $('#generalEmployeeTable .expected-hours').closest('td').toggleClass('hidden', isLeaveType);
          // í…Œì´ë¸” í—¤ë” ìˆ¨ê¸°ê¸°/ë³´ì´ê¸°
          $('#generalEmployeeTable thead th:eq(10)').toggleClass('hidden', isLeaveType);

          setTimeout(function() {
              searchGeneralEmployees();
          }, 100);
      });

      $('#generalWorkTypeFilter').change(function() {
          const selectedWorkType = $(this).val();
          if (selectedWorkType) {
              handleWorkTypeChangeUltraComplete(selectedWorkType);
          }
          updateEmployeeWorkTypes(selectedWorkType);
      });

      // ê·¼íƒœ ë§ˆìŠ¤í„° ë¡œë“œ í•¨ìˆ˜
      function loadShiftMasters() {
          $.get('/user/apply/shift-masters')
              .done(function(data) {
                  shiftMasters = data;
              })
              .fail(function() {
                  console.error('ê·¼íƒœ ë§ˆìŠ¤í„° ë¡œë“œ ì‹¤íŒ¨');
              });
      }

      // ì‹ ì²­ê·¼ë¬´ ì˜µì…˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
      function updateWorkTypeOptions(applyType) {
          const options = workTypeOptions[applyType] || [];

          // ëª¨ë“  ì‹ ì²­ê·¼ë¬´ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
          $('#generalEmployeeTable .work-select').each(function() {
              const currentValue = $(this).val();
              $(this).empty();

              options.forEach(function(option) {
                  $(this).append(`<option value="${option.value}">${option.text}</option>`);
              }.bind(this));

              // ì´ì „ ì„ íƒê°’ì´ ìƒˆ ì˜µì…˜ì— ìˆìœ¼ë©´ ìœ ì§€
              if (options.some(opt => opt.value === currentValue)) {
                  $(this).val(currentValue);
              }
          });
      }

      function updateWorkTypeFilter(applyType) {
          const options = workTypeOptions[applyType] || [];
          const filterSelect = $('#generalWorkTypeFilter');
          const currentValue = filterSelect.val();

          filterSelect.empty();

          if (currentUser.isHeader !== 'Y') {
              filterSelect.append('<option value="">ì „ì²´</option>');
          }

          options.forEach(function(option) {
              filterSelect.append(`<option value="${option.value}">${option.text}</option>`);
          });

          if (options.length > 0 && (!currentValue || !options.some(opt => opt.value === currentValue))) {
              filterSelect.val(options[0].value);
          } else if (options.some(opt => opt.value === currentValue)) {
              filterSelect.val(currentValue);
          }
      }

      function updateEmployeeWorkTypes(selectedWorkType) {
          if (!selectedWorkType) return;

          $('#generalEmployeeTable tbody tr').each(function() {
              const workSelect = $(this).find('.work-select');
              if (workSelect.length > 0) {
                  workSelect.val(selectedWorkType);
                  validateWorkTimeRestrictionsUltimate($(this));
              }
          });
      }

      function handleWorkTypeChangeUltraComplete(selectedWorkType) {
          console.log('ì‹ ì²­ê·¼ë¬´ ë³€ê²½:', selectedWorkType);

          $('#generalEmployeeTable tbody tr').each(function() {
              const row = $(this);
              const empCode = row.data('emp-code');
              const workDate = $('#generalWorkDate').val().replace(/-/g, '');

              // ğŸ”¥ ëª¨ë“  ì‹ ì²­ê·¼ë¬´ íƒ€ì…ì— ëŒ€í•´ ë™ì¼í•œ ë¡œì§ ì‚¬ìš© (íƒ€ì…ë³„ ê°œë³„ ì‹ ì²­ ê°€ëŠ¥)
              loadApplyByTypeUltraComplete(empCode, workDate, selectedWorkType, row);
          });
      }

      function loadApplyByTypeUltraComplete(empCode, workDate, applyType, row) {
          console.log('ì‹ ì²­ê·¼ë¬´ë³„ ê¸°ì¡´ ì‹ ì²­ ì¡°íšŒ:', empCode, workDate, applyType);

          $.get(`/user/apply/getApplyByWorkType/${empCode}/${workDate}/${applyType}`)
              .done(function(response) {
                  console.log('ì‹ ì²­ê·¼ë¬´ë³„ ì¡°íšŒ ì‘ë‹µ:', response);

                  // ì´ˆê¸°í™” í›„ í•´ë‹¹ ì‹ ì²­ê·¼ë¬´ íƒ€ì…ë§Œ í‘œì‹œ
                  row.find('.work-select').val(applyType);
                  row.find('.work-type-display').text(applyType);
                  row.find('.start-time').val('');
                  row.find('.end-time').val('');
                  row.find('.reason-field').val('');
                  row.find('.status-field').text('ëŒ€ê¸°');
                  row.removeAttr('data-apply-no');

                  // í•´ë‹¹ ì‹ ì²­ê·¼ë¬´ íƒ€ì…ì˜ ê¸°ì¡´ ì‹ ì²­ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ ë³µì›
                  if (response.hasExisting && response.status !== 'ì‚­ì œ' && response.applyType === 'general') {
                      if (response.startTime) {
                          row.find('.start-time').val(formatTimeDisplay(response.startTime));
                      }
                      if (response.endTime) {
                          row.find('.end-time').val(formatTimeDisplay(response.endTime));
                      }
                      row.find('.reason-field').val(response.reason || '');
                      row.find('.status-field').text(response.status || 'ëŒ€ê¸°');
                      row.attr('data-apply-no', response.applyNo);

                      console.log('í•´ë‹¹ ì‹ ì²­ê·¼ë¬´ íƒ€ì…ì˜ ê¸°ì¡´ ì‹ ì²­ ë³µì›:', response.applyNo, response.status, applyType);
                  } else {
                      console.log('í•´ë‹¹ ì‹ ì²­ê·¼ë¬´ íƒ€ì…ì˜ ê¸°ì¡´ ì‹ ì²­ ì—†ìŒ - ì‹ ì²­ ê°€ëŠ¥ ìƒíƒœ:', applyType);
                  }

                  calculateRealTimeWeeklyHoursUltimate(row, empCode);
                  validateWorkTimeRestrictionsUltimate(row);
                  updateButtonStates();
              })
              .fail(function() {
                  console.error('ì‹ ì²­ê·¼ë¬´ë³„ ì¡°íšŒ ì‹¤íŒ¨');
                  row.find('.work-select').val(applyType);
                  row.find('.work-type-display').text(applyType);
                  row.find('.start-time').val('');
                  row.find('.end-time').val('');
                  row.find('.reason-field').val('');
                  row.find('.status-field').text('ëŒ€ê¸°');
                  row.removeAttr('data-apply-no');

                  calculateRealTimeWeeklyHoursUltimate(row, empCode);
              });
      }

      function updateExpectedHoursUltraStable(row, empCode, workDate, applyType) {
          $.get(`/user/apply/updateExpectedHours/${empCode}/${workDate}`)
              .done(function(response) {
                  if (response.success) {
                      const expectedHours = response.expectedHours;

                      if (expectedHours === "ERROR" || expectedHours === "error") {
                          row.find('.expected-hours').text("ê³„ì‚°ì‹¤íŒ¨").addClass('text-red-500');
                          row.find('.expected-hours').attr('title', 'EmpAttService ê³„ì‚° ì‹¤íŒ¨');
                          return;
                      }

                      row.find('.expected-hours').text(expectedHours).removeClass('text-red-500');
                      row.find('.expected-hours').removeAttr('title');
                  } else {
                      row.find('.expected-hours').text("ê³„ì‚°ì‹¤íŒ¨").addClass('text-red-500');
                      row.find('.expected-hours').attr('title', 'EmpAttService ê³„ì‚° ì‹¤íŒ¨');
                  }
              })
              .fail(function() {
                  console.error('ì˜ˆìƒê·¼ë¡œì‹œê°„ API í˜¸ì¶œ ì‹¤íŒ¨');
                  row.find('.expected-hours').text("APIì‹¤íŒ¨").addClass('text-red-500');
              });
      }

      function checkHolidayWorkStatus(empCode, workDate) {
          // í…Œì´ë¸”ì—ì„œ íœ´ì¼ê·¼ë¬´ ì‹ ì²­ í™•ì¸
          let hasHolidayWork = false;
          $('#generalEmployeeTable tbody tr').each(function() {
              const rowEmpCode = $(this).data('emp-code');
              const workType = $(this).find('.work-type-display').text() || $(this).find('.work-select').val();
              const status = $(this).find('.status-field').text();

              if (rowEmpCode === empCode && workType === 'íœ´ì¼ê·¼ë¬´' &&
                  (status === 'ìŠ¹ì¸ì™„ë£Œ' || status === 'ì €ì¥' || status === 'ìƒì‹ ')) {
                  hasHolidayWork = true;
                  return false; // break
              }
          });

          return hasHolidayWork;
      }

      function validate30MinuteInterval(startTime, endTime, applyType) {
          const restrictedTypes = ['ì—°ì¥', 'ì¡°ì¶œì—°ì¥', 'íœ´ì¼ê·¼ë¬´', 'ì¡°í‡´', 'ì™¸ì¶œ', 'ì™¸ê·¼'];

          if (!restrictedTypes.includes(applyType)) {
              return true;
          }

          try {
              const startTimeInt = parseInt(startTime.replace(':', ''));
              const endTimeInt = parseInt(endTime.replace(':', ''));

              const startMinutes = Math.floor(startTimeInt / 100) * 60 + (startTimeInt % 100);
              let endMinutes = Math.floor(endTimeInt / 100) * 60 + (endTimeInt % 100);

              // ìì • ë„˜ì–´ê°€ëŠ” ê²½ìš° ì²˜ë¦¬
              if (endMinutes <= startMinutes) {
                  endMinutes += 24 * 60;
              }

              let totalMinutes = endMinutes - startMinutes;

              let breakTime = 0;
              if (applyType === 'íœ´ì¼ê·¼ë¬´') {
                  // íœ´ì¼ê·¼ë¬´(14-1): ì˜¤ì „ íœ´ê²Œì‹œê°„ë§Œ ì ìš© (11:30~12:20 = 50ë¶„)
                  const morningBreakStart = 11 * 60 + 30; // 690ë¶„
                  const morningBreakEnd = 12 * 60 + 20;   // 740ë¶„

                  if (startMinutes < morningBreakEnd && endMinutes > morningBreakStart) {
                      const overlapStart = Math.max(startMinutes, morningBreakStart);
                      const overlapEnd = Math.min(endMinutes, morningBreakEnd);
                      breakTime = Math.max(0, overlapEnd - overlapStart);
                  }

                  console.log('íœ´ì¼ê·¼ë¬´ ì „ìš© íœ´ê²Œì‹œê°„ ê³„ì‚°:', {
                      ì‹œì‘: startTime, ì¢…ë£Œ: endTime,
                      ì´ì‹œê°„: totalMinutes + 'ë¶„',
                      íœ´ê²Œì‹œê°„: breakTime + 'ë¶„',
                      ìˆœìˆ˜ì‹œê°„: (totalMinutes - breakTime) + 'ë¶„'
                  });
              } else {
                  // ì¼ë°˜ ê·¼ë¬´: ì˜¤ì „ + ì˜¤í›„ íœ´ê²Œì‹œê°„ (ì´ 80ë¶„)
                  if (totalMinutes > 8 * 60) { // 8ì‹œê°„ ì´ˆê³¼ ì‹œ íœ´ê²Œì‹œê°„ ì°¨ê°
                      breakTime = 80; // ê¸°ë³¸ 80ë¶„ íœ´ê²Œì‹œê°„
                  }
              }

              const netWorkMinutes = totalMinutes - breakTime;

              // 30ë¶„ ë‹¨ìœ„ í™•ì¸
              const is30MinuteInterval = netWorkMinutes % 30 === 0 && netWorkMinutes > 0;

              if (!is30MinuteInterval) {
                  console.log('30ë¶„ ë‹¨ìœ„ ê²€ì¦ ì‹¤íŒ¨ (íœ´ê²Œì‹œê°„ ì°¨ê° í›„):', {
                      ì‹ ì²­ìœ í˜•: applyType,
                      ì´ì‹œê°„: totalMinutes + 'ë¶„',
                      íœ´ê²Œì‹œê°„: breakTime + 'ë¶„',
                      ìˆœìˆ˜ì‹œê°„: netWorkMinutes + 'ë¶„'
                  });
                  return false;
              }

              console.log('30ë¶„ ë‹¨ìœ„ ê²€ì¦ í†µê³¼:', {
                  ì‹ ì²­ìœ í˜•: applyType,
                  ì´ì‹œê°„: totalMinutes + 'ë¶„',
                  íœ´ê²Œì‹œê°„: breakTime + 'ë¶„',
                  ìˆœìˆ˜ì‹œê°„: netWorkMinutes + 'ë¶„'
              });
              return true;
          } catch (e) {
              console.error('30ë¶„ ë‹¨ìœ„ ê²€ì¦ ì˜¤ë¥˜:', e);
              return false;
          }
      }

      function validateWorkTimeRestrictionsUltimate(row) {
          const workType = row.find('.work-select').val() || row.find('.work-type-display').text();
          const startTimeInput = row.find('.start-time');
          const endTimeInput = row.find('.end-time');

          if (workType === 'ì „ë°˜ì°¨' || workType === 'í›„ë°˜ì°¨') {
              startTimeInput.prop('disabled', true).val('').prop('readonly', true);
              endTimeInput.prop('disabled', true).val('').prop('readonly', true);
              startTimeInput.attr('placeholder', 'ë°˜ì°¨ëŠ” ì‹œê°„ ì…ë ¥ ë¶ˆê°€');
              endTimeInput.attr('placeholder', 'ë°˜ì°¨ëŠ” ì‹œê°„ ì…ë ¥ ë¶ˆê°€');

              startTimeInput.css({'background-color': '#f3f4f6', 'cursor': 'not-allowed'});
              endTimeInput.css({'background-color': '#f3f4f6', 'cursor': 'not-allowed'});
              startTimeInput.off('click change input keydown keyup');
              endTimeInput.off('click change input keydown keyup');

              // ì„œë²„ì—ì„œ ê²€ì¦
              $.get(`/user/apply/validateHalfDayTimeInput/${workType}`)
                  .done(function(response) {
                      if (response.timeInputDisabled) {
                          startTimeInput.prop('disabled', true).prop('readonly', true);
                          endTimeInput.prop('disabled', true).prop('readonly', true);
                      }
                  });
          }
          else if (workType === 'ì¡°í‡´') {
              startTimeInput.prop('disabled', false).prop('readonly', false);
              endTimeInput.prop('disabled', true).val('').prop('readonly', true);
              startTimeInput.attr('placeholder', 'ì¡°í‡´ ì‹œì‘ì‹œê°„');
              endTimeInput.attr('placeholder', 'ìë™ ê³„ì‚°ë¨');

              startTimeInput.css({'background-color': '', 'cursor': ''});
              endTimeInput.css({'background-color': '#f3f4f6', 'cursor': 'not-allowed'});
              endTimeInput.off('click change input keydown keyup');

              // ì„œë²„ì—ì„œ ê²€ì¦
              $.get(`/user/apply/validateEarlyLeaveTimeInput/${workType}`)
                  .done(function(response) {
                      if (response.endTimeDisabled) {
                          endTimeInput.prop('disabled', true).prop('readonly', true);
                      }
                  });
          }
          else if (workType === 'ì¡°ì¶œì—°ì¥') {
              startTimeInput.prop('disabled', false).prop('readonly', false);
              endTimeInput.prop('disabled', false).prop('readonly', false);
              startTimeInput.attr('max', '07:30');
              endTimeInput.attr('max', '07:30');
              startTimeInput.attr('placeholder', '07:30ê¹Œì§€ë§Œ');
              endTimeInput.attr('placeholder', '07:30ê¹Œì§€ë§Œ');

              startTimeInput.css({'background-color': '', 'cursor': ''});
              endTimeInput.css({'background-color': '', 'cursor': ''});
          }
          else if (workType === 'ì—°ì¥') {
              startTimeInput.prop('disabled', false).prop('readonly', false);
              endTimeInput.prop('disabled', false).prop('readonly', false);
              startTimeInput.attr('min', '16:20');
              startTimeInput.attr('placeholder', '16:20 ì´í›„ë§Œ');
              endTimeInput.attr('placeholder', 'ì¢…ë£Œì‹œê°„');

              startTimeInput.css({'background-color': '', 'cursor': ''});
              endTimeInput.css({'background-color': '', 'cursor': ''});

              const empCode = row.data('emp-code');
              const workDate = $('#generalWorkDate').val().replace(/-/g, '');
              validateHolidayWork8HoursForOvertime(empCode, workDate, row);

              startTimeInput.off('input.regularOvertime').on('input.regularOvertime', function() {
                  validateRegularOvertimeTimeUltimate($(this).val(), row);
              });
          }
          else {
              // ê¸°íƒ€ ê·¼ë¬´ì˜ ê²½ìš° ëª¨ë“  ì œí•œ í•´ì œ
              startTimeInput.prop('disabled', false).prop('readonly', false);
              endTimeInput.prop('disabled', false).prop('readonly', false);
              startTimeInput.removeAttr('min max placeholder');
              endTimeInput.removeAttr('min max placeholder');

              startTimeInput.css({'background-color': '', 'cursor': ''});
              endTimeInput.css({'background-color': '', 'cursor': ''});
              startTimeInput.off('click change input keydown keyup');
              endTimeInput.off('click change input keydown keyup');
          }

          // 30ë¶„ ë‹¨ìœ„ ê²€ì¦
          startTimeInput.off('change.validate30min').on('change.validate30min', function() {
              const startTime = $(this).val();
              const endTime = endTimeInput.val();

              if (startTime && endTime) {
                  if (!validate30MinuteInterval(startTime, endTime, workType)) {
                      alert('ì—°ì¥, íœ´ì¼ê·¼ë¬´, ì¡°í‡´, ì™¸ì¶œ, ì™¸ê·¼ì€ íœ´ê²Œì‹œê°„ì„ ì œì™¸í•˜ê³  30ë¶„ ë‹¨ìœ„ë¡œë§Œ ì‹ ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                      $(this).val('');
                      endTimeInput.val('');
                      return;
                  }
              }
          });

          endTimeInput.off('change.validate30min').on('change.validate30min', function() {
              const startTime = startTimeInput.val();
              const endTime = $(this).val();

              if (startTime && endTime) {
                  if (!validate30MinuteInterval(startTime, endTime, workType)) {
                      alert('ì—°ì¥, íœ´ì¼ê·¼ë¬´, ì¡°í‡´, ì™¸ì¶œ, ì™¸ê·¼ì€ íœ´ê²Œì‹œê°„ì„ ì œì™¸í•˜ê³  30ë¶„ ë‹¨ìœ„ë¡œë§Œ ì‹ ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                      startTimeInput.val('');
                      $(this).val('');
                      return;
                  }
              }
          });
      }

      // ì¡°ì¶œì—°ì¥ ì‹œê°„ ê²€ì¦ ê°•í™”
      function validateEarlyOvertimeTimeUltimate(time, row) {
          if (!time) return;

          try {
              const timeInt = parseInt(time.replace(':', ''));

              if (timeInt > 730) {
                  alert('ì¡°ì¶œì—°ì¥ì€ 07:30ê¹Œì§€ë§Œ ì‹ ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                  row.find('.start-time, .end-time').val('');
                  return;
              }
          } catch (e) {
              console.error('ì¡°ì¶œì—°ì¥ ì‹œê°„ íŒŒì‹± ì˜¤ë¥˜:', e);
          }

          // ì„œë²„ ê²€ì¦ë„ ë³‘í–‰
          $.post('/user/apply/validateEarlyOvertimeTime', { startTime: time })
              .done(function(response) {
                  if (!response.isValid) {
                      alert(response.message);
                      row.find('.start-time, .end-time').val('');
                  }
              })
              .fail(function() {
                  console.error('ì¡°ì¶œì—°ì¥ ì‹œê°„ ì„œë²„ ê²€ì¦ ì‹¤íŒ¨');
              });
      }

      function validateRegularOvertimeTimeUltimate(time, row) {
          if (!time) return;

          $.post('/user/apply/validateRegularOvertimeTime', { startTime: time })
              .done(function(response) {
                  if (!response.isValid) {
                      alert(response.message);
                      row.find('.start-time').val('');
                      console.log('ì¼ë°˜ì—°ì¥ ì‹œê°„ ì œí•œ ìœ„ë°˜:', response.message);
                  }
              })
              .fail(function() {
                  console.error('ì¼ë°˜ì—°ì¥ ì‹œê°„ ê²€ì¦ ì‹¤íŒ¨');
              });
      }

      function validateHolidayWork8HoursForOvertime(empCode, workDate, row) {
          // ë™ì¼ ë‚ ì§œì— íœ´ì¼ê·¼ë¬´ ì‹ ì²­ì´ ìˆëŠ”ì§€ í™•ì¸
          let holidayWorkRow = null;
          $('#generalEmployeeTable tbody tr').each(function() {
              const rowEmpCode = $(this).data('emp-code');
              const workType = $(this).find('.work-type-display').text() || $(this).find('.work-select').val();

              if (rowEmpCode === empCode && workType === 'íœ´ì¼ê·¼ë¬´') {
                  holidayWorkRow = $(this);
                  return false; // break
              }
          });

          if (holidayWorkRow) {
              const startTime = holidayWorkRow.find('.start-time').val();
              const endTime = holidayWorkRow.find('.end-time').val();

              if (startTime && endTime) {
                  const startHour = parseInt(startTime.split(':')[0]);
                  const startMin = parseInt(startTime.split(':')[1]);
                  const endHour = parseInt(endTime.split(':')[0]);
                  const endMin = parseInt(endTime.split(':')[1]);

                  let totalMinutes = (endHour * 60 + endMin) - (startHour * 60 + startMin);

                  // ìì • ë„˜ì–´ê°€ëŠ” ê²½ìš° ì²˜ë¦¬
                  if (totalMinutes <= 0) {
                      totalMinutes += 24 * 60;
                  }

                  let breakTime = 0;
                  const morningBreakStart = 11 * 60 + 30; // 690ë¶„
                  const morningBreakEnd = 12 * 60 + 20;   // 740ë¶„
                  const workStart = startHour * 60 + startMin;
                  const workEnd = endHour * 60 + endMin;

                  if (workStart < morningBreakEnd && workEnd > morningBreakStart) {
                      const overlapStart = Math.max(workStart, morningBreakStart);
                      const overlapEnd = Math.min(workEnd, morningBreakEnd);
                      breakTime = Math.max(0, overlapEnd - overlapStart);
                  }

                  const netWorkMinutes = totalMinutes - breakTime;

                  if (netWorkMinutes < 480) { // ìˆœìˆ˜ 8ì‹œê°„ = 480ë¶„
                      row.find('.start-time, .end-time').prop('disabled', true);
                      row.find('.start-time').attr('placeholder', 'íœ´ì¼ê·¼ë¬´ ìˆœìˆ˜ 8ì‹œê°„ ì´ìƒ í•„ìš”');
                      row.find('.end-time').attr('placeholder', 'íœ´ì¼ê·¼ë¬´ ìˆœìˆ˜ 8ì‹œê°„ ì´ìƒ í•„ìš”');
                      console.log('íœ´ì¼ê·¼ë¬´ ìˆœìˆ˜ 8ì‹œê°„ ë¯¸ë§Œìœ¼ë¡œ ì—°ì¥ê·¼ë¡œ ì°¨ë‹¨ (ì „ìš© íœ´ê²Œì‹œê°„):', netWorkMinutes + 'ë¶„');
                  } else {
                      row.find('.start-time, .end-time').prop('disabled', false);
                      row.find('.start-time').attr('placeholder', '16:20 ì´í›„ë§Œ');
                      row.find('.end-time').attr('placeholder', 'ì¢…ë£Œì‹œê°„');
                      console.log('íœ´ì¼ê·¼ë¬´ ìˆœìˆ˜ 8ì‹œê°„ ì´ìƒìœ¼ë¡œ ì—°ì¥ê·¼ë¡œ í—ˆìš© (ì „ìš© íœ´ê²Œì‹œê°„):', netWorkMinutes + 'ë¶„');
                  }
              }
          }
      }

      // íœ´ê²Œì‹œê°„ ê²¹ì¹¨ ê³„ì‚° í•¨ìˆ˜
      function calculateBreakOverlap(workStart, workEnd, breakStart, breakEnd) {
          const overlapStart = Math.max(workStart, breakStart);
          const overlapEnd = Math.min(workEnd, breakEnd);
          return Math.max(0, overlapEnd - overlapStart);
      }

      function searchGeneralEmployees() {
          if (isGeneralSearching) {
              console.log('ì´ë¯¸ ì¡°íšŒ ì¤‘ì…ë‹ˆë‹¤.');
              return;
          }

          isGeneralSearching = true;

          const deptCode = $('#generalDeptSelect').val();
          const workDate = $('#generalWorkDate').val();
          const applyTypeCategory = $('#generalApplyType').val();

          if (!deptCode) {
              console.error('ë¶€ì„œì½”ë“œê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
              alert('ë¶€ì„œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
              isGeneralSearching = false;
              return;
          }

          if (!workDate) {
              console.error('ê·¼ë¬´ì¼ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
              alert('ê·¼ë¬´ì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
              isGeneralSearching = false;
              return;
          }

          const formattedWorkDate = workDate.replace(/-/g, '');

          console.log('ì‚¬ì› ì¡°íšŒ ìš”ì²­:', { deptCode, workDate: formattedWorkDate, applyTypeCategory });

          $.get('/user/apply/employees', {
              deptCode: deptCode,
              workDate: formattedWorkDate,
              sortBy: 'gradeOrder,empCode',
              applyTypeCategory: applyTypeCategory
          })
          .done(function(employees) {
              console.log('ì‚¬ì› ì¡°íšŒ ì„±ê³µ:', employees);
              displayGeneralEmployees(employees);
          })
          .fail(function(xhr, status, error) {
              console.error('ì‚¬ì› ì¡°íšŒ ì‹¤íŒ¨:', { xhr, status, error });
              console.error('ì‘ë‹µ ë‚´ìš©:', xhr.responseText);
              alert('ì‚¬ì› ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (xhr.responseText || error));
          })
          .always(function() {
              isGeneralSearching = false;
          });
      }

      // ê¸°íƒ€ê·¼íƒœ ì‚¬ì› ì¡°íšŒ
      function searchEtcEmployees() {
          if (isEtcSearching) {
              console.log('ì´ë¯¸ ì¡°íšŒ ì¤‘ì…ë‹ˆë‹¤.');
              return;
          }

          isEtcSearching = true;

          const deptCode = $('#etcDeptSelect').val();
          const workDate = $('#etcWorkDate').val();
          const workPlan = $('#etcWorkPlan').val();

          if (!deptCode) {
              alert('ë¶€ì„œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
              isEtcSearching = false;
              return;
          }

          if (!workDate) {
              alert('ê·¼ë¬´ì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
              isEtcSearching = false;
              return;
          }

          const formattedWorkDate = workDate.replace(/-/g, '');

          $.get('/user/apply/employees', {
              deptCode: deptCode,
              workDate: formattedWorkDate,
              workPlan: workPlan,
              sortBy: 'gradeOrder,empCode'
          })
          .done(function(employees) {
              displayEtcEmployees(employees);
          })
          .fail(function(xhr, status, error) {
              console.error('ì‚¬ì› ì¡°íšŒ ì‹¤íŒ¨:', { xhr, status, error });
              alert('ì‚¬ì› ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (xhr.responseText || error));
          })
          .always(function() {
              isEtcSearching = false;
          });
      }

      function forceSortTableByGrade(tbody) {
          const rows = Array.from(tbody.find('tr'));

          console.log('ì •ë ¬ ì „ í–‰ ìˆ˜:', rows.length);

          rows.sort(function(a, b) {
              const aEmpCode = $(a).find('td:eq(1)').text().trim();
              const aPositionName = $(a).find('td:eq(3)').text().trim();
              const bEmpCode = $(b).find('td:eq(1)').text().trim();
              const bPositionName = $(b).find('td:eq(3)').text().trim();

              console.log('ë¹„êµ:', aEmpCode, aPositionName, 'vs', bEmpCode, bPositionName);

              const gradeOrder = {
                  'ì‚¬ì¥': 1,
                  'ë¶€ì‚¬ì¥': 2,
                  'ì „ë¬´': 3,
                  'ì „ë¬´ë³´': 4,
                  'ìƒë¬´': 5,
                  'ìƒë¬´ë³´': 6,
                  'ì´ì‚¬': 7,
                  'ë¶€ì¥': 8,
                  'ì°¨ì¥': 9,
                  'ê³¼ì¥': 10,
                  'ëŒ€ë¦¬': 11,
                  'ì‚¬ì›': 12
              };

              const aGrade = gradeOrder[aPositionName] || 999;
              const bGrade = gradeOrder[bPositionName] || 999;

              if (aGrade !== bGrade) {
                  return aGrade - bGrade;
              }

              const aEmpNum = parseInt(aEmpCode.replace(/\D/g, '')) || 0;
              const bEmpNum = parseInt(bEmpCode.replace(/\D/g, '')) || 0;

              console.log('ì‚¬ë²ˆ ë¹„êµ:', aEmpNum, 'vs', bEmpNum);

              return aEmpNum - bEmpNum;
          });

          tbody.empty();

          rows.forEach(function(row) {
              tbody.append(row);
          });

          console.log('ì •ë ¬ ì™„ë£Œ - ìµœì¢… ìˆœì„œ:');
          tbody.find('tr').each(function(index) {
              const empCode = $(this).find('td:eq(1)').text().trim();
              const positionName = $(this).find('td:eq(3)').text().trim();
              console.log(`${index + 1}. ${empCode} ${positionName}`);
          });
      }

      function displayGeneralEmployees(employees) {
          const tbody = $('#generalEmployeeBody');
          tbody.empty();

          const selectedWorkType = $('#generalWorkTypeFilter').val();

          let processedCount = 0;
          const totalCount = employees.length;

          employees.forEach(function(emp) {
              // ê·¼ë¬´ì •ë³´ ì¡°íšŒ
              loadWorkInfo(emp.empCode, $('#generalWorkDate').val().replace(/-/g, ''), function(workInfo) {
                  const applyType = $('#generalApplyType').val();
                  const isLeaveType = applyType === 'ì¡°í‡´ì™¸ì¶œë°˜ì°¨';

                  const workOptions = workTypeOptions[applyType] || [];
                  let workSelectHtml = '';
                  workOptions.forEach(function(option) {
                      const selected = (selectedWorkType && option.value === selectedWorkType) ? 'selected' : '';
                      workSelectHtml += `<option value="${option.value}" ${selected}>${option.text}</option>`;
                  });

                  const applyNo = emp.applyGeneralNo || '';
                  const status = emp.generalApplyStatus || 'ëŒ€ê¸°';

                  let recordDisplay = workInfo.record.shiftName || '-';
                  if (workInfo.appliedRecord && workInfo.appliedRecord.shiftName) {
                      recordDisplay = workInfo.appliedRecord.shiftName;
                  }

                  const workDate = $('#generalWorkDate').val().replace(/-/g, '');
                  const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                  const isFutureDate = workDate > today;

                  // ë¯¸ë˜ ë‚ ì§œëŠ” ê²°ê·¼ ì²´í¬í•˜ì§€ ì•ŠìŒ
                  let isAbsent = false;
                  if (!isFutureDate) {
                      // ê³¼ê±°/í˜„ì¬ ë‚ ì§œë§Œ ê²°ê·¼ ì²´í¬
                      isAbsent = workInfo.record.shiftCode === '00' || workInfo.record.shiftName === 'ê²°ê·¼';
                  }

                  const recordColor = isAbsent ? 'text-gray-700' : '';

                  const expectedHours = workInfo.expectedHours || '40.00';

                  const row = `
                      <tr data-emp-code="${emp.empCode}" data-apply-no="${applyNo}" data-is-absent="${isAbsent}" data-plan="${workInfo.empCalendarPlan || workInfo.plan || ''}" data-record="${recordDisplay}">
                          <td class="border border-gray-300 px-4 py-2">
                              <input type="checkbox" class="emp-checkbox">
                          </td>
                          <td class="border border-gray-300 px-4 py-2">${emp.empCode}</td>
                          <td class="border border-gray-300 px-4 py-2">${emp.empName}</td>
                          <td class="border border-gray-300 px-4 py-2">${emp.positionName || ''}</td>
                          <td class="border border-gray-300 px-4 py-2">${emp.deptName || ''}</td>
                          <td class="border border-gray-300 px-4 py-2">${workInfo.empCalendarPlan || workInfo.plan || ''}</td>
                          <td class="border border-gray-300 px-4 py-2 ${recordColor}">${recordDisplay}</td>
                          <td class="border border-gray-300 px-4 py-2">
                              <span class="work-type-display">${selectedWorkType || (workOptions[0] ? workOptions[0].text : '')}</span>
                              <select class="work-select hidden w-full border rounded px-2 py-1" ${isAbsent ? 'disabled' : ''}>
                                  ${workSelectHtml}
                              </select>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <input type="time" class="start-time w-full border rounded px-2 py-1" ${isAbsent ? 'disabled' : ''}>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <input type="time" class="end-time w-full border rounded px-2 py-1" ${isAbsent ? 'disabled' : ''}>
                          </td>
                          <td class="border border-gray-300 px-4 py-2 ${isLeaveType ? 'hidden' : ''}">
                              <span class="expected-hours">${expectedHours}</span>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <input type="text" class="reason-field w-full border rounded px-2 py-1" placeholder="ì‚¬ìœ  ì…ë ¥" ${isAbsent ? 'disabled' : ''}>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <span class="status-field">${status}</span>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <span class="applicant-field">${currentUser.empName}</span>
                          </td>
                      </tr>
                  `;
                  tbody.append(row);

                  processedCount++;

                  if (processedCount === totalCount) {
                      setTimeout(function() {
                          console.log('ëª¨ë“  ì‚¬ì› ì²˜ë¦¬ ì™„ë£Œ - ê°•ì œ ì •ë ¬ ì‹œì‘');
                          forceSortTableByGrade(tbody);
                      }, 100);
                  }

                  if (applyNo) {
                      loadSavedGeneralData(applyNo, tbody.find('tr:last'), applyType);
                  }

                  // ì‹œê°„ ë³€ê²½ ì‹œ ì‹¤ì‹œê°„ ì£¼ 52ì‹œê°„ ê²€ì¦
                  const currentRow = tbody.find('tr:last');
                  currentRow.find('.start-time, .end-time').on('change', function() {
                      calculateRealTimeWeeklyHoursUltimate(currentRow, emp.empCode);
                  });

                  currentRow.find('.work-select').on('change', function() {
                      validateWorkTimeRestrictionsUltimate(currentRow);
                  });

                  validateWorkTimeRestrictionsUltimate(currentRow);

                  calculateRealTimeWeeklyHoursUltimate(currentRow, emp.empCode);

                  // ìƒíƒœë³„ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
                  updateButtonStates();
              });
          });
      }

      function displayEtcEmployees(employees) {
          const tbody = $('#etcEmployeeBody');
          tbody.empty();

          let processedCount = 0;
          const totalCount = employees.length;

          employees.forEach(function(emp) {
              // ê·¼ë¬´ì •ë³´ ì¡°íšŒ
              loadWorkInfo(emp.empCode, $('#etcWorkDate').val().replace(/-/g, ''), function(workInfo) {
                  const applyNo = emp.applyEtcNo || '';
                  const status = emp.etcApplyStatus || 'ëŒ€ê¸°';

                  let recordDisplay = workInfo.record.shiftName || '-';
                  if (workInfo.appliedRecord && workInfo.appliedRecord.shiftName) {
                      recordDisplay = workInfo.appliedRecord.shiftName;
                  }

                  const workDate = $('#etcWorkDate').val().replace(/-/g, '');
                  const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                  const isFutureDate = workDate > today;

                  // ë¯¸ë˜ ë‚ ì§œëŠ” ê²°ê·¼ ì²´í¬í•˜ì§€ ì•ŠìŒ
                  let isAbsent = false;
                  if (!isFutureDate) {
                      // ê³¼ê±°/í˜„ì¬ ë‚ ì§œë§Œ ê²°ê·¼ ì²´í¬
                      isAbsent = workInfo.record.shiftCode === '00' || workInfo.record.shiftName === 'ê²°ê·¼';
                  }

                  const recordColor = isAbsent ? 'text-gray-700' : '';

                  const row = `
                      <tr data-emp-code="${emp.empCode}" data-apply-no="${applyNo}" data-is-absent="${isAbsent}" data-plan="${workInfo.empCalendarPlan || workInfo.plan || ''}" data-record="${recordDisplay}">
                          <td class="border border-gray-300 px-4 py-2">
                              <input type="checkbox" class="emp-checkbox">
                          </td>
                          <td class="border border-gray-300 px-4 py-2">${emp.empCode}</td>
                          <td class="border border-gray-300 px-4 py-2">${emp.empName}</td>
                          <td class="border border-gray-300 px-4 py-2">${emp.positionName || ''}</td>
                          <td class="border border-gray-300 px-4 py-2">${emp.deptName || ''}</td>
                          <td class="border border-gray-300 px-4 py-2">${workInfo.empCalendarPlan || workInfo.plan || ''}</td>
                          <td class="border border-gray-300 px-4 py-2 ${recordColor}">${recordDisplay}</td>
                          <td class="border border-gray-300 px-4 py-2">
                              <select class="shift-select w-full border rounded px-2 py-1" ${isAbsent ? 'disabled' : ''}>
                                  <option value="">ì„ íƒ</option>
                              </select>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <input type="date" class="start-date w-full border rounded px-2 py-1" ${isAbsent ? 'disabled' : ''}>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <input type="date" class="end-date w-full border rounded px-2 py-1" ${isAbsent ? 'disabled' : ''}>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <span class="annual-balance">0.00</span>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <select class="apply-time w-full border rounded px-2 py-1" ${isAbsent ? 'disabled' : ''}>
                                  <option value="1ì¼ì´ì „ì‹ ì²­">1ì¼ì´ì „ì‹ ì²­</option>
                                  <option value="ë‹¹ì¼ì‹ ì²­">ë‹¹ì¼ì‹ ì²­</option>
                              </select>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <input type="text" class="reason-field w-full border rounded px-2 py-1" placeholder="ì‚¬ìœ  ì…ë ¥" ${isAbsent ? 'disabled' : ''}>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <span class="status-field">${status}</span>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <span class="applicant-field">${currentUser.empName}</span>
                          </td>
                      </tr>
                  `;
                  tbody.append(row);

                  processedCount++;

                  if (processedCount === totalCount) {
                      setTimeout(function() {
                          console.log('ëª¨ë“  ì‚¬ì› ì²˜ë¦¬ ì™„ë£Œ - ê°•ì œ ì •ë ¬ ì‹œì‘ (ê¸°íƒ€ê·¼íƒœ)');
                          forceSortTableByGrade(tbody);
                      }, 100);
                  }

                  const shiftSelect = tbody.find('tr:last .shift-select');
                  shiftMasters.forEach(function(shift) {
                      // íœ´ì¼, íœ´ë¬´ì¼ ì œì™¸
                      if (shift.shiftCode !== '12' && shift.shiftCode !== '13') {
                          shiftSelect.append(`<option value="${shift.shiftCode}">${shift.shiftName}</option>`);
                      }
                  });

                  const currentRow = tbody.find('tr:last');
                  currentRow.find('.start-date, .end-date').on('change', function() {
                      validateEtcDateRange(currentRow);
                  });

                  loadAnnualBalanceUltraStable(emp.empCode, currentRow);

                  // ê¸°ì¡´ ì‹ ì²­ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë³µì›
                  if (applyNo) {
                      loadSavedEtcData(applyNo, tbody.find('tr:last'));
                  }

                  // ìƒíƒœë³„ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
                  updateButtonStates();
              });
          });
      }

      function validateEtcDateRange(row) {
          const startDate = row.find('.start-date').val();
          const endDate = row.find('.end-date').val();

          if (!startDate || !endDate) return;

          // íœ´ì¼/íœ´ë¬´ì¼ ì²´í¬ë¥¼ ìœ„í•œ API í˜¸ì¶œ
          $.get('/user/apply/validateDateRange', {
              startDate: startDate.replace(/-/g, ''),
              endDate: endDate.replace(/-/g, '')
          })
          .done(function(result) {
              if (!result.valid) {
                  alert('ì‹ ì²­ ê¸°ê°„ì— íœ´ì¼/íœ´ë¬´ì¼ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë‚ ì§œë¥¼ ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”.');
                  row.find('.start-date, .end-date').val('');
              }
          })
          .fail(function() {
              console.warn('ë‚ ì§œ ë²”ìœ„ ê²€ì¦ API í˜¸ì¶œ ì‹¤íŒ¨');
          });
      }

      function calculateRealTimeWeeklyHoursUltimate(row, empCode) {
          const applyType = $('#generalApplyType').val();
          const workType = row.find('.work-select').val() || row.find('.work-type-display').text();
          const startTime = row.find('.start-time').val();
          const endTime = row.find('.end-time').val();
          const workDate = $('#generalWorkDate').val()?.replace(/-/g, '') || '';

          if (!empCode || !workDate) {
              console.warn('empCode ë˜ëŠ” workDate ëˆ„ë½:', { empCode, workDate });
              row.find('.expected-hours').text('40.00');
              return;
          }

          const requestKey = `${empCode}_${workDate}_${workType}_${startTime}_${endTime}`;
          if (window.activeCalculations[requestKey]) {
              console.log('ì¤‘ë³µ ê³„ì‚° ìš”ì²­ ì°¨ë‹¨:', requestKey);
              return;
          }
          window.activeCalculations[requestKey] = true;

          // íœ´ì¼ê·¼ë¬´, ì—°ì¥ê·¼ë¡œëŠ” ì„œë²„ì—ì„œë§Œ ê³„ì‚°
          if (workType === 'íœ´ì¼ê·¼ë¬´' || workType === 'ì—°ì¥' || workType === 'ì¡°ì¶œì—°ì¥') {
              // ì‹œê°„ì´ ì…ë ¥ë˜ì–´ ìˆì§€ ì•Šìœ¼ë©´ ì„œë²„ì—ì„œ ê³„ì‚°
              if (!startTime || !endTime) {
                  updateExpectedHoursDirectFromEmpAttService(row, empCode, workDate);
              }
              // ì‹œê°„ì´ ì…ë ¥ë˜ì–´ ìˆì–´ë„ ê¸°ì¡´ ê°’ ìœ ì§€
              delete window.activeCalculations[requestKey];
              return;
          }


          if (applyType === 'ì¡°í‡´ì™¸ì¶œë°˜ì°¨') {
              if (workType === 'ì „ë°˜ì°¨' || workType === 'í›„ë°˜ì°¨') {
                  row.find('.expected-hours').text('-4.00');
                  console.log('ë°˜ì°¨ 4ì‹œê°„ ì°¨ê° ì ìš©:', workType);
                  delete window.activeCalculations[requestKey];
                  return;
              } else if (workType === 'ì¡°í‡´') {
                  if (startTime) {
                      calculateEarlyLeaveHours(empCode, workDate, startTime, function(deductHours) {
                          row.find('.expected-hours').text(`-${deductHours.toFixed(2)}`);
                          delete window.activeCalculations[requestKey];
                      });
                  } else {
                      row.find('.expected-hours').text('0.00');
                      delete window.activeCalculations[requestKey];
                  }
                  return;
              } else if (workType === 'ì™¸ì¶œ') {
                  if (startTime && endTime) {
                      const [startHour, startMin] = startTime.split(':').map(Number);
                      const [endHour, endMin] = endTime.split(':').map(Number);
                      let startMinutes = startHour * 60 + startMin;
                      let endMinutes = endHour * 60 + endMin;
                      if (endMinutes <= startMinutes) endMinutes += 24 * 60;
                      if (endMinutes > startMinutes) {
                          row.find('.expected-hours').text(`-${((endMinutes - startMinutes) / 60).toFixed(2)}`);
                      } else {
                          row.find('.expected-hours').text('0.00');
                      }
                  } else {
                      row.find('.expected-hours').text('0.00');
                  }
                  delete window.activeCalculations[requestKey];
                  return;
              } else if (workType === 'ì™¸ê·¼') {
                  row.find('.expected-hours').text('0.00');
                  delete window.activeCalculations[requestKey];
                  return;
              } else {
                  row.find('.expected-hours').text('0.00');
                  delete window.activeCalculations[requestKey];
                  return;
              }
          }

          const isAbsent = row.data('is-absent') === true;
          if (isAbsent) {
              updateExpectedHoursDirectFromEmpAttService(row, empCode, workDate);
              delete window.activeCalculations[requestKey];
              return;
          }

          if (!startTime || !endTime) {
              updateExpectedHoursDirectFromEmpAttService(row, empCode, workDate);
              delete window.activeCalculations[requestKey];
              return;
          }

          // 30ë¶„ ë‹¨ìœ„ ê²€ì¦
          if (!validate30MinuteInterval(startTime, endTime, workType)) {
              alert('ì—°ì¥, íœ´ì¼ê·¼ë¬´, ì¡°í‡´, ì™¸ì¶œ, ì™¸ê·¼ì€ íœ´ê²Œì‹œê°„ì„ ì œì™¸í•˜ê³  30ë¶„ ë‹¨ìœ„ë¡œë§Œ ì‹ ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
              row.find('.start-time, .end-time').val('');
              delete window.activeCalculations[requestKey];
              return;
          }

          $.post('/user/apply/calculateWorkHours', {
              empCode: empCode,
              workDate: workDate,
              startTime: startTime,
              endTime: endTime,
              applyType: workType
          })
          .done(function(response) {
              const expectedHoursSpan = row.find('.expected-hours');
              const totalHours = response.totalWeeklyHours.toFixed(2);

              expectedHoursSpan.text(totalHours);

              if (!response.isValid) {
                  expectedHoursSpan.addClass('text-red-500');
                  expectedHoursSpan.attr('title', response.message);
              } else {
                  expectedHoursSpan.removeClass('text-red-500');
                  expectedHoursSpan.removeAttr('title');
              }

              console.log('ì„œë²„ ê³„ì‚° ì™„ë£Œ:', {
                  empCode: empCode,
                  workType: workType,
                  ì‹œì‘ì‹œê°„: startTime,
                  ì¢…ë£Œì‹œê°„: endTime,
                  ê²°ê³¼: totalHours
              });
          })
          .fail(function() {
              console.error('ì‹¤ì‹œê°„ ì£¼ 52ì‹œê°„ ê³„ì‚° ì‹¤íŒ¨');
              updateExpectedHoursDirectFromEmpAttService(row, empCode, workDate);
          })
          .always(function() {
              delete window.activeCalculations[requestKey];
          });
      }

      function updateExpectedHoursDirectFromEmpAttService(row, empCode, workDate) {
          $.get(`/user/apply/updateExpectedHours/${empCode}/${workDate}`)
              .done(function(response) {
                  if (response.success) {
                      const expectedHours = response.expectedHours;
                      row.find('.expected-hours').text(expectedHours).removeClass('text-red-500');
                      console.log('íœ´ì¼ê·¼ë¬´ EmpAttService ì§ì ‘ ì‚¬ìš©:', expectedHours);
                  } else {
                      row.find('.expected-hours').text("ê³„ì‚°ì‹¤íŒ¨").addClass('text-red-500');
                  }
              })
              .fail(function() {
                  row.find('.expected-hours').text("APIì‹¤íŒ¨").addClass('text-red-500');
              });
      }

      // ì¡°í‡´ ì‹œê°„ ì •í™• ê³„ì‚°
      function calculateEarlyLeaveHours(empCode, workDate, startTime, callback) {
          try {
              const startHour = parseInt(startTime.split(':')[0]);
              const startMin = parseInt(startTime.split(':')[1]);
              const startTotalMin = startHour * 60 + startMin;

              const endTotalMin = 16 * 60 + 20; // 16:20 í‡´ê·¼ì‹œê°„

              if (endTotalMin > startTotalMin) {
                  const diffMin = endTotalMin - startTotalMin;
                  const diffHours = diffMin / 60.0;
                  callback(diffHours);
              } else {
                  callback(0);
              }
          } catch (e) {
              callback(2.0); // ê¸°ë³¸ 2ì‹œê°„
          }
      }

      function updateExpectedHours(empCode, workDate, callback) {
          $.get(`/user/apply/updateExpectedHours/${empCode}/${workDate}`)
              .done(function(response) {
                  if (response.success) {
                      const expectedHours = response.expectedHours;
                      callback(expectedHours);
                  } else {
                      const defaultHours = '40.00';
                      callback(defaultHours);
                  }
              })
              .fail(function() {
                  const defaultHours = '40.00';
                  callback(defaultHours);
              });
      }

      function loadSavedGeneralData(applyNo, row, currentApplyType) {
          $.get(`/user/apply/general/${applyNo}`)
              .done(function(data) {
                  if (data) {
                      const savedApplyType = data.applyType;
                      const savedApplyCategory = getApplyCategoryFromType(savedApplyType);

                      if (savedApplyCategory === currentApplyType) {
                          // ì €ì¥ëœ ë°ì´í„°ë¡œ í¼ í•„ë“œ ë³µì›
                          row.find('.work-select').val(data.applyType || '');
                          row.find('.work-type-display').text(data.applyType || '');
                          if (data.startTime) {
                              row.find('.start-time').val(formatTimeDisplay(data.startTime));
                          }
                          if (data.endTime) {
                              row.find('.end-time').val(formatTimeDisplay(data.endTime));
                          }
                          row.find('.reason-field').val(data.reason || '');
                          row.find('.status-field').text(data.status || 'ëŒ€ê¸°');

                          // ë³µì› í›„ ì‹¤ì‹œê°„ ê²€ì¦
                          if (data.startTime && data.endTime) {
                              calculateRealTimeWeeklyHoursUltimate(row, row.data('emp-code'));
                          }
                      } else {
                          row.find('.status-field').text('ëŒ€ê¸°');
                      }
                  }
              })
              .fail(function() {
                  console.log('ì €ì¥ëœ ì¼ë°˜ê·¼íƒœ ë°ì´í„° ì—†ìŒ: ' + applyNo);
              });
      }

      function getApplyCategoryFromType(applyType) {
          if (['ì¡°ì¶œì—°ì¥', 'ì—°ì¥'].includes(applyType)) {
              return 'ì—°ì¥ê·¼ë¡œ';
          } else if (['íœ´ì¼ê·¼ë¬´'].includes(applyType)) {
              return 'íœ´ì¼ê·¼ë¡œ';
          } else if (['ì¡°í‡´', 'ì™¸ê·¼', 'ì™¸ì¶œ', 'ì „ë°˜ì°¨', 'í›„ë°˜ì°¨'].includes(applyType)) {
              return 'ì¡°í‡´ì™¸ì¶œë°˜ì°¨';
          }
          return '';
      }

      // ì €ì¥ëœ ê¸°íƒ€ê·¼íƒœ ë°ì´í„° ë³µì› í•¨ìˆ˜
      function loadSavedEtcData(applyNo, row) {
          $.get(`/user/apply/etc/${applyNo}`)
              .done(function(data) {
                  if (data) {
                      // ì €ì¥ëœ ë°ì´í„°ë¡œ í¼ í•„ë“œ ë³µì›
                      row.find('.shift-select').val(data.shiftCode || '');
                      if (data.targetStartDate) {
                          row.find('.start-date').val(formatDateDisplay(data.targetStartDate));
                      }
                      if (data.targetEndDate) {
                          row.find('.end-date').val(formatDateDisplay(data.targetEndDate));
                      }
                      row.find('.apply-time').val(data.applyDateTime || '1ì¼ì´ì „ì‹ ì²­');
                      row.find('.reason-field').val(data.reason || '');
                      row.find('.status-field').text(data.status || 'ëŒ€ê¸°');
                  }
              })
              .fail(function() {
                  console.log('ì €ì¥ëœ ê¸°íƒ€ê·¼íƒœ ë°ì´í„° ì—†ìŒ: ' + applyNo);
              });
      }

      // ì‹œê°„ í¬ë§· ë³€í™˜ í•¨ìˆ˜ (HHMM -> HH:MM)
      function formatTimeDisplay(timeStr) {
          if (!timeStr || timeStr.length !== 4) return '';
          return timeStr.substring(0, 2) + ':' + timeStr.substring(2, 4);
      }

      // ë‚ ì§œ í¬ë§· ë³€í™˜ í•¨ìˆ˜ (YYYYMMDD -> YYYY-MM-DD)
      function formatDateDisplay(dateStr) {
          if (!dateStr || dateStr.length !== 8) return '';
          return dateStr.substring(0, 4) + '-' + dateStr.substring(4, 6) + '-' + dateStr.substring(6, 8);
      }

      // ìƒíƒœë³„ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™” í•¨ìˆ˜
      function updateButtonStates() {
          // ì„ íƒëœ í–‰ë“¤ì˜ ìƒíƒœ í™•ì¸
          const selectedRows = $('.emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              // ì„ íƒëœ í–‰ì´ ì—†ìœ¼ë©´ ì¡°íšŒ, ì €ì¥ë§Œ í™œì„±í™”
              $('#saveGeneralBtn, #saveEtcBtn').prop('disabled', false);
              $('#deleteGeneralBtn, #deleteEtcBtn, #submitGeneralBtn, #submitEtcBtn, #cancelGeneralBtn, #cancelEtcBtn').prop('disabled', true);
              return;
          }

          let hasWaiting = false, hasSaved = false, hasSubmitted = false;
          let hasAbsent = false;

          selectedRows.each(function() {
              const status = $(this).find('.status-field').text();
              const isAbsent = $(this).data('is-absent') === true;

              if (status === 'ëŒ€ê¸°') hasWaiting = true;
              else if (status === 'ì €ì¥') hasSaved = true;
              else if (status === 'ìƒì‹ ') hasSubmitted = true;

              if (isAbsent) hasAbsent = true;
          });

          if (hasAbsent) {
              $('#saveGeneralBtn, #saveEtcBtn, #submitGeneralBtn, #submitEtcBtn').prop('disabled', true);
          } else {
              // ëŒ€ê¸° ìƒíƒœ: ì €ì¥ë§Œ ê°€ëŠ¥
              // ì €ì¥ ìƒíƒœ: ì‚­ì œ, ìƒì‹  ê°€ëŠ¥
              // ìƒì‹  ìƒíƒœ: ìƒì‹ ì·¨ì†Œë§Œ ê°€ëŠ¥
              $('#saveGeneralBtn, #saveEtcBtn').prop('disabled', !hasWaiting);
              $('#submitGeneralBtn, #submitEtcBtn').prop('disabled', !hasSaved);
          }

          $('#deleteGeneralBtn, #deleteEtcBtn').prop('disabled', !hasSaved);
          $('#cancelGeneralBtn, #cancelEtcBtn').prop('disabled', !hasSubmitted);
      }

      // ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
      $(document).on('change', '.emp-checkbox', updateButtonStates);

      // ê·¼ë¬´ì •ë³´ ì¡°íšŒ í•¨ìˆ˜
      function loadWorkInfo(empCode, workDate, callback) {
          $.get(`/user/apply/workInfo/${empCode}/${workDate}`)
              .done(function(workInfo) {
                  callback(workInfo);
              })
              .fail(function() {
                  callback({
                      plan: '',
                      empCalendarPlan: '',
                      record: {checkInTime: '-', checkOutTime: '-', shiftCode: '', shiftName: '-'},
                      appliedRecord: null,
                      expectedHours: '40.00'  // ì£¼ê°„ ì˜ˆìƒê·¼ë¡œì‹œê°„ ê¸°ë³¸ê°’
                  });
              });
      }

      function loadAnnualBalanceUltraStable(empCode, row) {
          $.get(`/user/apply/annual/${empCode}`)
              .done(function(annual) {
                  let balanceDay = parseFloat(annual.balanceDay || '0');

                  if (annual.totDay && annual.useDay) {
                      const totDay = parseFloat(annual.totDay || '0');
                      const useDay = parseFloat(annual.useDay || '0');
                      const calculatedBalance = totDay - useDay;

                      if (Math.abs(balanceDay - calculatedBalance) > 0.001) {
                          console.warn('ì—°ì°¨ ê³„ì‚° ë¶ˆì¼ì¹˜ ê°ì§€ - ì‹¤ì‹œê°„ ê³„ì‚°ê°’ ì‚¬ìš©:', {
                              ì„œë²„ì‘ë‹µ: balanceDay,
                              ì‹¤ì‹œê°„ê³„ì‚°: calculatedBalance,
                              ì´ì—°ì°¨: totDay,
                              ì‚¬ìš©ì—°ì°¨: useDay
                          });
                          balanceDay = calculatedBalance;
                      }
                  }

                  const accurateBalance = Math.round(balanceDay * 10) / 10;
                  row.find('.annual-balance').text(accurateBalance.toFixed(1));
              })
              .fail(function() {
                  row.find('.annual-balance').text('0.0');
                  console.error('ì—°ì°¨ì”ì—¬ ì¡°íšŒ ì‹¤íŒ¨:', empCode);
              });
      }

      function loadAnnualBalance(empCode, callback) {
          $.get(`/user/apply/annual/${empCode}`)
              .done(function(annual) {
                  callback(annual);
              })
              .fail(function() {
                  callback({balanceDay: '0'});
              });
      }

      // ì¼ë°˜ê·¼íƒœ ì €ì¥
      function saveGeneralApply() {
          const selectedRows = $('#generalEmployeeTable .emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              alert('ì €ì¥í•  ì‚¬ì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
              return;
          }

          const absentRows = selectedRows.filter(function() {
              return $(this).data('is-absent') === true;
          });

          if (absentRows.length > 0) {
              alert('ì‹¤ì ì´ ê²°ê·¼ì¼ ê²½ìš° ì‹ ì²­í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              return;
          }

          let hasError = false;

          selectedRows.each(function() {
              if (hasError) return false;

              const row = $(this);
              const empCode = row.data('emp-code');
              const workSelect = row.find('.work-select').val() || row.find('.work-type-display').text();
              const startTime = row.find('.start-time').val().replace(':', '');
              const endTime = row.find('.end-time').val().replace(':', '');
              const reason = row.find('.reason-field').val();
              const planShift = row.data('plan');
              const recordShift = row.data('record');

              const applyType = $('#generalApplyType').val();

              // 30ë¶„ ë‹¨ìœ„ ê²€ì¦
              if (startTime && endTime && !validate30MinuteInterval(row.find('.start-time').val(), row.find('.end-time').val(), workSelect)) {
                  alert(`${row.find('td:eq(2)').text()} ì‚¬ì›: ì—°ì¥, íœ´ì¼ê·¼ë¬´, ì¡°í‡´, ì™¸ì¶œ, ì™¸ê·¼ì€ íœ´ê²Œì‹œê°„ì„ ì œì™¸í•˜ê³  30ë¶„ ë‹¨ìœ„ë¡œë§Œ ì‹ ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                  hasError = true;
                  return false;
              }

              if (workSelect === 'ì—°ì¥' || workSelect === 'ì¡°ì¶œì—°ì¥') {
                  // ì‹¤ì ì´ íœ´ì¼ê·¼ë¬´ì¸ ê²½ìš° 8ì‹œê°„ ì´ìƒ ì‹ ì²­ ì—¬ë¶€ í™•ì¸
                  if (recordShift === 'íœ´ì¼ê·¼ë¬´') {
                      // ê°™ì€ ë‚ ì§œì— íœ´ì¼ê·¼ë¬´ ì‹ ì²­ì´ ìˆëŠ”ì§€ í™•ì¸
                      let holidayWorkRow = null;
                      $('#generalEmployeeTable tbody tr').each(function() {
                          const rowEmpCode = $(this).data('emp-code');
                          const workType = $(this).find('.work-type-display').text() || $(this).find('.work-select').val();

                          if (rowEmpCode === empCode && workType === 'íœ´ì¼ê·¼ë¬´') {
                              holidayWorkRow = $(this);
                              return false; // break
                          }
                      });

                      if (holidayWorkRow) {
                          const holidayStartTime = holidayWorkRow.find('.start-time').val();
                          const holidayEndTime = holidayWorkRow.find('.end-time').val();

                          if (holidayStartTime && holidayEndTime) {
                              const startHour = parseInt(holidayStartTime.split(':')[0]);
                              const startMin = parseInt(holidayStartTime.split(':')[1]);
                              const endHour = parseInt(holidayEndTime.split(':')[0]);
                              const endMin = parseInt(holidayEndTime.split(':')[1]);

                              let totalMinutes = (endHour * 60 + endMin) - (startHour * 60 + startMin);

                              // ìì • ë„˜ì–´ê°€ëŠ” ê²½ìš° ì²˜ë¦¬
                              if (totalMinutes <= 0) {
                                  totalMinutes += 24 * 60;
                              }

                              let breakTime = 0;
                              const morningBreakStart = 11 * 60 + 30; // 690ë¶„
                              const morningBreakEnd = 12 * 60 + 20;   // 740ë¶„
                              const workStart = startHour * 60 + startMin;
                              const workEnd = endHour * 60 + endMin;

                              if (workStart < morningBreakEnd && workEnd > morningBreakStart) {
                                  const overlapStart = Math.max(workStart, morningBreakStart);
                                  const overlapEnd = Math.min(workEnd, morningBreakEnd);
                                  breakTime = Math.max(0, overlapEnd - overlapStart);
                              }

                              const netWorkMinutes = totalMinutes - breakTime;

                              if (netWorkMinutes < 480) { // ìˆœìˆ˜ 8ì‹œê°„ = 480ë¶„
                                  alert(`${row.find('td:eq(2)').text()} ì‚¬ì›: íœ´ì¼ê·¼ë¬´ ìˆœìˆ˜ 8ì‹œê°„ ì´ìƒ ì‹ ì²­í•œ ê²½ìš°ì—ë§Œ ì—°ì¥ê·¼ë¬´ë¥¼ ì‹ ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (í˜„ì¬: ${(netWorkMinutes/60).toFixed(1)}ì‹œê°„)`);
                                  hasError = true;
                                  return false;
                              }

                              console.log('íœ´ì¼ê·¼ë¬´ ìˆœìˆ˜ 8ì‹œê°„ ê²€ì¦ í†µê³¼ (ì „ìš© íœ´ê²Œì‹œê°„):', netWorkMinutes + 'ë¶„');
                          } else {
                              alert(`${row.find('td:eq(2)').text()} ì‚¬ì›: íœ´ì¼ê·¼ë¬´ ì‹œê°„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.`);
                              hasError = true;
                              return false;
                          }
                      }
                  }
              }

              // ì¡°ì¶œì—°ì¥ ì‹œê°„ ì œí•œ
              if (workSelect === 'ì¡°ì¶œì—°ì¥') {
                  if (startTime && endTime) {
                      const startTimeInt = parseInt(startTime);
                      const endTimeInt = parseInt(endTime);

                      if (startTimeInt > 730 || endTimeInt > 730) {
                          alert(`${row.find('td:eq(2)').text()} ì‚¬ì›: ì¡°ì¶œì—°ì¥ì€ 07:30ê¹Œì§€ë§Œ ì‹ ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                          hasError = true;
                          return false;
                      }
                  }
              }

              // ì—°ì¥ê·¼ë¡œ ê²€ì¦
              if (workSelect === 'ì—°ì¥' || workSelect === 'ì¡°ì¶œì—°ì¥') {
                  // ì‹¤ì ì´ ê²°ê·¼ì¼ ê²½ìš° ì‹ ì²­ ë¶ˆê°€
                  if (recordShift === 'ê²°ê·¼') {
                      alert(`${row.find('td:eq(2)').text()} ì‚¬ì›: ì‹¤ì ì´ ê²°ê·¼ì¼ ê²½ìš° ì—°ì¥ê·¼ë¬´ë¥¼ ì‹ ì²­í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                      hasError = true;
                      return false;
                  }

                  // ì‹œê°„ ê²€ì¦
                  if (startTime && endTime) {
                      const startTimeInt = parseInt(startTime);
                      const endTimeInt = parseInt(endTime);

                      if (startTimeInt >= endTimeInt) {
                          alert(`${row.find('td:eq(2)').text()} ì‚¬ì›: ì‹œì‘ì‹œê°„ì´ ì¢…ë£Œì‹œê°„ë³´ë‹¤ ëŠ¦ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                          hasError = true;
                          return false;
                      }

                      if (workSelect === 'ì—°ì¥') {
                          if (startTimeInt < 1620) {
                              alert(`${row.find('td:eq(2)').text()} ì‚¬ì›: ì •ìƒê·¼ë¬´ì‹œê°„(16:20) ì´í›„ì—ë§Œ ì—°ì¥ê·¼ë¬´ë¥¼ ì‹ ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                              hasError = true;
                              return false;
                          }
                      }
                  }
              }

              // íœ´ì¼ê·¼ë¡œ ê²€ì¦
              if (workSelect === 'íœ´ì¼ê·¼ë¬´') {
                  // íœ´ì¼ ë˜ëŠ” íœ´ë¬´ì¼ì—ë§Œ ì‹ ì²­ ê°€ëŠ¥
                  if (planShift !== 'íœ´ì¼' && planShift !== 'íœ´ë¬´ì¼') {
                      alert(`${row.find('td:eq(2)').text()} ì‚¬ì›: íœ´ì¼ê·¼ë¡œëŠ” íœ´ì¼ ë˜ëŠ” íœ´ë¬´ì¼ì—ë§Œ ì‹ ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                      hasError = true;
                      return false;
                  }

                  // ì—°ì°¨, íœ´ê°€, ê²°ê·¼ ë“±ì˜ ë‚ ì€ ì‹ ì²­ ë¶ˆê°€
                  if (['ì—°ì°¨', 'íœ´ê°€', 'ê²°ê·¼'].includes(recordShift)) {
                      alert(`${row.find('td:eq(2)').text()} ì‚¬ì›: ì—°ì°¨, íœ´ê°€, ê²°ê·¼ ë“±ì˜ ë‚ ì—ëŠ” íœ´ì¼ê·¼ë¡œë¥¼ ì‹ ì²­í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                      hasError = true;
                      return false;
                  }
              }

              // ì¡°í‡´/ì™¸ì¶œ/ë°˜ì°¨ ê²€ì¦ (ì¼ë°˜ê·¼íƒœ)
              if (['ì¡°í‡´', 'ì™¸ê·¼', 'ì™¸ì¶œ', 'ì „ë°˜ì°¨', 'í›„ë°˜ì°¨'].includes(workSelect)) {
                  // ì •ìƒ ê·¼ë¬´ê°€ ì•„ë‹Œ ê²½ìš° ì‹ ì²­ ë¶ˆê°€
                  if (['ê²°ê·¼', 'ì—°ì°¨', 'íœ´ê°€', 'íœ´ì¼', 'íœ´ì§'].includes(recordShift)) {
                      alert(`${row.find('td:eq(2)').text()} ì‚¬ì›: ì •ìƒ ê·¼ë¬´ê°€ ì•„ë‹Œ ê²½ìš°ì—ëŠ” ${workSelect}ì„(ë¥¼) ì‹ ì²­í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                      hasError = true;
                      return false;
                  }
              }

              // ì¡°í‡´/ì™¸ì¶œ/ë°˜ì°¨ê°€ ì•„ë‹Œ ê²½ìš° ì£¼ 52ì‹œê°„ ê²€ì¦
              if (applyType !== 'ì¡°í‡´ì™¸ì¶œë°˜ì°¨') {
                  const expectedHoursSpan = row.find('.expected-hours');
                  if (expectedHoursSpan.hasClass('text-red-500')) {
                      alert(`${row.find('td:eq(2)').text()} ì‚¬ì›: ì£¼ 52ì‹œê°„ì„ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                      hasError = true;
                      return false;
                  }
              }

              if (!hasError) {
                  const data = {
                      empCode: empCode,
                      timeItemCode: 'T001',
                      targetDate: $('#generalWorkDate').val().replace(/-/g, ''),
                      startTime: startTime,
                      endTime: endTime,
                      applyType: workSelect,
                      reason: reason
                  };

                  $.ajax({
                      url: '/user/apply/general',
                      method: 'POST',
                      contentType: 'application/json',
                      data: JSON.stringify(data),
                      success: function(response) {
                          if (response.result === 'success') {
                              row.find('.status-field').text('ì €ì¥');
                              row.attr('data-apply-no', response.data.applyGeneralNo);
                              alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                              updateButtonStates();

                              // íœ´ì¼ê·¼ë¬´ ì €ì¥ ì‹œ ì‹¤ì  ì¦‰ì‹œ ê°±ì‹ 
                              if (workSelect === 'íœ´ì¼ê·¼ë¬´') {
                                  setTimeout(function() {
                                      const workDate = $('#generalWorkDate').val().replace(/-/g, '');

                                      // ê·¼ë¬´ì •ë³´ ë‹¤ì‹œ ì¡°íšŒí•˜ì—¬ ì‹¤ì  ì—…ë°ì´íŠ¸
                                      loadWorkInfo(empCode, workDate, function(updatedWorkInfo) {
                                          if (updatedWorkInfo.appliedRecord && updatedWorkInfo.appliedRecord.shiftName) {
                                              row.find('td:eq(6)').text(updatedWorkInfo.appliedRecord.shiftName);
                                              row.attr('data-record', updatedWorkInfo.appliedRecord.shiftName);
                                          }

                                          // ì˜ˆìƒê·¼ë¡œì‹œê°„ ì„œë²„ì—ì„œ ë‹¤ì‹œ ë°›ì•„ì˜¤ê¸°
                                          if (updatedWorkInfo.expectedHours) {
                                              row.find('.expected-hours').text(updatedWorkInfo.expectedHours);
                                              console.log('íœ´ì¼ê·¼ë¬´ ì €ì¥ í›„ ì˜ˆìƒê·¼ë¡œì‹œê°„ ì„œë²„ì—ì„œ ê°±ì‹ :', updatedWorkInfo.expectedHours);
                                          }
                                      });
                                  }, 500);
                              }
                          } else {
                              alert('ì €ì¥ ì‹¤íŒ¨: ' + (response.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                          }
                      },
                      error: function(xhr, status, error) {
                          console.error('ì¼ë°˜ê·¼íƒœ ì €ì¥ ì‹¤íŒ¨:', { xhr, status, error });
                          let errorMessage = 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';

                          if (xhr.responseJSON && xhr.responseJSON.message) {
                              errorMessage += '\n' + xhr.responseJSON.message;
                          } else if (xhr.responseText) {
                              try {
                                  const errorData = JSON.parse(xhr.responseText);
                                  if (errorData.message) {
                                      errorMessage += '\n' + errorData.message;
                                  }
                              } catch (e) {
                                  // JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ë©”ì‹œì§€ ì‚¬ìš©
                              }
                          }

                          alert(errorMessage);
                      }
                  });
              }
          });

          if (hasError) {
              return;
          }
      }

      // ê¸°íƒ€ê·¼íƒœ ì €ì¥
      function saveEtcApply() {
          const selectedRows = $('#etcEmployeeTable .emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              alert('ì €ì¥í•  ì‚¬ì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
              return;
          }

          const absentRows = selectedRows.filter(function() {
              return $(this).data('is-absent') === true;
          });

          if (absentRows.length > 0) {
              alert('ì‹¤ì ì´ ê²°ê·¼ì¼ ê²½ìš° ì‹ ì²­í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              return;
          }

          selectedRows.each(function() {
              const row = $(this);
              const empCode = row.data('emp-code');
              const shiftCode = row.find('.shift-select').val();
              const startDate = row.find('.start-date').val().replace(/-/g, '');
              const endDate = row.find('.end-date').val().replace(/-/g, '');
              const applyDateTime = row.find('.apply-time').val();
              const reason = row.find('.reason-field').val();

              if (!shiftCode || !startDate || !endDate) {
                  alert('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                  return;
              }

              // ì—°ì°¨ ì‚¬ìš© ì‹œ ì”ì—¬ ì—°ì°¨ í™•ì¸
              const selectedShift = shiftMasters.find(shift => shift.shiftCode === shiftCode);
              if (selectedShift && (selectedShift.shiftName.includes('ì—°ì°¨') || selectedShift.shiftName.includes('íœ´ê°€'))) {
                  const currentBalance = parseFloat(row.find('.annual-balance').text());
                  const requestDays = calculateRequestDays(startDate, endDate);

                  if (currentBalance < requestDays) {
                      alert(`ì—°ì°¨ ì”ì—¬ì¼ìˆ˜ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. (í•„ìš”: ${requestDays}ì¼, ì”ì—¬: ${currentBalance.toFixed(1)}ì¼)`);
                      return;
                  }
              }

              const data = {
                  empCode: empCode,
                  shiftCode: shiftCode,
                  targetStartDate: startDate,
                  targetEndDate: endDate,
                  applyDateTime: applyDateTime,
                  reason: reason
              };

              $.ajax({
                  url: '/user/apply/etc',
                  method: 'POST',
                  contentType: 'application/json',
                  data: JSON.stringify(data),
                  success: function(response) {
                      if (response.result === 'success') {
                          row.find('.status-field').text('ì €ì¥');
                          row.attr('data-apply-no', response.data.applyEtcNo);
                          alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                          updateButtonStates();

                          // ê¸°íƒ€ê·¼íƒœ ì €ì¥ í›„ ì‹¤ì  ì—…ë°ì´íŠ¸
                          setTimeout(function() {
                              loadWorkInfo(empCode, $('#etcWorkDate').val().replace(/-/g, ''), function(updatedWorkInfo) {
                                  if (updatedWorkInfo.appliedRecord && updatedWorkInfo.appliedRecord.shiftName) {
                                      row.find('td:eq(6)').text(updatedWorkInfo.appliedRecord.shiftName);
                                  }
                              });
                          }, 500);
                      } else {
                          alert('ì €ì¥ ì‹¤íŒ¨: ' + (response.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                      }
                  },
                  error: function(xhr, status, error) {
                      console.error('ê¸°íƒ€ê·¼íƒœ ì €ì¥ ì‹¤íŒ¨:', { xhr, status, error });
                      alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                  }
              });
          });
      }

      // ì‹ ì²­ ì¼ìˆ˜ ê³„ì‚° í•¨ìˆ˜
      function calculateRequestDays(startDate, endDate) {
          const start = new Date(startDate.substring(0,4), startDate.substring(4,6)-1, startDate.substring(6,8));
          const end = new Date(endDate.substring(0,4), endDate.substring(4,6)-1, endDate.substring(6,8));
          const diffTime = Math.abs(end - start);
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
          return diffDays;
      }

      // ì¼ë°˜ê·¼íƒœ ì‚­ì œ
      function deleteGeneralApply() {
          const selectedRows = $('#generalEmployeeTable .emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              alert('ì‚­ì œí•  ì‚¬ì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
              return;
          }

          if (!confirm('ì„ íƒëœ ì‹ ì²­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
              return;
          }

          selectedRows.each(function() {
              const row = $(this);
              const applyNo = row.data('apply-no');

              if (!applyNo) {
                  alert('ì‚­ì œí•  ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤.');
                  return;
              }

              $.ajax({
                  url: '/user/apply/delete/general',
                  method: 'POST',
                  data: { applyGeneralNo: applyNo },
                  success: function(response) {
                      if (response === 'success') {
                          alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                          searchGeneralEmployees();
                      } else {
                          alert('ì‚­ì œ ì‹¤íŒ¨: ' + response);
                      }
                  },
                  error: function() {
                      alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                  }
              });
          });
      }

      // ê¸°íƒ€ê·¼íƒœ ì‚­ì œ
      function deleteEtcApply() {
          const selectedRows = $('#etcEmployeeTable .emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              alert('ì‚­ì œí•  ì‚¬ì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
              return;
          }

          if (!confirm('ì„ íƒëœ ì‹ ì²­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
              return;
          }

          selectedRows.each(function() {
              const row = $(this);
              const applyNo = row.data('apply-no');

              if (!applyNo) {
                  alert('ì‚­ì œí•  ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤.');
                  return;
              }

              $.ajax({
                  url: '/user/apply/delete/etc',
                  method: 'POST',
                  data: { applyEtcNo: applyNo },
                  success: function(response) {
                      if (response === 'success') {
                          alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                          searchEtcEmployees();
                      } else {
                          alert('ì‚­ì œ ì‹¤íŒ¨: ' + response);
                      }
                  },
                  error: function() {
                      alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                  }
              });
          });
      }

      // ì¼ë°˜ê·¼íƒœ ìƒì‹ 
      function submitGeneralApply() {
          const selectedRows = $('#generalEmployeeTable .emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              alert('ìƒì‹ í•  ì‚¬ì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
              return;
          }

          const absentRows = selectedRows.filter(function() {
              return $(this).data('is-absent') === true;
          });

          if (absentRows.length > 0) {
              alert('ì‹¤ì ì´ ê²°ê·¼ì¼ ê²½ìš° ì‹ ì²­í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              return;
          }

          const invalidRows = selectedRows.filter(function() {
              const expectedHoursSpan = $(this).find('.expected-hours');
              return expectedHoursSpan.hasClass('text-red-500');
          });

          if (invalidRows.length > 0) {
              alert('ì£¼ 52ì‹œê°„ì„ ì´ˆê³¼í•˜ëŠ” ì‚¬ì›ì´ ìˆìŠµë‹ˆë‹¤. ìƒì‹ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              return;
          }

          selectedRows.each(function() {
              const row = $(this);
              const applyNo = row.data('apply-no');

              if (!applyNo) {
                  alert('ìƒì‹ í•  ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤.');
                  return;
              }

              $.ajax({
                  url: '/user/apply/submit/general',
                  method: 'POST',
                  data: {
                      applyGeneralNo: applyNo,
                      isHeader: currentUser.isHeader
                  },
                  success: function(response) {
                      if (response === 'success') {
                          const finalStatus = currentUser.isHeader === 'Y' ? 'ìŠ¹ì¸ì™„ë£Œ' : 'ìƒì‹ ';
                          row.find('.status-field').text(finalStatus);
                          alert(currentUser.isHeader === 'Y' ? 'ìë™ ìŠ¹ì¸ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ìƒì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.');
                          updateButtonStates();

                          // ë¶€ì„œì¥ ìŠ¹ì¸ì™„ë£Œ ì‹œ ëª¨ë“  ê·¼íƒœ ì˜ˆìƒê·¼ë¡œì‹œê°„ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                          if (finalStatus === 'ìŠ¹ì¸ì™„ë£Œ') {
                              setTimeout(function() {
                                  const empCode = row.data('emp-code');
                                  const workDate = $('#generalWorkDate').val().replace(/-/g, '');

                                  // ëª¨ë“  ìŠ¹ì¸ì™„ë£Œëœ ê·¼íƒœì— ëŒ€í•´ ì‹¤ì  ë° ì˜ˆìƒê·¼ë¡œì‹œê°„ ì—…ë°ì´íŠ¸
                                  loadWorkInfo(empCode, workDate, function(updatedWorkInfo) {
                                      if (updatedWorkInfo.appliedRecord && updatedWorkInfo.appliedRecord.shiftName) {
                                          row.find('td:eq(6)').text(updatedWorkInfo.appliedRecord.shiftName);
                                          row.attr('data-record', updatedWorkInfo.appliedRecord.shiftName);
                                          console.log('ìŠ¹ì¸ì™„ë£Œ í›„ ì‹¤ì  ì—…ë°ì´íŠ¸:', updatedWorkInfo.appliedRecord.shiftName);
                                      }
                                      if (updatedWorkInfo.expectedHours) {
                                          row.find('.expected-hours').text(updatedWorkInfo.expectedHours);
                                          console.log('ìŠ¹ì¸ì™„ë£Œ í›„ ì˜ˆìƒê·¼ë¡œì‹œê°„ ì¦‰ì‹œ ì—…ë°ì´íŠ¸:', updatedWorkInfo.expectedHours);
                                      }
                                  });
                              }, 500);
                          }
                      } else {
                          alert('ìƒì‹  ì‹¤íŒ¨: ' + response);
                      }
                  },
                  error: function() {
                      alert('ìƒì‹ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                  }
              });
          });
      }

      // ê¸°íƒ€ê·¼íƒœ ìƒì‹ 
      function submitEtcApply() {
          const selectedRows = $('#etcEmployeeTable .emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              alert('ìƒì‹ í•  ì‚¬ì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
              return;
          }

          const absentRows = selectedRows.filter(function() {
              return $(this).data('is-absent') === true;
          });

          if (absentRows.length > 0) {
              alert('ê²°ê·¼ ì‚¬ì›ì€ ê·¼íƒœ ì‹ ì²­ì„ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              return;
          }

          selectedRows.each(function() {
              const row = $(this);
              const applyNo = row.data('apply-no');

              if (!applyNo) {
                  alert('ìƒì‹ í•  ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤.');
                  return;
              }

              $.ajax({
                  url: '/user/apply/submit/etc',
                  method: 'POST',
                  data: {
                      applyEtcNo: applyNo,
                      isHeader: currentUser.isHeader
                  },
                  success: function(response) {
                      if (response === 'success') {
                          const finalStatus = currentUser.isHeader === 'Y' ? 'ìŠ¹ì¸ì™„ë£Œ' : 'ìƒì‹ ';
                          row.find('.status-field').text(finalStatus);

                          if (finalStatus === 'ìŠ¹ì¸ì™„ë£Œ') {
                              const shiftCode = row.find('.shift-select').val();
                              const selectedShift = shiftMasters.find(shift => shift.shiftCode === shiftCode);
                              if (selectedShift && (selectedShift.shiftName.includes('ì—°ì°¨') || selectedShift.shiftName.includes('ë°˜ì°¨'))) {
                                  const startDate = row.find('.start-date').val().replace(/-/g, '');
                                  const endDate = row.find('.end-date').val().replace(/-/g, '');
                                  let requestDays = calculateRequestDays(startDate, endDate);

                                  if (selectedShift.shiftName.includes('ë°˜ì°¨')) {
                                      requestDays = 0.5;
                                  }

                                  const currentBalance = parseFloat(row.find('.annual-balance').text());

                                  // ì •í™•í•œ ì†Œìˆ˜ì  ê³„ì‚°
                                  const newBalance = Math.round((currentBalance - requestDays) * 10) / 10;

                                  row.find('.annual-balance').text(newBalance.toFixed(1));

                                  console.log('ì—°ì°¨ ì •í™•í•œ ì†Œìˆ˜ì  ì°¨ê° ê³„ì‚°:', {
                                      ê¸°ì¡´ì”ì—¬: currentBalance.toFixed(1),
                                      ì°¨ê°ì¼ìˆ˜: requestDays,
                                      ì°¨ê°í›„ì”ì—¬: newBalance.toFixed(1)
                                  });
                              }
                          }

                          // ê¸°íƒ€ê·¼íƒœ ìŠ¹ì¸ì™„ë£Œ ì‹œ ì¼ë°˜ê·¼íƒœíƒ­ ì˜ˆìƒê·¼ë¡œì‹œê°„ë„ ì—…ë°ì´íŠ¸
                          if (finalStatus === 'ìŠ¹ì¸ì™„ë£Œ') {
                              setTimeout(function() {
                                  const empCode = row.data('emp-code');
                                  const workDate = $('#etcWorkDate').val().replace(/-/g, '');

                                  // ì‹¤ì  ì—…ë°ì´íŠ¸
                                  loadWorkInfo(empCode, workDate, function(updatedWorkInfo) {
                                      if (updatedWorkInfo.appliedRecord && updatedWorkInfo.appliedRecord.shiftName) {
                                          row.find('td:eq(6)').text(updatedWorkInfo.appliedRecord.shiftName);
                                          console.log('ê¸°íƒ€ê·¼íƒœ ìŠ¹ì¸ì™„ë£Œ í›„ ì‹¤ì  ì—…ë°ì´íŠ¸:', updatedWorkInfo.appliedRecord.shiftName);
                                      }
                                  });
                              }, 500);
                          }

                          alert(currentUser.isHeader === 'Y' ? 'ìë™ ìŠ¹ì¸ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ìƒì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.');
                          updateButtonStates();

                      } else {
                          alert('ìƒì‹  ì‹¤íŒ¨: ' + response);
                      }
                  },
                  error: function() {
                      alert('ìƒì‹ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                  }
              });
          });
      }

      // ì¼ë°˜ê·¼íƒœ ìƒì‹ ì·¨ì†Œ
      function cancelGeneralApply() {
          const selectedRows = $('#generalEmployeeTable .emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              alert('ìƒì‹ ì·¨ì†Œí•  ì‚¬ì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
              return;
          }

          selectedRows.each(function() {
              const row = $(this);
              const applyNo = row.data('apply-no');

              if (!applyNo) {
                  alert('ìƒì‹ ì·¨ì†Œí•  ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤.');
                  return;
              }

              $.ajax({
                  url: '/user/apply/cancel/general',
                  method: 'POST',
                  data: { applyGeneralNo: applyNo },
                  success: function(response) {
                      if (response === 'success') {
                          row.find('.status-field').text('ì €ì¥');
                          alert('ìƒì‹ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                          updateButtonStates();
                      } else {
                          alert('ìƒì‹ ì·¨ì†Œ ì‹¤íŒ¨: ' + response);
                      }
                  },
                  error: function() {
                      alert('ìƒì‹ ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                  }
              });
          });
      }

      // ê¸°íƒ€ê·¼íƒœ ìƒì‹ ì·¨ì†Œ
      function cancelEtcApply() {
          const selectedRows = $('#etcEmployeeTable .emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              alert('ìƒì‹ ì·¨ì†Œí•  ì‚¬ì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
              return;
          }

          selectedRows.each(function() {
              const row = $(this);
              const applyNo = row.data('apply-no');

              if (!applyNo) {
                  alert('ìƒì‹ ì·¨ì†Œí•  ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤.');
                  return;
              }

              $.ajax({
                  url: '/user/apply/cancel/etc',
                  method: 'POST',
                  data: { applyEtcNo: applyNo },
                  success: function(response) {
                      if (response === 'success') {
                          row.find('.status-field').text('ì €ì¥');
                          alert('ìƒì‹ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                          updateButtonStates();
                      } else {
                          alert('ìƒì‹ ì·¨ì†Œ ì‹¤íŒ¨: ' + response);
                      }
                  },
                  error: function() {
                      alert('ìƒì‹ ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                  }
              });
          });
      }

      // ì „ì²´ì„ íƒ ê¸°ëŠ¥
      $(document).on('change', '#selectAllGeneral', function() {
          const isChecked = $(this).is(':checked');
          $('#generalEmployeeTable .emp-checkbox').prop('checked', isChecked);
          updateButtonStates();
      });

      $(document).on('change', '#selectAllEtc', function() {
          const isChecked = $(this).is(':checked');
          $('#etcEmployeeTable .emp-checkbox').prop('checked', isChecked);
          updateButtonStates();
      });

      // ê°œë³„ ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œ ì „ì²´ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
      $(document).on('change', '#generalEmployeeTable .emp-checkbox', function() {
          const totalCheckboxes = $('#generalEmployeeTable .emp-checkbox').length;
          const checkedCheckboxes = $('#generalEmployeeTable .emp-checkbox:checked').length;

          if (totalCheckboxes === checkedCheckboxes) {
              $('#selectAllGeneral').prop('checked', true);
          } else {
              $('#selectAllGeneral').prop('checked', false);
          }
          updateButtonStates();
      });

      $(document).on('change', '#etcEmployeeTable .emp-checkbox', function() {
          const totalCheckboxes = $('#etcEmployeeTable .emp-checkbox').length;
          const checkedCheckboxes = $('#etcEmployeeTable .emp-checkbox:checked').length;

          if (totalCheckboxes === checkedCheckboxes) {
              $('#selectAllEtc').prop('checked', true);
          } else {
              $('#selectAllEtc').prop('checked', false);
          }
          updateButtonStates();
      });

      $('#generalWorkDate').change(function() {
          setTimeout(function() {
              searchGeneralEmployees();
          }, 100);
      });

      $('#etcWorkDate').change(function() {
          setTimeout(function() {
              searchEtcEmployees();
          }, 100);
      });

      $('#generalDeptSelect').change(function() {
          setTimeout(function() {
              searchGeneralEmployees();
          }, 100);
      });

      $('#etcDeptSelect').change(function() {
          setTimeout(function() {
              searchEtcEmployees();
          }, 100);
      });

      // ê·¼ë¬´ê³„íš ë³€ê²½ ì‹œ ìë™ ì¡°íšŒ (ê¸°íƒ€ê·¼íƒœ)
      $('#etcWorkPlan').change(function() {
          setTimeout(function() {
              searchEtcEmployees();
          }, 100);
      });

      // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ì´ˆê¸°í™”
      if (!$('#generalEmployeeTable thead th:first-child input[type="checkbox"]').length) {
          $('#generalEmployeeTable thead th:first-child').html('<input type="checkbox" id="selectAllGeneral"> ì„ íƒ');
      }

      if (!$('#etcEmployeeTable thead th:first-child input[type="checkbox"]').length) {
          $('#etcEmployeeTable thead th:first-child').html('<input type="checkbox" id="selectAllEtc"> ì„ íƒ');
      }
  });
</script>

<script>
  // URLì—ì„œ íŠ¹ì • ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ê°’ì„ ì½ëŠ” í•¨ìˆ˜ (í•œ ì¤„ ë²„ì „)
  const getQueryParam = param => new URLSearchParams(window.location.search).get(param);

  function selectOptionByValue(selectId, value) {
    const select = document.getElementById(selectId);
    if (!select) return;
    const option = Array.from(select.options).find(opt => opt.value === value);
    if (option) option.selected = true;
  }

  document.addEventListener("DOMContentLoaded", () => {
    const deptCode = getQueryParam("deptCode");
    if (!deptCode) return;

    ["generalDeptSelect", "etcDeptSelect"].forEach(id => selectOptionByValue(id, deptCode));
  });
</script>

</body>
</html>