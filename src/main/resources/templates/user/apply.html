<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>근태 신청</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-gray-100 p-6">

<div class="max-w-full mx-auto bg-white rounded shadow">
  <!-- 헤더 -->
  <div class="bg-blue-600 text-white p-4 rounded-t">
    <h1 class="text-2xl font-bold">근태 신청</h1>
    <p>현재 사용자:
      <span th:text="${currentEmp?.empName} ?: '정보없음'"></span>
      (<span th:text="${currentEmp?.empCode} ?: 'N/A'"></span>)
      <!-- 부서장 여부 표시 -->
      <span th:if="${currentEmp?.isHeader == 'Y'}" class="bg-yellow-500 text-black px-2 py-1 rounded text-sm ml-2">부서장</span>
    </p>
  </div>

  <!-- 탭 메뉴 -->
  <div class="border-b border-gray-200">
    <nav class="flex space-x-8">
      <button id="generalTab" class="tab-button active bg-blue-500 text-white px-4 py-2 rounded-t">
        일반근태 신청
      </button>
      <button id="etcTab" class="tab-button bg-gray-300 text-gray-700 px-4 py-2 rounded-t">
        기타근태 신청
      </button>
    </nav>
  </div>

  <!-- 일반근태 신청 탭 -->
  <div id="generalPanel" class="tab-panel p-6">
    <h2 class="text-xl font-semibold mb-4">일반근태 신청 (연장, 휴일근로, 조퇴/외출/반차)</h2>

    <!-- 검색 조건 -->
    <div class="bg-gray-50 p-4 rounded mb-6">
      <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">근태신청종류</label>
          <select id="generalApplyType" class="mt-1 block w-full border border-gray-300 rounded p-2">
            <option value="연장근로">연장근로</option>
            <option value="휴일근로">휴일근로</option>
            <option value="조퇴외출반차">조퇴/외출/반차</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">신청근무</label>
          <select id="generalWorkTypeFilter" class="mt-1 block w-full border border-gray-300 rounded p-2">
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">근무일</label>
          <input type="date" id="generalWorkDate" class="mt-1 block w-full border border-gray-300 rounded p-2"
                 th:value="${today}">
        </div>
        <!-- 부서 드롭다운 -->
        <div>
          <label class="block text-sm font-medium text-gray-700">부서</label>
          <select id="generalDeptSelect" class="mt-1 block w-full border border-gray-300 rounded p-2">
            <option th:value="${currentEmp.deptCode}" th:text="${currentEmp.deptName}" selected></option>
            <!-- 부서장인 경우 하위부서 옵션 동적 로드 -->
            <option th:each="dept : ${availableDepartments}"
                    th:if="${dept.deptCode != currentEmp.deptCode}"
                    th:value="${dept.deptCode}"
                    th:text="${dept.deptName}"
            ></option>
          </select>
        </div>
        <div class="flex items-end space-x-2 col-span-2">
          <button id="searchGeneralBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
            조회
          </button>
          <button id="saveGeneralBtn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
            저장
          </button>
          <button id="deleteGeneralBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
            삭제
          </button>
          <button id="submitGeneralBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
            상신
          </button>
          <button id="cancelGeneralBtn" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
            상신취소
          </button>
        </div>
      </div>
    </div>

    <!-- 사원 목록 테이블 -->
    <div class="overflow-x-auto mb-6">
      <table id="generalEmployeeTable" class="min-w-full border-collapse border border-gray-300">
        <thead class="bg-gray-100">
        <tr>
          <th class="border border-gray-300 px-4 py-2">
            <input type="checkbox" id="selectAllGeneral"> 선택
          </th>
          <th class="border border-gray-300 px-4 py-2">사번</th>
          <th class="border border-gray-300 px-4 py-2">성명</th>
          <th class="border border-gray-300 px-4 py-2">직위</th>
          <th class="border border-gray-300 px-4 py-2">부서</th>
          <th class="border border-gray-300 px-4 py-2">계획</th>
          <th class="border border-gray-300 px-4 py-2">실적</th>
          <th class="border border-gray-300 px-4 py-2">신청근무</th>
          <th class="border border-gray-300 px-4 py-2">시작시간</th>
          <th class="border border-gray-300 px-4 py-2">종료시간</th>
          <th class="border border-gray-300 px-4 py-2">예상근로시간</th>
          <th class="border border-gray-300 px-4 py-2">사유</th>
          <th class="border border-gray-300 px-4 py-2">상태</th>
          <th class="border border-gray-300 px-4 py-2">상신자</th>
        </tr>
        </thead>
        <tbody id="generalEmployeeBody">
        <!-- 동적으로 로드될 사원 목록 -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- 기타근태 신청 탭 -->
  <div id="etcPanel" class="tab-panel p-6 hidden">
    <h2 class="text-xl font-semibold mb-4">기타근태 신청 (근태 변경)</h2>

    <!-- 검색 조건 -->
    <div class="bg-gray-50 p-4 rounded mb-6">
      <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">근무일</label>
          <input type="date" id="etcWorkDate" class="mt-1 block w-full border border-gray-300 rounded p-2"
                 th:value="${today}">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">근무계획</label>
          <select id="etcWorkPlan" class="mt-1 block w-full border border-gray-300 rounded p-2">
            <option value="">전체</option>
            <option value="주간">주간</option>
            <option value="휴일">휴일</option>
            <option value="휴무일">휴무일</option>
          </select>
        </div>
        <!-- 부서 드롭다운 -->
        <div>
          <label class="block text-sm font-medium text-gray-700">부서</label>
          <select id="etcDeptSelect" class="mt-1 block w-full border border-gray-300 rounded p-2">
            <option th:value="${currentEmp.deptCode}" th:text="${currentEmp.deptName}" selected></option>
            <!-- 부서장인 경우 하위부서 옵션 동적 로드 -->
            <option th:each="dept : ${availableDepartments}"
                    th:if="${dept.deptCode != currentEmp.deptCode}"
                    th:value="${dept.deptCode}"
                    th:text="${dept.deptName}"></option>
          </select>
        </div>
        <div class="flex items-end space-x-2 col-span-3">
          <button id="searchEtcBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
            조회
          </button>
          <button id="saveEtcBtn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
            저장
          </button>
          <button id="deleteEtcBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
            삭제
          </button>
          <button id="submitEtcBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
            상신
          </button>
          <button id="cancelEtcBtn" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
            상신취소
          </button>
        </div>
      </div>
    </div>

    <!-- 사원 목록 테이블 -->
    <div class="overflow-x-auto mb-6">
      <table id="etcEmployeeTable" class="min-w-full border-collapse border border-gray-300">
        <thead class="bg-gray-100">
        <tr>
          <th class="border border-gray-300 px-4 py-2">
            <input type="checkbox" id="selectAllEtc"> 선택
          </th>
          <th class="border border-gray-300 px-4 py-2">사번</th>
          <th class="border border-gray-300 px-4 py-2">성명</th>
          <th class="border border-gray-300 px-4 py-2">직위</th>
          <th class="border border-gray-300 px-4 py-2">부서</th>
          <th class="border border-gray-300 px-4 py-2">계획</th>
          <th class="border border-gray-300 px-4 py-2">실적</th>
          <th class="border border-gray-300 px-4 py-2">변경근무</th>
          <th class="border border-gray-300 px-4 py-2">시작일</th>
          <th class="border border-gray-300 px-4 py-2">종료일</th>
          <th class="border border-gray-300 px-4 py-2">연차잔여</th>
          <th class="border border-gray-300 px-4 py-2">신청시각</th>
          <th class="border border-gray-300 px-4 py-2">사유</th>
          <th class="border border-gray-300 px-4 py-2">상태</th>
          <th class="border border-gray-300 px-4 py-2">상신자</th>
        </tr>
        </thead>
        <tbody id="etcEmployeeBody">
        <!-- 동적으로 로드될 사원 목록 -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  $(document).ready(function() {
      // 전역 변수에 현재 사용자 정보 저장
      const currentUser = {
          empCode: '[[${currentEmp.empCode}]]',
          empName: '[[${currentEmp.empName}]]',
          isHeader: '[[${currentEmp.isHeader}]]',
          deptCode: '[[${currentEmp.deptCode}]]'
      };

      // 연차잔여 정보 저장
      const currentAnnual = {
          balanceDay: '[[${annualDetail?.balanceDay} ?: 0]]'
      };

      let shiftMasters = [];
      let isEtcSearching = false;
      let isGeneralSearching = false;

      let expectedHoursCache = new Map();
      let workTypeSpecificCache = new Map(); // 신청근무별 개별 캐시
      let holidayWorkStatusCache = new Map(); // 휴일근무 상태 캐시

      // 신청근무 옵션 정의
      const workTypeOptions = {
          '연장근로': [
              { value: '연장', text: '연장' },
              { value: '조출연장', text: '조출연장' }
          ],
          '휴일근로': [
              { value: '휴일근무', text: '휴일근무' }
          ],
          '조퇴외출반차': [
              { value: '조퇴', text: '조퇴' },
              { value: '외근', text: '외근' },
              { value: '외출', text: '외출' },
              { value: '전반차', text: '전반차' },
              { value: '후반차', text: '후반차' }
          ]
      };

      // 탭 전환 기능
      $('.tab-button').click(function() {
        $('.tab-button').removeClass('active bg-blue-500 text-white').addClass('bg-gray-300 text-gray-700');
        $(this).removeClass('bg-gray-300 text-gray-700').addClass('active bg-blue-500 text-white');

        $('.tab-panel').addClass('hidden');

        if (this.id === 'generalTab') {
          $('#generalPanel').removeClass('hidden');
        } else {
          $('#etcPanel').removeClass('hidden');
        }
      });

      // URL 쿼리 파라미터에서 'tab' 값 읽기
      function getQueryParam(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
      }

      // 페이지 로드 시 탭 활성화 처리
      const activeTab = getQueryParam('tab');
      if (activeTab === 'etc') {
        // 기타근태신청 탭 활성화
        $('#etcTab').click();
      } else {
        // 기본값은 일반근태 신청 탭 활성화
        $('#generalTab').click();
      }

      // 근태 마스터 로드
      loadShiftMasters();

      updateWorkTypeFilter('연장근로');

      // 초기 데이터 로드
      setTimeout(function() {
          if (currentUser.deptCode && $('#generalWorkDate').val()) {
              searchGeneralEmployees();
          } else {
              console.warn('부서코드 또는 날짜가 설정되지 않음');
              if (!$('#generalDeptSelect').val() && currentUser.deptCode) {
                  $('#generalDeptSelect').val(currentUser.deptCode);
              }
              if ($('#generalWorkDate').val()) {
                  searchGeneralEmployees();
              }
          }
      }, 100);

      // 이벤트 핸들러
      $('#searchGeneralBtn').click(searchGeneralEmployees);
      $('#searchEtcBtn').click(searchEtcEmployees);
      $('#saveGeneralBtn').click(saveGeneralApply);
      $('#saveEtcBtn').click(saveEtcApply);
      $('#deleteGeneralBtn').click(deleteGeneralApply);
      $('#deleteEtcBtn').click(deleteEtcApply);
      $('#submitGeneralBtn').click(submitGeneralApply);
      $('#submitEtcBtn').click(submitEtcApply);
      $('#cancelGeneralBtn').click(cancelGeneralApply);
      $('#cancelEtcBtn').click(cancelEtcApply);

      $('#generalApplyType').change(function() {
          const selectedType = $(this).val();

          $('#generalEmployeeBody').empty();
          expectedHoursCache.clear();
          workTypeSpecificCache.clear();
          holidayWorkStatusCache.clear();

          updateWorkTypeOptions(selectedType);
          updateWorkTypeFilter(selectedType);

          const isLeaveType = selectedType === '조퇴외출반차';

          // 테이블 데이터 셀 숨기기/보이기
          $('#generalEmployeeTable .expected-hours').closest('td').toggleClass('hidden', isLeaveType);
          // 테이블 헤더 숨기기/보이기
          $('#generalEmployeeTable thead th:eq(10)').toggleClass('hidden', isLeaveType);

          setTimeout(function() {
              searchGeneralEmployees();
          }, 100);
      });

      $('#generalWorkTypeFilter').change(function() {
          const selectedWorkType = $(this).val();
          if (selectedWorkType) {
              handleWorkTypeChangeUltraComplete(selectedWorkType);
          }
          updateEmployeeWorkTypes(selectedWorkType);
      });

      // 근태 마스터 로드 함수
      function loadShiftMasters() {
          $.get('/user/apply/shift-masters')
              .done(function(data) {
                  shiftMasters = data;
              })
              .fail(function() {
                  console.error('근태 마스터 로드 실패');
              });
      }

      // 신청근무 옵션 업데이트 함수
      function updateWorkTypeOptions(applyType) {
          const options = workTypeOptions[applyType] || [];

          // 모든 신청근무 드롭다운 업데이트
          $('#generalEmployeeTable .work-select').each(function() {
              const currentValue = $(this).val();
              $(this).empty();

              options.forEach(function(option) {
                  $(this).append(`<option value="${option.value}">${option.text}</option>`);
              }.bind(this));

              // 이전 선택값이 새 옵션에 있으면 유지
              if (options.some(opt => opt.value === currentValue)) {
                  $(this).val(currentValue);
              }
          });
      }

      function updateWorkTypeFilter(applyType) {
          const options = workTypeOptions[applyType] || [];
          const filterSelect = $('#generalWorkTypeFilter');
          const currentValue = filterSelect.val();

          filterSelect.empty();

          if (currentUser.isHeader !== 'Y') {
              filterSelect.append('<option value="">전체</option>');
          }

          options.forEach(function(option) {
              filterSelect.append(`<option value="${option.value}">${option.text}</option>`);
          });

          if (options.length > 0 && (!currentValue || !options.some(opt => opt.value === currentValue))) {
              filterSelect.val(options[0].value);
          } else if (options.some(opt => opt.value === currentValue)) {
              filterSelect.val(currentValue);
          }
      }

      function updateEmployeeWorkTypes(selectedWorkType) {
          if (!selectedWorkType) return;

          $('#generalEmployeeTable tbody tr').each(function() {
              const workSelect = $(this).find('.work-select');
              if (workSelect.length > 0) {
                  workSelect.val(selectedWorkType);
                  validateWorkTimeRestrictionsUltimate($(this));
              }
          });
      }

      function handleWorkTypeChangeUltraComplete(selectedWorkType) {
          console.log('신청근무 변경:', selectedWorkType);

          $('#generalEmployeeTable tbody tr').each(function() {
              const row = $(this);
              const empCode = row.data('emp-code');
              const workDate = $('#generalWorkDate').val().replace(/-/g, '');

              // 신청근무별 분리
              loadApplyByTypeUltraComplete(empCode, workDate, selectedWorkType, row);
          });
      }

      function loadApplyByTypeUltraComplete(empCode, workDate, applyType, row) {
          console.log('신청근무별 기존 신청 조회:', empCode, workDate, applyType);

          $.get(`/user/apply/getApplyByWorkType/${empCode}/${workDate}/${applyType}`)
              .done(function(response) {
                  console.log('신청근무별 조회 응답:', response);

                  // 초기화 후 해당 신청근무 타입만 표시
                  row.find('.work-select').val(applyType);
                  row.find('.work-type-display').text(applyType);
                  row.find('.start-time').val('');
                  row.find('.end-time').val('');
                  row.find('.reason-field').val('');
                  row.find('.status-field').text('대기');
                  row.removeAttr('data-apply-no');

                  // 해당 신청근무 타입의 기존 신청이 있는 경우에만 복원
                  if (response.hasExisting && response.status !== '삭제' && response.applyType === 'general') {
                      if (response.startTime) {
                          row.find('.start-time').val(formatTimeDisplay(response.startTime));
                      }
                      if (response.endTime) {
                          row.find('.end-time').val(formatTimeDisplay(response.endTime));
                      }
                      row.find('.reason-field').val(response.reason || '');
                      row.find('.status-field').text(response.status || '대기');
                      row.attr('data-apply-no', response.applyNo);

                      console.log('해당 신청근무 타입의 기존 신청 복원:', response.applyNo, response.status, applyType);
                  } else {
                      console.log('해당 신청근무 타입의 기존 신청 없음 - 신청 가능 상태:', applyType);
                  }

                  updateExpectedHoursUltraStable(row, empCode, workDate, applyType);
                  validateWorkTimeRestrictionsUltimate(row);
                  updateButtonStates();

              })
              .fail(function() {
                  console.error('신청근무별 조회 실패');
                  row.find('.work-select').val(applyType);
                  row.find('.work-type-display').text(applyType);
                  row.find('.start-time').val('');
                  row.find('.end-time').val('');
                  row.find('.reason-field').val('');
                  row.find('.status-field').text('대기');
                  row.removeAttr('data-apply-no');

                  // 예상근로시간은 캐시에서 복원
                  updateExpectedHoursUltraStable(row, empCode, workDate, applyType);
              });
      }

      function updateExpectedHoursUltraStable(row, empCode, workDate, applyType) {
          const workTypeCacheKey = `${empCode}_${workDate}_${applyType}`;
          const baseCacheKey = `${empCode}_${workDate}`;
          const holidayCacheKey = `${empCode}_${workDate}_휴일근무`;

          if (applyType === '휴일근무') {
              if (expectedHoursCache.has(baseCacheKey)) {
                  const baseHours = expectedHoursCache.get(baseCacheKey);
                  row.find('.expected-hours').text(baseHours);
                  workTypeSpecificCache.set(workTypeCacheKey, baseHours);
                  return;
              }
          }

          const hasHolidayWork = checkHolidayWorkStatus(empCode, workDate);

          if (hasHolidayWork && applyType !== '휴일근무') {
              // 다른 근무에서 휴일근무가 있으면 그 시간 사용
              const holidayExpectedHours = holidayWorkStatusCache.get(holidayCacheKey) || expectedHoursCache.get(baseCacheKey) || '40.00';
              row.find('.expected-hours').text(holidayExpectedHours);
              workTypeSpecificCache.set(workTypeCacheKey, holidayExpectedHours);
              return;
          }

          if (workTypeSpecificCache.has(workTypeCacheKey)) {
              const cachedHours = workTypeSpecificCache.get(workTypeCacheKey);
              row.find('.expected-hours').text(cachedHours);
              return;
          }

          // 기본 캐시에서 확인
          if (expectedHoursCache.has(baseCacheKey)) {
              const cachedHours = expectedHoursCache.get(baseCacheKey);
              row.find('.expected-hours').text(cachedHours);
              workTypeSpecificCache.set(workTypeCacheKey, cachedHours);
              return;
          }

          $.get(`/user/apply/updateExpectedHours/${empCode}/${workDate}`)
              .done(function(response) {
                  if (response.success) {
                      const expectedHours = response.expectedHours;

                      if (expectedHours === "ERROR" || expectedHours === "error") {
                          row.find('.expected-hours').text("계산실패").addClass('text-red-500');
                          row.find('.expected-hours').attr('title', 'EmpAttService 계산 실패');
                          console.error('EmpAttService 계산 실패:', empCode);
                          return;
                      }

                      workTypeSpecificCache.set(workTypeCacheKey, expectedHours);
                      expectedHoursCache.set(baseCacheKey, expectedHours);

                      // 휴일근무인 경우 상태 캐시에도 저장
                      if (applyType === '휴일근무') {
                          holidayWorkStatusCache.set(holidayCacheKey, expectedHours);
                      }

                      row.find('.expected-hours').text(expectedHours).removeClass('text-red-500');
                      row.find('.expected-hours').removeAttr('title');
                      console.log('EmpAttService 활용 예상근로시간 조회 성공:', applyType, expectedHours);
                  }
              })
              .fail(function() {
                  console.error('예상근로시간 API 호출 실패');
                  row.find('.expected-hours').text("API실패").addClass('text-red-500');
              });
      }

      function checkHolidayWorkStatus(empCode, workDate) {
          const holidayCacheKey = `${empCode}_${workDate}_휴일근무`;

          // 캐시에서 먼저 확인
          if (holidayWorkStatusCache.has(holidayCacheKey)) {
              return true;
          }

          // 테이블에서 휴일근무 신청 확인
          let hasHolidayWork = false;
          $('#generalEmployeeTable tbody tr').each(function() {
              const rowEmpCode = $(this).data('emp-code');
              const workType = $(this).find('.work-type-display').text() || $(this).find('.work-select').val();
              const status = $(this).find('.status-field').text();

              if (rowEmpCode === empCode && workType === '휴일근무' &&
                  (status === '승인완료' || status === '저장' || status === '상신')) {
                  hasHolidayWork = true;
                  holidayWorkStatusCache.set(holidayCacheKey, '48.00');
                  return false; // break
              }
          });

          return hasHolidayWork;
      }

      // 30분 단위 검증
      function validate30MinuteInterval(startTime, endTime, applyType) {
          const restrictedTypes = ['연장', '조출연장', '휴일근무', '조퇴', '외출', '외근'];

          if (!restrictedTypes.includes(applyType)) {
              return true;
          }

          try {
              // 서버의 WorkHoursCalculator와 동일한 로직으로 휴게시간 차감 후 검증
              const startTimeInt = parseInt(startTime.replace(':', ''));
              const endTimeInt = parseInt(endTime.replace(':', ''));

              const startMinutes = Math.floor(startTimeInt / 100) * 60 + (startTimeInt % 100);
              const endMinutes = Math.floor(endTimeInt / 100) * 60 + (endTimeInt % 100);

              let totalMinutes = endMinutes - startMinutes;

              // 자정 넘어가는 경우 처리
              if (totalMinutes <= 0) {
                  totalMinutes += 24 * 60;
              }

              // 휴게시간 차감 (서버와 동일한 로직)
              let netWorkMinutes = totalMinutes;

              // 휴일근무(14-1)와 주간(05) 시프트의 휴게시간 적용
              if (applyType === '휴일근무') {
                  // 14-1 시프트: 11:30~12:20 (50분), 16:20~16:50 (30분)
                  if (totalMinutes > 8 * 60) { // 8시간 초과 시 휴게시간 차감
                      netWorkMinutes = totalMinutes - 80; // 80분 휴게시간 차감
                  }
              } else {
                  // 주간(05) 시프트: 11:30~12:20 (50분), 16:20~16:50 (30분)
                  if (totalMinutes > 8 * 60) { // 8시간 초과 시 휴게시간 차감
                      netWorkMinutes = totalMinutes - 80; // 80분 휴게시간 차감
                  }
              }

              // 휴게시간 차감 후 30분 단위 확인
              const is30MinuteInterval = netWorkMinutes % 30 === 0 && netWorkMinutes > 0;

              if (!is30MinuteInterval) {
                  console.log('30분 단위 검증 실패 (휴게시간 차감 후):', applyType, '총시간=' + totalMinutes + '분', '순수시간=' + netWorkMinutes + '분');
                  return false;
              }

              console.log('30분 단위 검증 통과 (휴게시간 차감 후):', applyType, '총시간=' + totalMinutes + '분', '순수시간=' + netWorkMinutes + '분');
              return true;
          } catch (e) {
              console.error('30분 단위 검증 오류:', e);
              return false;
          }
      }

      function validateWorkTimeRestrictionsUltimate(row) {
          const workType = row.find('.work-select').val() || row.find('.work-type-display').text();
          const startTimeInput = row.find('.start-time');
          const endTimeInput = row.find('.end-time');

          if (workType === '전반차' || workType === '후반차') {
              startTimeInput.prop('disabled', true).val('').prop('readonly', true);
              endTimeInput.prop('disabled', true).val('').prop('readonly', true);
              startTimeInput.attr('placeholder', '반차는 시간 입력 불가');
              endTimeInput.attr('placeholder', '반차는 시간 입력 불가');

              startTimeInput.css({'background-color': '#f3f4f6', 'cursor': 'not-allowed'});
              endTimeInput.css({'background-color': '#f3f4f6', 'cursor': 'not-allowed'});
              startTimeInput.off('click change input keydown keyup');
              endTimeInput.off('click change input keydown keyup');

              // 서버에서 검증
              $.get(`/user/apply/validateHalfDayTimeInput/${workType}`)
                  .done(function(response) {
                      if (response.timeInputDisabled) {
                          startTimeInput.prop('disabled', true).prop('readonly', true);
                          endTimeInput.prop('disabled', true).prop('readonly', true);
                      }
                  });
          }
          else if (workType === '조퇴') {
              startTimeInput.prop('disabled', false).prop('readonly', false);
              endTimeInput.prop('disabled', true).val('').prop('readonly', true);
              startTimeInput.attr('placeholder', '조퇴 시작시간');
              endTimeInput.attr('placeholder', '자동 계산됨');

              startTimeInput.css({'background-color': '', 'cursor': ''});
              endTimeInput.css({'background-color': '#f3f4f6', 'cursor': 'not-allowed'});
              endTimeInput.off('click change input keydown keyup');

              // 서버에서 검증
              $.get(`/user/apply/validateEarlyLeaveTimeInput/${workType}`)
                  .done(function(response) {
                      if (response.endTimeDisabled) {
                          endTimeInput.prop('disabled', true).prop('readonly', true);
                      }
                  });
          }
          else if (workType === '조출연장') {
              startTimeInput.prop('disabled', false).prop('readonly', false);
              endTimeInput.prop('disabled', false).prop('readonly', false);
              startTimeInput.attr('max', '07:30');
              endTimeInput.attr('max', '07:30');
              startTimeInput.attr('placeholder', '07:30까지만');
              endTimeInput.attr('placeholder', '07:30까지만');

              startTimeInput.css({'background-color': '', 'cursor': ''});
              endTimeInput.css({'background-color': '', 'cursor': ''});

              startTimeInput.off('input.earlyOvertime').on('input.earlyOvertime', function() {
                  validateEarlyOvertimeTimeUltimate($(this).val(), row);
              });
              endTimeInput.off('input.earlyOvertime').on('input.earlyOvertime', function() {
                  validateEarlyOvertimeTimeUltimate($(this).val(), row);
              });
          }
          else if (workType === '연장') {
              startTimeInput.prop('disabled', false).prop('readonly', false);
              endTimeInput.prop('disabled', false).prop('readonly', false);
              startTimeInput.attr('min', '16:20');
              startTimeInput.attr('placeholder', '16:20 이후만');
              endTimeInput.attr('placeholder', '종료시간');

              startTimeInput.css({'background-color': '', 'cursor': ''});
              endTimeInput.css({'background-color': '', 'cursor': ''});

              const empCode = row.data('emp-code');
              const workDate = $('#generalWorkDate').val().replace(/-/g, '');
              validateHolidayWork8HoursForOvertime(empCode, workDate, row);

              startTimeInput.off('input.regularOvertime').on('input.regularOvertime', function() {
                  validateRegularOvertimeTimeUltimate($(this).val(), row);
              });
          }
          else {
              // 기타 근무의 경우 모든 제한 해제
              startTimeInput.prop('disabled', false).prop('readonly', false);
              endTimeInput.prop('disabled', false).prop('readonly', false);
              startTimeInput.removeAttr('min max placeholder');
              endTimeInput.removeAttr('min max placeholder');

              startTimeInput.css({'background-color': '', 'cursor': ''});
              endTimeInput.css({'background-color': '', 'cursor': ''});
              startTimeInput.off('click change input keydown keyup');
              endTimeInput.off('click change input keydown keyup');
          }

          // 30분 단위 검증
          startTimeInput.off('change.validate30min').on('change.validate30min', function() {
              const startTime = $(this).val();
              const endTime = endTimeInput.val();

              if (startTime && endTime) {
                  if (!validate30MinuteInterval(startTime, endTime, workType)) {
                      alert('연장, 휴일근무, 조퇴, 외출, 외근은 휴게시간을 제외하고 30분 단위로만 신청할 수 있습니다.');
                      $(this).val('');
                      endTimeInput.val('');
                      return;
                  }
              }
          });

          endTimeInput.off('change.validate30min').on('change.validate30min', function() {
              const startTime = startTimeInput.val();
              const endTime = $(this).val();

              if (startTime && endTime) {
                  if (!validate30MinuteInterval(startTime, endTime, workType)) {
                      alert('연장, 휴일근무, 조퇴, 외출, 외근은 휴게시간을 제외하고 30분 단위로만 신청할 수 있습니다.');
                      startTimeInput.val('');
                      $(this).val('');
                      return;
                  }
              }
          });
      }

      // 조출연장 시간 검증 강화
      function validateEarlyOvertimeTimeUltimate(time, row) {
          if (!time) return;

          try {
        const timeInt = parseInt(time.replace(':', ''));

              if (timeInt > 730) {
                  alert('조출연장은 07:30까지만 신청할 수 있습니다.');
                  row.find('.start-time, .end-time').val('');
                  return;
              }
          } catch (e) {
              console.error('조출연장 시간 파싱 오류:', e);
          }

          // 서버 검증도 병행
          $.post('/user/apply/validateEarlyOvertimeTime', { startTime: time })
              .done(function(response) {
                  if (!response.isValid) {
                      alert(response.message);
                      row.find('.start-time, .end-time').val('');
                  }
              })
              .fail(function() {
                  console.error('조출연장 시간 서버 검증 실패');
              });
      }

      function validateRegularOvertimeTimeUltimate(time, row) {
          if (!time) return;

          $.post('/user/apply/validateRegularOvertimeTime', { startTime: time })
              .done(function(response) {
                  if (!response.isValid) {
                      alert(response.message);
                      row.find('.start-time').val('');
                      console.log('일반연장 시간 제한 위반:', response.message);
                  }
              })
              .fail(function() {
                  console.error('일반연장 시간 검증 실패');
              });
      }

      function validateHolidayWork8HoursForOvertime(empCode, workDate, row) {
          // 동일 날짜에 휴일근무 신청이 있는지 확인
          let holidayWorkRow = null;
          $('#generalEmployeeTable tbody tr').each(function() {
              const rowEmpCode = $(this).data('emp-code');
              const workType = $(this).find('.work-type-display').text() || $(this).find('.work-select').val();

              if (rowEmpCode === empCode && workType === '휴일근무') {
                  holidayWorkRow = $(this);
                  return false; // break
              }
          });

          if (holidayWorkRow) {
              const startTime = holidayWorkRow.find('.start-time').val();
              const endTime = holidayWorkRow.find('.end-time').val();

              if (startTime && endTime) {
                  // 8시간 이상 검증
                  const startHour = parseInt(startTime.split(':')[0]);
                  const startMin = parseInt(startTime.split(':')[1]);
                  const endHour = parseInt(endTime.split(':')[0]);
                  const endMin = parseInt(endTime.split(':')[1]);

                  let totalMinutes = (endHour * 60 + endMin) - (startHour * 60 + startMin);

                  // 자정 넘어가는 경우 처리
                  if (totalMinutes <= 0) {
                      totalMinutes += 24 * 60;
                  }

                  // 정확한 휴게시간 차감
                  let netWorkMinutes = totalMinutes;

                  // 8시간 이상 근무 시 휴게시간 차감
                  if (totalMinutes >= 8 * 60) {
                      // 오전 휴게시간 (11:30~12:20 = 50분) 겹침 확인
                      const morningBreakOverlap = calculateBreakOverlap(startHour * 60 + startMin, endHour * 60 + endMin, 11 * 60 + 30, 12 * 60 + 20);

                      // 오후 휴게시간 (16:20~16:50 = 30분) 겹침 확인
                      const afternoonBreakOverlap = calculateBreakOverlap(startHour * 60 + startMin, endHour * 60 + endMin, 16 * 60 + 20, 16 * 60 + 50);

                      netWorkMinutes = totalMinutes - morningBreakOverlap - afternoonBreakOverlap;
                  }

                  if (netWorkMinutes < 480) { // 순수 8시간 = 480분
                      row.find('.start-time, .end-time').prop('disabled', true);
                      row.find('.start-time').attr('placeholder', '휴일근무 순수 8시간 이상 필요');
                      row.find('.end-time').attr('placeholder', '휴일근무 순수 8시간 이상 필요');
                      console.log('휴일근무 순수 8시간 미만으로 연장근로 차단 (정확한 휴게시간 차감):', netWorkMinutes);
                  } else {
                      row.find('.start-time, .end-time').prop('disabled', false);
                      row.find('.start-time').attr('placeholder', '16:20 이후만');
                      row.find('.end-time').attr('placeholder', '종료시간');
                      console.log('휴일근무 순수 8시간 이상으로 연장근로 허용 (정확한 휴게시간 차감):', netWorkMinutes);
                  }
              }
          }
      }

      // 휴게시간 겹침 계산 함수
      function calculateBreakOverlap(workStart, workEnd, breakStart, breakEnd) {
          const overlapStart = Math.max(workStart, breakStart);
          const overlapEnd = Math.min(workEnd, breakEnd);
          return Math.max(0, overlapEnd - overlapStart);
      }

      function searchGeneralEmployees() {
          if (isGeneralSearching) {
              console.log('이미 조회 중입니다.');
              return;
          }

          isGeneralSearching = true;
          expectedHoursCache.clear();
          workTypeSpecificCache.clear();
          holidayWorkStatusCache.clear();

          const deptCode = $('#generalDeptSelect').val();
          const workDate = $('#generalWorkDate').val();
          const applyTypeCategory = $('#generalApplyType').val();

          if (!deptCode) {
              console.error('부서코드가 선택되지 않았습니다.');
              alert('부서를 선택해주세요.');
              isGeneralSearching = false;
              return;
          }

          if (!workDate) {
              console.error('근무일이 설정되지 않았습니다.');
              alert('근무일을 선택해주세요.');
              isGeneralSearching = false;
              return;
          }

          const formattedWorkDate = workDate.replace(/-/g, '');

          console.log('사원 조회 요청:', { deptCode, workDate: formattedWorkDate, applyTypeCategory });

          $.get('/user/apply/employees', {
              deptCode: deptCode,
              workDate: formattedWorkDate,
              sortBy: 'gradeOrder,empCode',
              applyTypeCategory: applyTypeCategory
          })
          .done(function(employees) {
              console.log('사원 조회 성공:', employees);
              displayGeneralEmployees(employees);
          })
          .fail(function(xhr, status, error) {
              console.error('사원 조회 실패:', { xhr, status, error });
              console.error('응답 내용:', xhr.responseText);
              alert('사원 조회에 실패했습니다: ' + (xhr.responseText || error));
          })
          .always(function() {
              isGeneralSearching = false;
          });
      }

      // 기타근태 사원 조회
      function searchEtcEmployees() {
          if (isEtcSearching) {
              console.log('이미 조회 중입니다.');
              return;
          }

          isEtcSearching = true;

          const deptCode = $('#etcDeptSelect').val();
          const workDate = $('#etcWorkDate').val();
          const workPlan = $('#etcWorkPlan').val();

          if (!deptCode) {
              alert('부서를 선택해주세요.');
              isEtcSearching = false;
              return;
          }

          if (!workDate) {
              alert('근무일을 선택해주세요.');
              isEtcSearching = false;
              return;
          }

          const formattedWorkDate = workDate.replace(/-/g, '');

          $.get('/user/apply/employees', {
              deptCode: deptCode,
              workDate: formattedWorkDate,
              workPlan: workPlan,
              sortBy: 'gradeOrder,empCode'
          })
          .done(function(employees) {
              displayEtcEmployees(employees);
          })
          .fail(function(xhr, status, error) {
              console.error('사원 조회 실패:', { xhr, status, error });
              alert('사원 조회에 실패했습니다: ' + (xhr.responseText || error));
          })
          .always(function() {
              isEtcSearching = false;
          });
      }

      function forceSortTableByGrade(tbody) {
          const rows = Array.from(tbody.find('tr'));

          console.log('정렬 전 행 수:', rows.length);

          rows.sort(function(a, b) {
              const aEmpCode = $(a).find('td:eq(1)').text().trim();
              const aPositionName = $(a).find('td:eq(3)').text().trim();
              const bEmpCode = $(b).find('td:eq(1)').text().trim();
              const bPositionName = $(b).find('td:eq(3)').text().trim();

              console.log('비교:', aEmpCode, aPositionName, 'vs', bEmpCode, bPositionName);

              const gradeOrder = {
                  '사장': 1,
                  '부사장': 2,
                  '전무': 3,
                  '전무보': 4,
                  '상무': 5,
                  '상무보': 6,
                  '이사': 7,
                  '부장': 8,
                  '차장': 9,
                  '과장': 10,
                  '대리': 11,
                  '사원': 12
              };

              const aGrade = gradeOrder[aPositionName] || 999;
              const bGrade = gradeOrder[bPositionName] || 999;

              if (aGrade !== bGrade) {
                  return aGrade - bGrade;
              }

              const aEmpNum = parseInt(aEmpCode.replace(/\D/g, '')) || 0;
              const bEmpNum = parseInt(bEmpCode.replace(/\D/g, '')) || 0;

              console.log('사번 비교:', aEmpNum, 'vs', bEmpNum);

              return aEmpNum - bEmpNum;
          });

          tbody.empty();

          rows.forEach(function(row) {
              tbody.append(row);
          });

          console.log('정렬 완료 - 최종 순서:');
          tbody.find('tr').each(function(index) {
              const empCode = $(this).find('td:eq(1)').text().trim();
              const positionName = $(this).find('td:eq(3)').text().trim();
              console.log(`${index + 1}. ${empCode} ${positionName}`);
          });
      }

      function displayGeneralEmployees(employees) {
          const tbody = $('#generalEmployeeBody');
          tbody.empty();

          const selectedWorkType = $('#generalWorkTypeFilter').val();

          let processedCount = 0;
          const totalCount = employees.length;

          employees.forEach(function(emp) {
              // 근무정보 조회
              loadWorkInfo(emp.empCode, $('#generalWorkDate').val().replace(/-/g, ''), function(workInfo) {
                  const applyType = $('#generalApplyType').val();
                  const isLeaveType = applyType === '조퇴외출반차';

                  const workOptions = workTypeOptions[applyType] || [];
                  let workSelectHtml = '';
                  workOptions.forEach(function(option) {
                      const selected = (selectedWorkType && option.value === selectedWorkType) ? 'selected' : '';
                      workSelectHtml += `<option value="${option.value}" ${selected}>${option.text}</option>`;
                  });

                  const applyNo = emp.applyGeneralNo || '';
                  const status = emp.generalApplyStatus || '대기';

                  let recordDisplay = workInfo.record.shiftName || '-';
                  if (workInfo.appliedRecord && workInfo.appliedRecord.shiftName) {
                      recordDisplay = workInfo.appliedRecord.shiftName;
                  }

                  const workDate = $('#generalWorkDate').val().replace(/-/g, '');
                  const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                  const isFutureDate = workDate > today;

                  // 미래 날짜는 결근 체크하지 않음
                  let isAbsent = false;
                  if (!isFutureDate) {
                      // 과거/현재 날짜만 결근 체크
                      isAbsent = workInfo.record.shiftCode === '00' || workInfo.record.shiftName === '결근';
                  }

                  const recordColor = isAbsent ? 'text-gray-700' : '';

                  const baseCacheKey = `${emp.empCode}_${workDate}`;
                  const workTypeCacheKey = `${emp.empCode}_${workDate}_${selectedWorkType}`;
                  if (workInfo.expectedHours) {
                      expectedHoursCache.set(baseCacheKey, workInfo.expectedHours);
                      workTypeSpecificCache.set(workTypeCacheKey, workInfo.expectedHours);

                      // 휴일근무인 경우 상태 캐시에도 저장
                      if (selectedWorkType === '휴일근무') {
                          const holidayCacheKey = `${emp.empCode}_${workDate}_휴일근무`;
                          holidayWorkStatusCache.set(holidayCacheKey, workInfo.expectedHours);
                      }
                  }

                  const row = `
                      <tr data-emp-code="${emp.empCode}" data-apply-no="${applyNo}" data-is-absent="${isAbsent}" data-plan="${workInfo.empCalendarPlan || workInfo.plan || ''}" data-record="${recordDisplay}">
                          <td class="border border-gray-300 px-4 py-2">
                              <input type="checkbox" class="emp-checkbox">
                          </td>
                          <td class="border border-gray-300 px-4 py-2">${emp.empCode}</td>
                          <td class="border border-gray-300 px-4 py-2">${emp.empName}</td>
                          <td class="border border-gray-300 px-4 py-2">${emp.positionName || ''}</td>
                          <td class="border border-gray-300 px-4 py-2">${emp.deptName || ''}</td>
                          <td class="border border-gray-300 px-4 py-2">${workInfo.empCalendarPlan || workInfo.plan || ''}</td>
                          <td class="border border-gray-300 px-4 py-2 ${recordColor}">${recordDisplay}</td>
                          <td class="border border-gray-300 px-4 py-2">
                              <span class="work-type-display">${selectedWorkType || (workOptions[0] ? workOptions[0].text : '')}</span>
                              <select class="work-select hidden w-full border rounded px-2 py-1" ${isAbsent ? 'disabled' : ''}>
                                  ${workSelectHtml}
                              </select>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <input type="time" class="start-time w-full border rounded px-2 py-1" ${isAbsent ? 'disabled' : ''}>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <input type="time" class="end-time w-full border rounded px-2 py-1" ${isAbsent ? 'disabled' : ''}>
                          </td>
                          <td class="border border-gray-300 px-4 py-2 ${isLeaveType ? 'hidden' : ''}">
                              <span class="expected-hours">${workInfo.expectedHours || '40.00'}</span>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <input type="text" class="reason-field w-full border rounded px-2 py-1" placeholder="사유 입력" ${isAbsent ? 'disabled' : ''}>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <span class="status-field">${status}</span>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <span class="applicant-field">${currentUser.empName}</span>
                          </td>
                      </tr>
                  `;
                  tbody.append(row);

                  processedCount++;

                  if (processedCount === totalCount) {
                      setTimeout(function() {
                          console.log('모든 사원 처리 완료 - 강제 정렬 시작');
                          forceSortTableByGrade(tbody);
                      }, 100);
                  }

                  if (applyNo) {
                      loadSavedGeneralData(applyNo, tbody.find('tr:last'), applyType);
                  }

                  // 시간 변경 시 실시간 주 52시간 검증
                  const currentRow = tbody.find('tr:last');
                  currentRow.find('.start-time, .end-time').on('change', function() {
                      calculateRealTimeWeeklyHoursUltimate(currentRow, emp.empCode);
                  });

                  currentRow.find('.work-select').on('change', function() {
                      validateWorkTimeRestrictionsUltimate(currentRow);
                  });

                  validateWorkTimeRestrictionsUltimate(currentRow);

                  calculateRealTimeWeeklyHoursUltimate(currentRow, emp.empCode);

                  // 상태별 버튼 활성화/비활성화
                  updateButtonStates();
              });
          });
      }

      function displayEtcEmployees(employees) {
          const tbody = $('#etcEmployeeBody');
          tbody.empty();

          let processedCount = 0;
          const totalCount = employees.length;

          employees.forEach(function(emp) {
              // 근무정보 조회
              loadWorkInfo(emp.empCode, $('#etcWorkDate').val().replace(/-/g, ''), function(workInfo) {
                  const applyNo = emp.applyEtcNo || '';
                  const status = emp.etcApplyStatus || '대기';

                  let recordDisplay = workInfo.record.shiftName || '-';
                  if (workInfo.appliedRecord && workInfo.appliedRecord.shiftName) {
                      recordDisplay = workInfo.appliedRecord.shiftName;
                  }

                  const workDate = $('#etcWorkDate').val().replace(/-/g, '');
                  const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                  const isFutureDate = workDate > today;

                  // 미래 날짜는 결근 체크하지 않음
                  let isAbsent = false;
                  if (!isFutureDate) {
                      // 과거/현재 날짜만 결근 체크
                      isAbsent = workInfo.record.shiftCode === '00' || workInfo.record.shiftName === '결근';
                  }

                  const recordColor = isAbsent ? 'text-gray-700' : '';

                  const row = `
                      <tr data-emp-code="${emp.empCode}" data-apply-no="${applyNo}" data-is-absent="${isAbsent}" data-plan="${workInfo.empCalendarPlan || workInfo.plan || ''}" data-record="${recordDisplay}">
                          <td class="border border-gray-300 px-4 py-2">
                              <input type="checkbox" class="emp-checkbox">
                          </td>
                          <td class="border border-gray-300 px-4 py-2">${emp.empCode}</td>
                          <td class="border border-gray-300 px-4 py-2">${emp.empName}</td>
                          <td class="border border-gray-300 px-4 py-2">${emp.positionName || ''}</td>
                          <td class="border border-gray-300 px-4 py-2">${emp.deptName || ''}</td>
                          <td class="border border-gray-300 px-4 py-2">${workInfo.empCalendarPlan || workInfo.plan || ''}</td>
                          <td class="border border-gray-300 px-4 py-2 ${recordColor}">${recordDisplay}</td>
                          <td class="border border-gray-300 px-4 py-2">
                              <select class="shift-select w-full border rounded px-2 py-1" ${isAbsent ? 'disabled' : ''}>
                                  <option value="">선택</option>
                              </select>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <input type="date" class="start-date w-full border rounded px-2 py-1" ${isAbsent ? 'disabled' : ''}>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <input type="date" class="end-date w-full border rounded px-2 py-1" ${isAbsent ? 'disabled' : ''}>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <span class="annual-balance">0.00</span>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <select class="apply-time w-full border rounded px-2 py-1" ${isAbsent ? 'disabled' : ''}>
                                  <option value="1일이전신청">1일이전신청</option>
                                  <option value="당일신청">당일신청</option>
                              </select>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <input type="text" class="reason-field w-full border rounded px-2 py-1" placeholder="사유 입력" ${isAbsent ? 'disabled' : ''}>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <span class="status-field">${status}</span>
                          </td>
                          <td class="border border-gray-300 px-4 py-2">
                              <span class="applicant-field">${currentUser.empName}</span>
                          </td>
                      </tr>
                  `;
                  tbody.append(row);

                  processedCount++;

                  if (processedCount === totalCount) {
                      setTimeout(function() {
                          console.log('모든 사원 처리 완료 - 강제 정렬 시작 (기타근태)');
                          forceSortTableByGrade(tbody);
                      }, 100);
                  }

                  const shiftSelect = tbody.find('tr:last .shift-select');
                  shiftMasters.forEach(function(shift) {
                      // 휴일, 휴무일 제외
                      if (shift.shiftCode !== '12' && shift.shiftCode !== '13') {
                          shiftSelect.append(`<option value="${shift.shiftCode}">${shift.shiftName}</option>`);
                      }
                  });

                  const currentRow = tbody.find('tr:last');
                  currentRow.find('.start-date, .end-date').on('change', function() {
                      validateEtcDateRange(currentRow);
                  });

                  loadAnnualBalanceUltraStable(emp.empCode, currentRow);

                  // 기존 신청 데이터가 있으면 복원
                  if (applyNo) {
                      loadSavedEtcData(applyNo, tbody.find('tr:last'));
                  }

                  // 상태별 버튼 활성화/비활성화
                  updateButtonStates();
              });
          });
      }

      function validateEtcDateRange(row) {
          const startDate = row.find('.start-date').val();
          const endDate = row.find('.end-date').val();

          if (!startDate || !endDate) return;

          // 휴일/휴무일 체크를 위한 API 호출
          $.get('/user/apply/validateDateRange', {
              startDate: startDate.replace(/-/g, ''),
              endDate: endDate.replace(/-/g, '')
          })
          .done(function(result) {
              if (!result.valid) {
                  alert('신청 기간에 휴일/휴무일이 포함되어 있습니다. 날짜를 다시 선택해주세요.');
                  row.find('.start-date, .end-date').val('');
              }
          })
          .fail(function() {
              console.warn('날짜 범위 검증 API 호출 실패');
          });
      }

      function calculateRealTimeWeeklyHoursUltimate(row, empCode) {
          const applyType = $('#generalApplyType').val();
          const workType = row.find('.work-select').val() || row.find('.work-type-display').text();
          const startTime = row.find('.start-time').val();
          const endTime = row.find('.end-time').val();
          const workDate = $('#generalWorkDate').val()?.replace(/-/g, '') || '';

          if (!empCode || !workDate) {
              console.warn('empCode 또는 workDate 누락:', { empCode, workDate });
              row.find('.expected-hours').text('40.00');
              return;
          }

          if (workType === '휴일근무') {
              // 휴일근무는 실시간 계산하지 않고 기존 값 유지
              const baseCacheKey = `${empCode}_${workDate}`;
              const cachedHours = expectedHoursCache.get(baseCacheKey) || '40.00';
              row.find('.expected-hours').text(cachedHours);

              console.log('휴일근무 중복 방지: 기존 값 유지 =', cachedHours);
              return;
          }

          // 조퇴외출반차의 경우 별도 처리
          if (applyType === '조퇴외출반차') {
              if (workType === '전반차' || workType === '후반차') {
                  row.find('.expected-hours').text('-4.00');
              } else if (workType === '조퇴') {
                  // 조퇴 시간 계산
                  if (startTime) {
                      calculateEarlyLeaveHours(empCode, workDate, startTime, function(deductHours) {
                          row.find('.expected-hours').text(`-${deductHours.toFixed(2)}`);
                      });
                  } else {
                      row.find('.expected-hours').text('0.00');
                  }
              } else {
                  row.find('.expected-hours').text('0.00');
              }
              return;
          }

          const isAbsent = row.data('is-absent') === true;
          if (isAbsent) {
              const workTypeCacheKey = `${empCode}_${workDate}_${workType}`;
              const baseCacheKey = `${empCode}_${workDate}`;
              const cachedHours = workTypeSpecificCache.get(workTypeCacheKey) || expectedHoursCache.get(baseCacheKey) || '40.00';
              row.find('.expected-hours').text(cachedHours);
              return;
          }

          if (!startTime || !endTime) {
              const hasHolidayWork = checkHolidayWorkStatus(empCode, workDate);
              if (hasHolidayWork && workType === '연장') {
                  const holidayCacheKey = `${empCode}_${workDate}_휴일근무`;
                  const holidayHours = holidayWorkStatusCache.get(holidayCacheKey) || '48.00';
                  row.find('.expected-hours').text(holidayHours);
                  return;
              }

              const workTypeCacheKey = `${empCode}_${workDate}_${workType}`;
              const baseCacheKey = `${empCode}_${workDate}`;
              const cachedHours = workTypeSpecificCache.get(workTypeCacheKey) || expectedHoursCache.get(baseCacheKey);

              if (cachedHours) {
                  row.find('.expected-hours').text(cachedHours);
                  row.find('.expected-hours').removeClass('text-red-500 font-bold');
                  row.find('.expected-hours').removeAttr('title');
              } else {
                  updateExpectedHoursUltraStable(row, empCode, workDate, workType);
              }
              return;
          }

          // 30분 단위 검증
          if (!validate30MinuteInterval(startTime, endTime, workType)) {
              alert('연장, 휴일근무, 조퇴, 외출, 외근은 휴게시간을 제외하고 30분 단위로만 신청할 수 있습니다.');
              row.find('.start-time, .end-time').val('');
              return;
          }

          // 실시간 주 52시간 검증 API 호출
          $.post('/user/apply/calculateWorkHours', {
              empCode: empCode,
              workDate: workDate,
              startTime: startTime,
              endTime: endTime,
              applyType: workType
          })
          .done(function(response) {
              const expectedHoursSpan = row.find('.expected-hours');
              const totalHours = response.totalWeeklyHours.toFixed(2);
              expectedHoursSpan.text(totalHours);

              const workTypeCacheKey = `${empCode}_${workDate}_${workType}`;
              const baseCacheKey = `${empCode}_${workDate}`;
              workTypeSpecificCache.set(workTypeCacheKey, totalHours);
              expectedHoursCache.set(baseCacheKey, totalHours);

              // 휴일근무인 경우 상태 캐시에도 저장
              if (workType === '휴일근무') {
                  const holidayCacheKey = `${empCode}_${workDate}_휴일근무`;
                  holidayWorkStatusCache.set(holidayCacheKey, totalHours);
              }

              if (!response.isValid) {
                  expectedHoursSpan.addClass('text-red-500 font-bold');
                  expectedHoursSpan.attr('title', response.message);
              } else {
                  expectedHoursSpan.removeClass('text-red-500 font-bold');
                  expectedHoursSpan.removeAttr('title');
              }

              console.log('실시간 주 52시간 계산 완료 (휴게시간 차감 포함):', totalHours);
          })
          .fail(function() {
              console.error('실시간 주 52시간 계산 실패');
              const workTypeCacheKey = `${empCode}_${workDate}_${workType}`;
              const baseCacheKey = `${empCode}_${workDate}`;
              const cachedHours = workTypeSpecificCache.get(workTypeCacheKey) || expectedHoursCache.get(baseCacheKey) || '40.00';
              row.find('.expected-hours').text(cachedHours);
          });
      }

      // 조퇴 시간 계산
      function calculateEarlyLeaveHours(empCode, workDate, startTime, callback) {
          // 서버에서 조퇴 시간 계산
          // 임시로 클라이언트에서 계산 (16:20 - 시작시간)
          try {
              const startHour = parseInt(startTime.split(':')[0]);
              const startMin = parseInt(startTime.split(':')[1]);
              const startTotalMin = startHour * 60 + startMin;

              const endTotalMin = 16 * 60 + 20; // 16:20

              if (endTotalMin > startTotalMin) {
                  const diffMin = endTotalMin - startTotalMin;
                  const diffHours = diffMin / 60.0;
                  callback(diffHours);
              } else {
                  callback(0);
              }
          } catch (e) {
              callback(2.0); // 기본 2시간
          }
      }

      // 예상근로시간 실시간 업데이트 API 호출
      function updateExpectedHours(empCode, workDate, callback) {
          const baseCacheKey = `${empCode}_${workDate}`;

          // 캐시에서 먼저 확인
          if (expectedHoursCache.has(baseCacheKey)) {
              callback(expectedHoursCache.get(baseCacheKey));
              return;
          }

          $.get(`/user/apply/updateExpectedHours/${empCode}/${workDate}`)
              .done(function(response) {
                  if (response.success) {
                      const expectedHours = response.expectedHours;
                      expectedHoursCache.set(baseCacheKey, expectedHours);
                      callback(expectedHours);
                  } else {
                      const defaultHours = '40.00';
                      expectedHoursCache.set(baseCacheKey, defaultHours);
                      callback(defaultHours);
                  }
              })
              .fail(function() {
                  const defaultHours = '40.00';
                  expectedHoursCache.set(baseCacheKey, defaultHours);
                  callback(defaultHours);
              });
      }

      function loadSavedGeneralData(applyNo, row, currentApplyType) {
          $.get(`/user/apply/general/${applyNo}`)
              .done(function(data) {
                  if (data) {
                      const savedApplyType = data.applyType;
                      const savedApplyCategory = getApplyCategoryFromType(savedApplyType);

                      if (savedApplyCategory === currentApplyType) {
                          // 저장된 데이터로 폼 필드 복원
                          row.find('.work-select').val(data.applyType || '');
                          row.find('.work-type-display').text(data.applyType || '');
                          if (data.startTime) {
                              row.find('.start-time').val(formatTimeDisplay(data.startTime));
                          }
                          if (data.endTime) {
                              row.find('.end-time').val(formatTimeDisplay(data.endTime));
                          }
                          row.find('.reason-field').val(data.reason || '');
                          row.find('.status-field').text(data.status || '대기');

                          // 복원 후 실시간 검증
                          if (data.startTime && data.endTime) {
                              calculateRealTimeWeeklyHoursUltimate(row, row.data('emp-code'));
                          }
                      } else {
                          row.find('.status-field').text('대기');
                      }
                  }
              })
              .fail(function() {
                  console.log('저장된 일반근태 데이터 없음: ' + applyNo);
              });
      }

      function getApplyCategoryFromType(applyType) {
          if (['조출연장', '연장'].includes(applyType)) {
              return '연장근로';
          } else if (['휴일근무'].includes(applyType)) {
              return '휴일근로';
          } else if (['조퇴', '외근', '외출', '전반차', '후반차'].includes(applyType)) {
              return '조퇴외출반차';
          }
          return '';
      }

      // 저장된 기타근태 데이터 복원 함수
      function loadSavedEtcData(applyNo, row) {
          $.get(`/user/apply/etc/${applyNo}`)
              .done(function(data) {
                  if (data) {
                      // 저장된 데이터로 폼 필드 복원
                      row.find('.shift-select').val(data.shiftCode || '');
                      if (data.targetStartDate) {
                          row.find('.start-date').val(formatDateDisplay(data.targetStartDate));
                      }
                      if (data.targetEndDate) {
                          row.find('.end-date').val(formatDateDisplay(data.targetEndDate));
                      }
                      row.find('.apply-time').val(data.applyDateTime || '1일이전신청');
                      row.find('.reason-field').val(data.reason || '');
                      row.find('.status-field').text(data.status || '대기');
                  }
              })
              .fail(function() {
                  console.log('저장된 기타근태 데이터 없음: ' + applyNo);
              });
      }

      // 시간 포맷 변환 함수 (HHMM -> HH:MM)
      function formatTimeDisplay(timeStr) {
          if (!timeStr || timeStr.length !== 4) return '';
          return timeStr.substring(0, 2) + ':' + timeStr.substring(2, 4);
      }

      // 날짜 포맷 변환 함수 (YYYYMMDD -> YYYY-MM-DD)
      function formatDateDisplay(dateStr) {
          if (!dateStr || dateStr.length !== 8) return '';
          return dateStr.substring(0, 4) + '-' + dateStr.substring(4, 6) + '-' + dateStr.substring(6, 8);
      }

      // 상태별 버튼 활성화/비활성화 함수
      function updateButtonStates() {
          // 선택된 행들의 상태 확인
          const selectedRows = $('.emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              // 선택된 행이 없으면 조회, 저장만 활성화
              $('#saveGeneralBtn, #saveEtcBtn').prop('disabled', false);
              $('#deleteGeneralBtn, #deleteEtcBtn, #submitGeneralBtn, #submitEtcBtn, #cancelGeneralBtn, #cancelEtcBtn').prop('disabled', true);
              return;
          }

          let hasWaiting = false, hasSaved = false, hasSubmitted = false;
          let hasAbsent = false;

          selectedRows.each(function() {
              const status = $(this).find('.status-field').text();
              const isAbsent = $(this).data('is-absent') === true;

              if (status === '대기') hasWaiting = true;
              else if (status === '저장') hasSaved = true;
              else if (status === '상신') hasSubmitted = true;

              if (isAbsent) hasAbsent = true;
          });

          if (hasAbsent) {
              $('#saveGeneralBtn, #saveEtcBtn, #submitGeneralBtn, #submitEtcBtn').prop('disabled', true);
          } else {
              // 대기 상태: 저장만 가능
              // 저장 상태: 삭제, 상신 가능
              // 상신 상태: 상신취소만 가능
              $('#saveGeneralBtn, #saveEtcBtn').prop('disabled', !hasWaiting);
              $('#submitGeneralBtn, #submitEtcBtn').prop('disabled', !hasSaved);
          }

          $('#deleteGeneralBtn, #deleteEtcBtn').prop('disabled', !hasSaved);
          $('#cancelGeneralBtn, #cancelEtcBtn').prop('disabled', !hasSubmitted);
      }

      // 체크박스 변경 시 버튼 상태 업데이트
      $(document).on('change', '.emp-checkbox', updateButtonStates);

      // 근무정보 조회 함수
      function loadWorkInfo(empCode, workDate, callback) {
          $.get(`/user/apply/workInfo/${empCode}/${workDate}`)
              .done(function(workInfo) {
                  callback(workInfo);
              })
              .fail(function() {
                  callback({
                      plan: '',
                      empCalendarPlan: '',
                      record: {checkInTime: '-', checkOutTime: '-', shiftCode: '', shiftName: '-'},
                      appliedRecord: null,
                      expectedHours: '40.00'  // 주간 예상근로시간 기본값
                  });
              });
      }

      // 연차잔여 조회 개선
      function loadAnnualBalanceUltraStable(empCode, row) {
          $.get(`/user/apply/annual/${empCode}`)
              .done(function(annual) {
                  let balanceDay = parseFloat(annual.balanceDay || '0');

                  if (annual.totDay && annual.useDay) {
                      const totDay = parseFloat(annual.totDay || '0');
                      const useDay = parseFloat(annual.useDay || '0');
                      const calculatedBalance = totDay - useDay;

                      if (Math.abs(balanceDay - calculatedBalance) > 0.001) {
                          console.warn('연차 계산 불일치 감지 - 실시간 계산값 사용:', {
                              서버응답: balanceDay,
                              실시간계산: calculatedBalance,
                              총연차: totDay,
                              사용연차: useDay
                          });
                          balanceDay = calculatedBalance;
                      }
                  }

                  const accurateBalance = Math.round(balanceDay * 10) / 10;
                  row.find('.annual-balance').text(accurateBalance.toFixed(1));
                  console.log('연차잔여 조회 (정확성 개선):', empCode, accurateBalance.toFixed(1));
              })
              .fail(function() {
                  row.find('.annual-balance').text('0.0');
                  console.error('연차잔여 조회 실패:', empCode);
              });
      }

      function loadAnnualBalance(empCode, callback) {
          $.get(`/user/apply/annual/${empCode}`)
              .done(function(annual) {
                  callback(annual);
              })
              .fail(function() {
                  callback({balanceDay: '0'});
              });
      }

      // 일반근태 저장
      function saveGeneralApply() {
          const selectedRows = $('#generalEmployeeTable .emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              alert('저장할 사원을 선택해주세요.');
              return;
          }

          const absentRows = selectedRows.filter(function() {
              return $(this).data('is-absent') === true;
          });

          if (absentRows.length > 0) {
              alert('실적이 결근일 경우 신청할 수 없습니다.');
              return;
          }

          let hasError = false;

          selectedRows.each(function() {
              if (hasError) return false;

              const row = $(this);
              const empCode = row.data('emp-code');
                            const workSelect = row.find('.work-select').val() || row.find('.work-type-display').text();
              const startTime = row.find('.start-time').val().replace(':', '');
              const endTime = row.find('.end-time').val().replace(':', '');
              const reason = row.find('.reason-field').val();
              const planShift = row.data('plan');
              const recordShift = row.data('record');

              const applyType = $('#generalApplyType').val();

              // 30분 단위 검증
              if (startTime && endTime && !validate30MinuteInterval(row.find('.start-time').val(), row.find('.end-time').val(), workSelect)) {
                  alert(`${row.find('td:eq(2)').text()} 사원: 연장, 휴일근무, 조퇴, 외출, 외근은 휴게시간을 제외하고 30분 단위로만 신청할 수 있습니다.`);
                  hasError = true;
                  return false;
              }

              if (workSelect === '연장' || workSelect === '조출연장') {
                  // 실적이 휴일근무인 경우 8시간 이상 신청 여부 확인
                  if (recordShift === '휴일근무') {
                      // 같은 날짜에 휴일근무 신청이 있는지 확인
                      let holidayWorkRow = null;
                      $('#generalEmployeeTable tbody tr').each(function() {
                          const rowEmpCode = $(this).data('emp-code');
                          const workType = $(this).find('.work-type-display').text() || $(this).find('.work-select').val();

                          if (rowEmpCode === empCode && workType === '휴일근무') {
                              holidayWorkRow = $(this);
                              return false; // break
                          }
                      });

                      if (holidayWorkRow) {
                          const holidayStartTime = holidayWorkRow.find('.start-time').val();
                          const holidayEndTime = holidayWorkRow.find('.end-time').val();

                          if (holidayStartTime && holidayEndTime) {
                              // 휴게시간 고려한 8시간 검증
                              const startHour = parseInt(holidayStartTime.split(':')[0]);
                              const startMin = parseInt(holidayStartTime.split(':')[1]);
                              const endHour = parseInt(holidayEndTime.split(':')[0]);
                              const endMin = parseInt(holidayEndTime.split(':')[1]);

                              let totalMinutes = (endHour * 60 + endMin) - (startHour * 60 + startMin);

                              // 자정 넘어가는 경우 처리
                              if (totalMinutes <= 0) {
                                  totalMinutes += 24 * 60;
                              }

                              // 휴게시간 차감 (14-1 시프트 기준: 11:30~12:20=50분, 16:20~16:50=30분)
                              let netWorkMinutes = totalMinutes;
                              if (totalMinutes > 8 * 60) { // 8시간 초과 시 휴게시간 차감
                                  netWorkMinutes = totalMinutes - 80; // 80분 휴게시간 차감
                              }

                              if (netWorkMinutes < 480) { // 순수 8시간 = 480분
                                  alert(`${row.find('td:eq(2)').text()} 사원: 휴일근무 순수 8시간 이상 신청한 경우에만 연장근무를 신청할 수 있습니다. (현재: ${(netWorkMinutes/60).toFixed(1)}시간)`);
                                  hasError = true;
                                  return false;
                              }

                              console.log('휴일근무 순수 8시간 검증 통과 (휴게시간 차감):', netWorkMinutes + '분');
                          } else {
                              alert(`${row.find('td:eq(2)').text()} 사원: 휴일근무 시간 정보가 없습니다.`);
                              hasError = true;
                              return false;
                          }
                      }
                  }
              }

              // 조출연장 시간 제한
              if (workSelect === '조출연장') {
                  if (startTime && endTime) {
                      const startTimeInt = parseInt(startTime);
                      const endTimeInt = parseInt(endTime);

                      if (startTimeInt > 730 || endTimeInt > 730) {
                          alert(`${row.find('td:eq(2)').text()} 사원: 조출연장은 07:30까지만 신청할 수 있습니다.`);
                          hasError = true;
                          return false;
                      }
                  }
              }

              // 연장근로 검증
              if (workSelect === '연장' || workSelect === '조출연장') {
                  // 실적이 결근일 경우 신청 불가
                  if (recordShift === '결근') {
                      alert(`${row.find('td:eq(2)').text()} 사원: 실적이 결근일 경우 연장근무를 신청할 수 없습니다.`);
                      hasError = true;
                      return false;
                  }

                  // 시간 검증
                  if (startTime && endTime) {
                      const startTimeInt = parseInt(startTime);
                      const endTimeInt = parseInt(endTime);

                      if (startTimeInt >= endTimeInt) {
                          alert(`${row.find('td:eq(2)').text()} 사원: 시작시간이 종료시간보다 늦을 수 없습니다.`);
                          hasError = true;
                          return false;
                      }

                      if (workSelect === '연장') {
                          if (startTimeInt < 1620) {
                              alert(`${row.find('td:eq(2)').text()} 사원: 정상근무시간(16:20) 이후에만 연장근무를 신청할 수 있습니다.`);
                              hasError = true;
                              return false;
                          }
                      }
                  }
              }

              // 휴일근로 검증
              if (workSelect === '휴일근무') {
                  // 휴일 또는 휴무일에만 신청 가능
                  if (planShift !== '휴일' && planShift !== '휴무일') {
                      alert(`${row.find('td:eq(2)').text()} 사원: 휴일근로는 휴일 또는 휴무일에만 신청할 수 있습니다.`);
                      hasError = true;
                      return false;
                  }

                  // 연차, 휴가, 결근 등의 날은 신청 불가
                  if (['연차', '휴가', '결근'].includes(recordShift)) {
                      alert(`${row.find('td:eq(2)').text()} 사원: 연차, 휴가, 결근 등의 날에는 휴일근로를 신청할 수 없습니다.`);
                      hasError = true;
                      return false;
                  }
              }

              // 조퇴/외출/반차 검증 (일반근태)
              if (['조퇴', '외근', '외출', '전반차', '후반차'].includes(workSelect)) {
                  // 정상 근무가 아닌 경우 신청 불가
                  if (['결근', '연차', '휴가', '휴일', '휴직'].includes(recordShift)) {
                      alert(`${row.find('td:eq(2)').text()} 사원: 정상 근무가 아닌 경우에는 ${workSelect}을(를) 신청할 수 없습니다.`);
                      hasError = true;
                      return false;
                  }
              }

              // 조퇴/외출/반차가 아닌 경우 주 52시간 검증
              if (applyType !== '조퇴외출반차') {
                  const expectedHoursSpan = row.find('.expected-hours');
                  if (expectedHoursSpan.hasClass('text-red-500')) {
                      alert(`${row.find('td:eq(2)').text()} 사원: 주 52시간을 초과할 수 없습니다.`);
                      hasError = true;
                      return false;
                  }
              }

              if (!hasError) {
                  const data = {
                      empCode: empCode,
                      timeItemCode: 'T001',
                      targetDate: $('#generalWorkDate').val().replace(/-/g, ''),
                      startTime: startTime,
                      endTime: endTime,
                      applyType: workSelect,
                      reason: reason
                  };

                  $.ajax({
                      url: '/user/apply/general',
                      method: 'POST',
                      contentType: 'application/json',
                      data: JSON.stringify(data),
                      success: function(response) {
                          if (response.result === 'success') {
                              row.find('.status-field').text('저장');
                              row.attr('data-apply-no', response.data.applyGeneralNo);
                              alert('저장되었습니다.');
                              updateButtonStates();

                              // 휴일근무 저장 시 캐시 및 실적 즉시 갱신
                              if (workSelect === '휴일근무') {
                                  setTimeout(function() {
                                      const workDate = $('#generalWorkDate').val().replace(/-/g, '');

                                      // 휴일근무 상태 캐시 저장
                                      const holidayCacheKey = `${empCode}_${workDate}_휴일근무`;
                                      holidayWorkStatusCache.set(holidayCacheKey, '48.00');

                                      // 근무정보 다시 조회하여 실적 업데이트
                                      loadWorkInfo(empCode, workDate, function(updatedWorkInfo) {
                                          if (updatedWorkInfo.appliedRecord && updatedWorkInfo.appliedRecord.shiftName) {
                                              row.find('td:eq(6)').text(updatedWorkInfo.appliedRecord.shiftName);
                                              row.attr('data-record', updatedWorkInfo.appliedRecord.shiftName);
                                          }

                                          // 예상근로시간 캐시 갱신
                                          if (updatedWorkInfo.expectedHours) {
                                              const baseCacheKey = `${empCode}_${workDate}`;
                                              const workTypeCacheKey = `${empCode}_${workDate}_휴일근무`;

                                              expectedHoursCache.set(baseCacheKey, updatedWorkInfo.expectedHours);
                                              workTypeSpecificCache.set(workTypeCacheKey, updatedWorkInfo.expectedHours);
                                              holidayWorkStatusCache.set(holidayCacheKey, updatedWorkInfo.expectedHours);

                                              row.find('.expected-hours').text(updatedWorkInfo.expectedHours);
                                              console.log('휴일근무 저장 후 예상근로시간 캐시 갱신:', updatedWorkInfo.expectedHours);
                                          }
                                      });
                                  }, 500);
                              }
                          } else {
                              alert('저장 실패: ' + (response.message || '알 수 없는 오류'));
                          }
                      },
                      error: function(xhr, status, error) {
                          console.error('일반근태 저장 실패:', { xhr, status, error });
                          let errorMessage = '저장에 실패했습니다.';

                          if (xhr.responseJSON && xhr.responseJSON.message) {
                              errorMessage += '\n' + xhr.responseJSON.message;
                          } else if (xhr.responseText) {
                              try {
                                  const errorData = JSON.parse(xhr.responseText);
                                  if (errorData.message) {
                                      errorMessage += '\n' + errorData.message;
                                  }
                              } catch (e) {
                                  // JSON 파싱 실패 시 기본 메시지 사용
                              }
                          }

                          alert(errorMessage);
                      }
                  });
              }
          });

          if (hasError) {
              return;
          }
      }

      // 기타근태 저장
      function saveEtcApply() {
          const selectedRows = $('#etcEmployeeTable .emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              alert('저장할 사원을 선택해주세요.');
              return;
          }

          const absentRows = selectedRows.filter(function() {
              return $(this).data('is-absent') === true;
          });

          if (absentRows.length > 0) {
              alert('실적이 결근일 경우 신청할 수 없습니다.');
              return;
          }

          selectedRows.each(function() {
              const row = $(this);
              const empCode = row.data('emp-code');
              const shiftCode = row.find('.shift-select').val();
              const startDate = row.find('.start-date').val().replace(/-/g, '');
              const endDate = row.find('.end-date').val().replace(/-/g, '');
              const applyDateTime = row.find('.apply-time').val();
              const reason = row.find('.reason-field').val();

              if (!shiftCode || !startDate || !endDate) {
                  alert('필수 항목을 모두 입력해주세요.');
                  return;
              }

              // 연차 사용 시 잔여 연차 확인
              const selectedShift = shiftMasters.find(shift => shift.shiftCode === shiftCode);
              if (selectedShift && (selectedShift.shiftName.includes('연차') || selectedShift.shiftName.includes('휴가'))) {
                  const currentBalance = parseFloat(row.find('.annual-balance').text());
                  const requestDays = calculateRequestDays(startDate, endDate);

                  if (currentBalance < requestDays) {
                      alert(`연차 잔여일수가 부족합니다. (필요: ${requestDays}일, 잔여: ${currentBalance.toFixed(1)}일)`);
                      return;
                  }
              }

              const data = {
                  empCode: empCode,
                  shiftCode: shiftCode,
                  targetStartDate: startDate,
                  targetEndDate: endDate,
                  applyDateTime: applyDateTime,
                  reason: reason
              };

              $.ajax({
                  url: '/user/apply/etc',
                  method: 'POST',
                  contentType: 'application/json',
                  data: JSON.stringify(data),
                  success: function(response) {
                      if (response.result === 'success') {
                          row.find('.status-field').text('저장');
                          row.attr('data-apply-no', response.data.applyEtcNo);
                          alert('저장되었습니다.');
                          updateButtonStates();

                          // 기타근태 저장 후 실적 업데이트
                          setTimeout(function() {
                              loadWorkInfo(empCode, $('#etcWorkDate').val().replace(/-/g, ''), function(updatedWorkInfo) {
                                  if (updatedWorkInfo.appliedRecord && updatedWorkInfo.appliedRecord.shiftName) {
                                      row.find('td:eq(6)').text(updatedWorkInfo.appliedRecord.shiftName);
                                  }
                              });
                          }, 500);
                      } else {
                          alert('저장 실패: ' + (response.message || '알 수 없는 오류'));
                      }
                  },
                  error: function(xhr, status, error) {
                      console.error('기타근태 저장 실패:', { xhr, status, error });
                      alert('저장에 실패했습니다.');
                  }
              });
          });
      }

      // 신청 일수 계산 함수
      function calculateRequestDays(startDate, endDate) {
          const start = new Date(startDate.substring(0,4), startDate.substring(4,6)-1, startDate.substring(6,8));
          const end = new Date(endDate.substring(0,4), endDate.substring(4,6)-1, endDate.substring(6,8));
          const diffTime = Math.abs(end - start);
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
          return diffDays;
      }

      // 일반근태 삭제
      function deleteGeneralApply() {
          const selectedRows = $('#generalEmployeeTable .emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              alert('삭제할 사원을 선택해주세요.');
              return;
          }

          if (!confirm('선택된 신청을 삭제하시겠습니까?')) {
              return;
          }

          selectedRows.each(function() {
              const row = $(this);
              const applyNo = row.data('apply-no');

              if (!applyNo) {
                  alert('삭제할 신청이 없습니다.');
                  return;
              }

              $.ajax({
                  url: '/user/apply/delete/general',
                  method: 'POST',
                  data: { applyGeneralNo: applyNo },
                  success: function(response) {
                      if (response === 'success') {
                          alert('삭제되었습니다.');
                          searchGeneralEmployees();
                      } else {
                          alert('삭제 실패: ' + response);
                      }
                  },
                  error: function() {
                      alert('삭제에 실패했습니다.');
                  }
              });
          });
      }

      // 기타근태 삭제
      function deleteEtcApply() {
          const selectedRows = $('#etcEmployeeTable .emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              alert('삭제할 사원을 선택해주세요.');
              return;
          }

          if (!confirm('선택된 신청을 삭제하시겠습니까?')) {
              return;
          }

          selectedRows.each(function() {
              const row = $(this);
              const applyNo = row.data('apply-no');

              if (!applyNo) {
                  alert('삭제할 신청이 없습니다.');
                  return;
              }

              $.ajax({
                  url: '/user/apply/delete/etc',
                  method: 'POST',
                  data: { applyEtcNo: applyNo },
                  success: function(response) {
                      if (response === 'success') {
                          alert('삭제되었습니다.');
                          searchEtcEmployees();
                      } else {
                          alert('삭제 실패: ' + response);
                      }
                  },
                  error: function() {
                      alert('삭제에 실패했습니다.');
                  }
              });
          });
      }

      // 일반근태 상신
      function submitGeneralApply() {
          const selectedRows = $('#generalEmployeeTable .emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              alert('상신할 사원을 선택해주세요.');
              return;
          }

          const absentRows = selectedRows.filter(function() {
              return $(this).data('is-absent') === true;
          });

          if (absentRows.length > 0) {
              alert('실적이 결근일 경우 신청할 수 없습니다.');
              return;
          }

          const invalidRows = selectedRows.filter(function() {
              const expectedHoursSpan = $(this).find('.expected-hours');
              return expectedHoursSpan.hasClass('text-red-500');
          });

          if (invalidRows.length > 0) {
              alert('주 52시간을 초과하는 사원이 있습니다. 상신할 수 없습니다.');
              return;
          }

          selectedRows.each(function() {
              const row = $(this);
              const applyNo = row.data('apply-no');

              if (!applyNo) {
                  alert('상신할 신청이 없습니다.');
                  return;
              }

              $.ajax({
                  url: '/user/apply/submit/general',
                  method: 'POST',
                  data: {
                      applyGeneralNo: applyNo,
                      isHeader: currentUser.isHeader
                  },
                  success: function(response) {
                      if (response === 'success') {
                          const finalStatus = currentUser.isHeader === 'Y' ? '승인완료' : '상신';
                          row.find('.status-field').text(finalStatus);
                          alert(currentUser.isHeader === 'Y' ? '자동 승인완료되었습니다.' : '상신되었습니다.');
                          updateButtonStates();

                          // 승인완료 시 실적 업데이트
                          if (finalStatus === '승인완료') {
                              const workType = row.find('.work-select').val() || row.find('.work-type-display').text();
                              if (workType === '휴일근무') {
                                  setTimeout(function() {
                                      const empCode = row.data('emp-code');
                                      const workDate = $('#generalWorkDate').val().replace(/-/g, '');

                                      // 휴일근무 승인완료 후에도 실적을 휴일근무로 유지
                                      const holidayCacheKey = `${empCode}_${workDate}_휴일근무`;
                                      holidayWorkStatusCache.set(holidayCacheKey, '48.00');

                                      loadWorkInfo(empCode, workDate, function(updatedWorkInfo) {
                                          if (updatedWorkInfo.appliedRecord && updatedWorkInfo.appliedRecord.shiftName) {
                                              row.find('td:eq(6)').text(updatedWorkInfo.appliedRecord.shiftName);
                                              console.log('휴일근무 승인완료 후 실적 유지:', updatedWorkInfo.appliedRecord.shiftName);
                                          }
                                          if (updatedWorkInfo.expectedHours) {
                                              const baseCacheKey = `${empCode}_${workDate}`;
                                              const workTypeCacheKey = `${empCode}_${workDate}_휴일근무`;

                                              expectedHoursCache.set(baseCacheKey, updatedWorkInfo.expectedHours);
                                              workTypeSpecificCache.set(workTypeCacheKey, updatedWorkInfo.expectedHours);
                                              holidayWorkStatusCache.set(holidayCacheKey, updatedWorkInfo.expectedHours);

                                              row.find('.expected-hours').text(updatedWorkInfo.expectedHours);
                                              console.log('휴일근무 승인완료 후 예상근로시간 캐시 갱신:', updatedWorkInfo.expectedHours);
                                          }
                                      });
                                  }, 500);
                              }
                          }
                      } else {
                          alert('상신 실패: ' + response);
                      }
                  },
                  error: function() {
                      alert('상신에 실패했습니다.');
                  }
              });
          });
      }

      // 기타근태 상신
      function submitEtcApply() {
          const selectedRows = $('#etcEmployeeTable .emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              alert('상신할 사원을 선택해주세요.');
              return;
          }

          const absentRows = selectedRows.filter(function() {
              return $(this).data('is-absent') === true;
          });

          if (absentRows.length > 0) {
              alert('결근 사원은 근태 신청을 할 수 없습니다.');
              return;
          }

          selectedRows.each(function() {
              const row = $(this);
              const applyNo = row.data('apply-no');

              if (!applyNo) {
                  alert('상신할 신청이 없습니다.');
                  return;
              }

              $.ajax({
                  url: '/user/apply/submit/etc',
                  method: 'POST',
                  data: {
                      applyEtcNo: applyNo,
                      isHeader: currentUser.isHeader
                  },
                  success: function(response) {
                      if (response === 'success') {
                          const finalStatus = currentUser.isHeader === 'Y' ? '승인완료' : '상신';
                          row.find('.status-field').text(finalStatus);

                          if (finalStatus === '승인완료') {
                              const shiftCode = row.find('.shift-select').val();
                              const selectedShift = shiftMasters.find(shift => shift.shiftCode === shiftCode);
                              if (selectedShift && (selectedShift.shiftName.includes('연차') || selectedShift.shiftName.includes('반차'))) {
                                  const startDate = row.find('.start-date').val().replace(/-/g, '');
                                  const endDate = row.find('.end-date').val().replace(/-/g, '');
                                  let requestDays = calculateRequestDays(startDate, endDate);

                                  if (selectedShift.shiftName.includes('반차')) {
                                      requestDays = 0.5;
                                  }

                                  const currentBalance = parseFloat(row.find('.annual-balance').text());

                                  // 정확한 소수점 계산 (16.5 고정값 방지)
                                  const newBalance = Math.round((currentBalance - requestDays) * 10) / 10;

                                  row.find('.annual-balance').text(newBalance.toFixed(1));

                                  console.log('연차 정확한 소수점 차감 계산:', {
                                      기존잔여: currentBalance.toFixed(1),
                                      차감일수: requestDays,
                                      차감후잔여: newBalance.toFixed(1)
                                  });
                              }
                          }

                          alert(currentUser.isHeader === 'Y' ? '자동 승인완료되었습니다.' : '상신되었습니다.');
                          updateButtonStates();
                      } else {
                          alert('상신 실패: ' + response);
                      }
                  },
                  error: function() {
                      alert('상신에 실패했습니다.');
                  }
              });
          });
      }

      // 일반근태 상신취소
      function cancelGeneralApply() {
          const selectedRows = $('#generalEmployeeTable .emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              alert('상신취소할 사원을 선택해주세요.');
              return;
          }

          selectedRows.each(function() {
              const row = $(this);
              const applyNo = row.data('apply-no');

              if (!applyNo) {
                  alert('상신취소할 신청이 없습니다.');
                  return;
              }

              $.ajax({
                  url: '/user/apply/cancel/general',
                  method: 'POST',
                  data: { applyGeneralNo: applyNo },
                  success: function(response) {
                      if (response === 'success') {
                          row.find('.status-field').text('저장');
                          alert('상신취소되었습니다.');
                          updateButtonStates();
                      } else {
                          alert('상신취소 실패: ' + response);
                      }
                  },
                  error: function() {
                      alert('상신취소에 실패했습니다.');
                  }
              });
          });
      }

      // 기타근태 상신취소
      function cancelEtcApply() {
          const selectedRows = $('#etcEmployeeTable .emp-checkbox:checked').closest('tr');

          if (selectedRows.length === 0) {
              alert('상신취소할 사원을 선택해주세요.');
              return;
          }

          selectedRows.each(function() {
              const row = $(this);
              const applyNo = row.data('apply-no');

              if (!applyNo) {
                  alert('상신취소할 신청이 없습니다.');
                  return;
              }

              $.ajax({
                  url: '/user/apply/cancel/etc',
                  method: 'POST',
                  data: { applyEtcNo: applyNo },
                  success: function(response) {
                      if (response === 'success') {
                          row.find('.status-field').text('저장');
                          alert('상신취소되었습니다.');
                          updateButtonStates();
                      } else {
                          alert('상신취소 실패: ' + response);
                      }
                  },
                  error: function() {
                      alert('상신취소에 실패했습니다.');
                  }
              });
          });
      }

      // 전체선택 기능
      $(document).on('change', '#selectAllGeneral', function() {
          const isChecked = $(this).is(':checked');
          $('#generalEmployeeTable .emp-checkbox').prop('checked', isChecked);
          updateButtonStates();
      });

      $(document).on('change', '#selectAllEtc', function() {
          const isChecked = $(this).is(':checked');
          $('#etcEmployeeTable .emp-checkbox').prop('checked', isChecked);
          updateButtonStates();
      });

      // 개별 체크박스 변경 시 전체선택 상태 업데이트
      $(document).on('change', '#generalEmployeeTable .emp-checkbox', function() {
          const totalCheckboxes = $('#generalEmployeeTable .emp-checkbox').length;
          const checkedCheckboxes = $('#generalEmployeeTable .emp-checkbox:checked').length;

          if (totalCheckboxes === checkedCheckboxes) {
              $('#selectAllGeneral').prop('checked', true);
          } else {
              $('#selectAllGeneral').prop('checked', false);
          }
          updateButtonStates();
      });

      $(document).on('change', '#etcEmployeeTable .emp-checkbox', function() {
          const totalCheckboxes = $('#etcEmployeeTable .emp-checkbox').length;
          const checkedCheckboxes = $('#etcEmployeeTable .emp-checkbox:checked').length;

          if (totalCheckboxes === checkedCheckboxes) {
              $('#selectAllEtc').prop('checked', true);
          } else {
              $('#selectAllEtc').prop('checked', false);
          }
          updateButtonStates();
      });

      // 날짜 변경 시 자동 조회
      $('#generalWorkDate').change(function() {
          expectedHoursCache.clear();
          workTypeSpecificCache.clear();
          holidayWorkStatusCache.clear();
          setTimeout(function() {
              searchGeneralEmployees();
          }, 100);
      });

      $('#etcWorkDate').change(function() {
          setTimeout(function() {
              searchEtcEmployees();
          }, 100);
      });

      $('#generalDeptSelect').change(function() {
          expectedHoursCache.clear();
          workTypeSpecificCache.clear();
          holidayWorkStatusCache.clear();
          setTimeout(function() {
              searchGeneralEmployees();
          }, 100);
      });

      $('#etcDeptSelect').change(function() {
          setTimeout(function() {
              searchEtcEmployees();
          }, 100);
      });

      // 근무계획 변경 시 자동 조회 (기타근태)
      $('#etcWorkPlan').change(function() {
          setTimeout(function() {
              searchEtcEmployees();
          }, 100);
      });

      // 페이지 로드 완료 후 초기화
      console.log('apply.html 스크립트 로드 완료 - 모든 기능 활성화');

      if (!$('#generalEmployeeTable thead th:first-child input[type="checkbox"]').length) {
          $('#generalEmployeeTable thead th:first-child').html('<input type="checkbox" id="selectAllGeneral"> 선택');
      }

      if (!$('#etcEmployeeTable thead th:first-child input[type="checkbox"]').length) {
          $('#etcEmployeeTable thead th:first-child').html('<input type="checkbox" id="selectAllEtc"> 선택');
      }
  });
</script>

<script>
  // URL에서 특정 쿼리 파라미터 값을 읽는 함수 (한 줄 버전)
  const getQueryParam = param => new URLSearchParams(window.location.search).get(param);

  function selectOptionByValue(selectId, value) {
    const select = document.getElementById(selectId);
    if (!select) return;
    const option = Array.from(select.options).find(opt => opt.value === value);
    if (option) option.selected = true;
  }

  document.addEventListener("DOMContentLoaded", () => {
    const deptCode = getQueryParam("deptCode");
    if (!deptCode) return;

    ["generalDeptSelect", "etcDeptSelect"].forEach(id => selectOptionByValue(id, deptCode));
  });
</script>

</body>
</html>